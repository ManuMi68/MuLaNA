---
title: "Statistics for Differentia effect of sleep deprivation on place cell representations, sleep architecture, and memory in young and old mice"
author: "Manuel Miguel Ramos √Ålvarez"
date: "20/02/2021"
output:
  html_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_float: yes
    toc_collapsed: yes
    code_folding: show
    includes:
    in_header: header.html
    theme: cosmo
    highlight: haddock
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
  word_document:
    toc: yes
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::knit_hooks$set(optipng = knitr::hook_optipng)
knitr::opts_chunk$set(echo = TRUE,class.source = "watch-out",class.output="#F8F8F8",comment = NA,warning = FALSE, message = FALSE,optipng='-o7', fig.show='hold',results='hold',fig.keep=2)
```

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = 'right',color='red')
```

```{css, echo=FALSE}
.watch-out {
  background-color: #FFECEE;
  border: 1px solid gray;
}
```

```{css, echo=FALSE}
.main-container {
    max-height: 800px !important;
}

pre {
  max-height: 800px !important;
  overflow-y: auto !important;
  overflow-x: scroll !important;
}
pre code {
  white-space: pre
}
```

```{css, echo=FALSE}
.scroll-2000 {
  max-height: 2000px;
  overflow-y: auto;
  background-color: inherit;
}
```

# Configurations
```{r Config, warning=FALSE, message=FALSE}

#install.packages(c("rtf"), repos = "http://cran.r-project.org")
library(rtf)
#install.packages("parallel")
library(parallel)
#install.packages("data.table")
library(data.table)
#install.packages("ggplot2")
library(ggplot2)
#install.packages("ggpubr")
#devtools::install_github("kassambara/ggpubr")
library(ggpubr)
library(dplyr)
#install.packages("ARTool")
#install.packages("lubridate")
#install.packages("kableExtra")
#install.packages("caret")
library(ARTool)
library(lubridate)
library(kableExtra)
library(caret)
#install.packages("hrbrthemes")
library(hrbrthemes)
#install.packages("modeest")
library(modeest)

# Robust Analysis
#install.packages("WRS2")
library(WRS2)
source("Rallfun-v37.txt");

PathDesign="Design_Sleep3/"
ColPer<-c("cyan3","blue","red", "magenta2");
LabX<-c("YC","YSD","OC","OSD")

SEM_MM<-function(x) sem=sd(x,na.rm = T)/sqrt(length(x))
Mean_MM<-function(x) mean=mean(x,na.rm = T)
Mean_MMtr<-function(x) mean=mean(x,na.rm = T,trim = 0.2)
tmmm<-function(x) tmean(na.omit(x))

bbwtrimbt_vMM<-function(J, K, L, x, tr = 0.2, JKL = J * K*L, con = 0,
 alpha = 0.05, grp =c(1:JKL), nboot = 599, SEED = TRUE, ...)
{
        #
        # Bootstrap-t for omniubs tests associated with
        # all main effects and interactions
        # for a between-by-between-within design.
        #
        #  The R variable x is assumed to contain the raw
        #  data stored in list mode or in a matrix.
        #  If in list mode, x[[1]] contains the data
        #  for the first level for all three factors: levels 1,1,1.
        #  x[[2]] is assumed to contain the data for level 1 of the
        #  first factor and second factor and level 2 of the third: level 1,1,2
        #  x[[K]] is the data for level 1,1,L
        #  x[[L+1]] is the data for level 1,2,1, x[[2K]] is level 1,2,2, etc.
        #
        #  If the data are in a matrix, column 1 is assumed to
        #  correspond to x[[1]], column 2 to x[[2]], etc.
        #
        #  When in list mode x is assumed to have length JK, the total number
        #  groups being tested, but a subset of the data can be analyzed
        #  using grp
        #
  require(parallel)
if(is.data.frame(x))data=as.matrix(x)
        if(is.matrix(x)) {
                y <- list()
                for(j in 1:ncol(x)) y[[j]] <- x[, j]
                x <- y
}

#        conM = con3way(J,K,L)
 p <- J*K*L
if(p>length(x))stop("JKL is less than the Number of groups")
JK=J*K
        v <- matrix(0, p, p)
        data <- list()
xx=list()
        for(j in 1:length(x)) {
                data[[j]] <- x[[grp[j]]]
xx[[j]]=x[[grp[j]]] # save input data
                # Now have the groups in proper order.
                data[[j]] = data[[j]] - mean(data[[j]], tr = tr)
        }
#ilow=0-L
#iup=0
#for(j in 1:JK){
#ilow <- ilow + L
# iup = iup + L
#sel <- c(ilow:iup)
#xx[sel]=listm(elimna(matl(xx[sel])))
# v[sel, sel] <- covmtrim(xx[sel], tr)
#                }
test.stat=bbwtrim(J,K,L,xx,tr=tr)
        x <- data  # Centered data
#        jp <- 1 - K
#        kv <- 0
        if(SEED)
                set.seed(2)
        # set seed of random number generator so that
        #             results can be duplicated.
        testA = NA
        testB = NA
        testC=NA
        testAB = NA
        testAC = NA
        testBC = NA
        testABC = NA
        bsam = list()
        bdat = list()
aboot=NA
bboot=NA
cboot=NA
abboot=NA
acboot=NA
bcboot=NA
abcboot=NA
nvec=NA
       Res<-lapply(1:JK, function(j)
 {
          nvec[j] = length(x[[j]])
          mclapply (1:nboot, function(ib) {
                ilow <- 1 - L; iup = 0
                bsam= unlist(lapply(1:JK, function (j){
                  ilow <- ilow + L; iup = iup + L;nv=length(x[[ilow]])
                  bdat[[j]] = sample(nv, size = nv, replace =TRUE)
                  lapply (ilow:iup, function(k) x[[k]][sample(nv, size = nv, replace =TRUE)])
                }),recursive = F)
          temp=bbwtrim(J,K,L,bsam,tr=tr)
          with(temp, c(Qa,Qb,Qc,Qab,Qac,Qbc,Qabc))
          },
          mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  })

Res2<-as.data.table(unlist(Res, recursive = F))
pbA=NA
pbB=NA
pbC=NA
pbAB=NA
pbAC=NA
pbBC=NA
pbABC=NA
pbA=mean(test.stat$Qa[1,1]<Res2[1,])
pbB=mean(test.stat$Qb[1,1]<Res2[2,])
pbC=mean(test.stat$Qc[1,1]<Res2[3,])
pbAB=mean(test.stat$Qab[1,1]<Res2[3,])
pbAC=mean(test.stat$Qac[1,1]<Res2[3,])
pbBC=mean(test.stat$Qbc[1,1]<Res2[3,])
pbABC=mean(test.stat$Qabc[1,1]<Res2[3,])
list(p.value.A=pbA,p.value.B=pbB,p.value.C=pbC,p.value.AB=pbAB,
p.value.AC=pbAC,p.value.BC=pbBC,p.value.ABC=pbABC)
}

t2waybt_vMM<-function(J,K,x,tr=.2,grp=c(1:p),p=J*K,nboot=599,SEED=TRUE){
#
#   Two-way ANOVA based on trimmed means and a bootstrap-t method
#
#   The data are assumed to be stored as described in the function t2way
#
#   The default number of bootstrap samples is nboot=599
#
require(parallel)
if(is.data.frame(x))x=as.matrix(x)
if(is.matrix(x))x<-listm(x)
if(!is.list(x))stop("Data must be stored in a matrix or in list mode.")
if(SEED)set.seed(2) # set seed of random number generator so that
#             results can be duplicated.
# compute test statistics:
tests=t2way(J=J,K=K,x,tr=tr,grp=grp)
TA=NULL
TB=NULL
TAB=NULL
data=list()
xcen=list()
for(j in 1:length(x))xcen[[j]]<-x[[j]]-mean(x[[j]],tr)
print("Taking bootstrap samples. Please wait.")
Res<-mclapply (1:nboot, function(ib) {
  data<-lapply(1:length(x), function(j) sample(xcen[[j]],size=length(x[[j]]),replace=TRUE))
  bt=t2way(J,K,data,tr=tr,grp=grp)
  with(bt, c(Qa,Qb,Qab))
},mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
Res2<-data.table(t(as.data.table(Res)))
pA<-sum(tests$Qa<=Res2$V1)/nboot
pB<-sum(tests$Qb<=Res2$V2)/nboot
pAB<-sum(tests$Qab<=Res2$V3)/nboot
list(A.p.value=pA,B.p.value=pB,AB.p.value=pAB)
}

ExtrSig<-function(DTPas,decim=4) {
    require(data.table)
    DTpp<-copy(DTPas)
    Mx<-as.matrix(round(unlist(DTpp),decim))
    ResP<-data.table(Eff=rownames(Mx),p=Mx);
    ResP[,p.Sig:=""]
    ResP[p.V1<.05,p.Sig:="*    "]
    return(as.data.table(ResP))
   }

ExData.2<-function(nmF,Vars) {
    # For Factorial Bw 2x2
	  require(data.table)
    DatDTRes<-list()
  	DatDTFullp <- data.table(read.table(nmF, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  	DatDTp<-DatDTFullp[,Vars,with=F]
  	LaVd<-length(DatDTp)
  	if (sum(grep("Mouse",names(DatDTp)))>0) {setnames(DatDTp, "Mouse", "Subject"); DatDTp$Subject<-factor(DatDTp$Subject)}
  	DatDTp$Age<-factor(DatDTp$Age);DatDTp$Age<-relevel(DatDTp$Age,"Young")
  	DatDTp$Sleep<-factor(DatDTp$Sleep);levels(DatDTp$Sleep) <- list("Control"="control", "SR"="restriction")
	  setkey(DatDTp,Age,Sleep)
  	ArP<-unlist(lapply(1:2, function (x) lapply(1:2, function(y) DatDTp[.(levels(DatDTp$Age)[x],levels(DatDTp$Sleep)[y]),LaVd,with=F][[1]])),recursive = F)
  	DatDTRes$DT<-copy(DatDTp)
  	DatDTRes$Arp<-ArP
  	DatDTRes
}

ExData.2b<-function(nmF,Vars,TypCel) {
    # For Factorial Bw 2x2 & TypeCell
	  require(data.table)
    DatDTRes<-list()
  	DatDTFullp <- data.table(read.table(nmF, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  	setkey(DatDTFullp,Type)
  	DatDTFullp<-DatDTFullp[TypCel]
  	DatDTp<-DatDTFullp[,Vars,with=F]
  	LaVd<-length(DatDTp)
  	if (sum(grep("Mouse",names(DatDTp)))>0) {setnames(DatDTp, "Mouse", "Subject"); DatDTp$Subject<-factor(DatDTp$Subject)}
  	DatDTp$Age<-factor(DatDTp$Age);DatDTp$Age<-relevel(DatDTp$Age,"Young")
  	DatDTp$Sleep<-factor(DatDTp$Sleep);levels(DatDTp$Sleep) <- list("Control"="control", "SR"="restriction")
	  setkey(DatDTp,Age,Sleep)
  	ArP<-unlist(lapply(1:2, function (x) lapply(1:2, function(y) DatDTp[.(levels(DatDTp$Age)[x],levels(DatDTp$Sleep)[y]),LaVd,with=F][[1]])),recursive = F)
  	DatDTRes$DT<-copy(DatDTp)
  	DatDTRes$Arp<-ArP
  	DatDTRes
}

ExDataIS.2<-function(nmF,Vars,vIntP=0,lvlCh) {
    # For trifactorial Mx {Design 2*2*(4*S)} or {Design 2*2*(5*S)}
	  require(data.table)
    DatDTRes<-list()
  	DatDTFullp <- data.table(read.table(nmF, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  	DatDTp<-DatDTFullp[,Vars,with=F]
  	LaVd<-length(DatDTp)
  	if (sum(grep("Mouse",names(DatDTp)))>0) setnames(DatDTp, "Mouse", "Subject")
  	if ("fullname" %in% names(DatDTp)) setnames(DatDTp, "fullname", "Subject")
  	DatDTp$Age<-factor(DatDTp$Age);DatDTp$Age<-relevel(DatDTp$Age,"Young")
  	DatDTp$Sleep<-factor(DatDTp$Sleep);levels(DatDTp$Sleep) <- list("Control"="control", "SR"="restriction")
  	DatDTp$Subject<-factor(DatDTp$Subject)
	  setkey(DatDTp,Age,Sleep)
  	
  	
        NmIntra=names(DatDTp[,vIntP,with=F])
        ExtendDTp<-reshape(DatDTp,direction = "long",varying = list(vIntP),idvar = "Subject",timevar=c("Moment"),times=NmIntra)
        LaVd2<-length(ExtendDTp)	
        colnames(ExtendDTp)[LaVd2] <- "DepVar"
        ExtendDTp$Moment<-factor(ExtendDTp$Moment)
        levels(ExtendDTp$Moment) <-(lvlCh)
        ExtendDTp$Age<-factor(ExtendDTp$Age);ExtendDTp$Age<-relevel(ExtendDTp$Age,"Young")
        ExtendDTp$Sleep<-factor(ExtendDTp$Sleep);ExtendDTp$Sleep<-relevel(ExtendDTp$Sleep,"Control")
        ExtendDTp$Inter<-interaction(ExtendDTp$Age,ExtendDTp$Sleep)
        ExtendDTp$Inter<-factor( ExtendDTp$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
    
        ArPp<-unlist(unlist(lapply(1:2, function (x) lapply(1:2, function(y) lapply(vIntP, function(z) na.omit(DatDTp[.(levels(DatDTp$Age)[x],levels(DatDTp$Sleep)[y]),z,with=F][[1]])))),recursive = F),recursive = F)
        DatDTRes$DT<-copy(DatDTp)
  	    DatDTRes$Arp<-copy(ArPp)
        DatDTRes$ExtendDT<-copy(ExtendDTp)
	  DatDTRes
}

ExDataIS.2b<-function(nmF,Vars,vIntP=0,lvlCh) {
    # For trifactorial Mx {Design 2*2*(4*S)} of Global Remap All Cells
	  require(data.table)
    DatDTRes<-list()
  	DatDTFullp <- data.table(read.table(nmF, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  	DatDTFullp[,Subject:=interaction(Mouse,Cell)]
  	DatDTp<-DatDTFullp[,Vars,with=F]
  	LaVd<-length(DatDTp)
  	if (sum(grep("Mouse",names(DatDTp)))>0) setnames(DatDTp, "Mouse", "Subject")
  	DatDTp$Age<-factor(DatDTp$Age);DatDTp$Age<-relevel(DatDTp$Age,"Young")
  	DatDTp$Sleep<-factor(DatDTp$Sleep);levels(DatDTp$Sleep) <- list("Control"="control", "SR"="restriction")
  	DatDTp$Subject<-factor(DatDTp$Subject)
	  setkey(DatDTp,Age,Sleep)
  	
  	
        NmIntra=names(DatDTp[,vIntP,with=F])
        ExtendDTp<-reshape(DatDTp,direction = "long",varying = list(vIntP),idvar = "Subject",timevar=c("Moment"),times=NmIntra)
        LaVd2<-length(ExtendDTp)	
        colnames(ExtendDTp)[LaVd2] <- "DepVar"
        ExtendDTp$Moment<-factor(ExtendDTp$Moment)
        levels(ExtendDTp$Moment) <-(lvlCh)
        ExtendDTp$Age<-factor(ExtendDTp$Age);ExtendDTp$Age<-relevel(ExtendDTp$Age,"Young")
        ExtendDTp$Sleep<-factor(ExtendDTp$Sleep);ExtendDTp$Sleep<-relevel(ExtendDTp$Sleep,"Control")
        ExtendDTp$Inter<-interaction(ExtendDTp$Age,ExtendDTp$Sleep)
        ExtendDTp$Inter<-factor( ExtendDTp$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
    
        ArPp<-unlist(unlist(lapply(1:2, function (x) lapply(1:2, function(y) lapply(vIntP, function(z) na.omit(DatDTp[.(levels(DatDTp$Age)[x],levels(DatDTp$Sleep)[y]),z,with=F][[1]])))),recursive = F),recursive = F)
        DatDTRes$DT<-copy(DatDTp)
  	    DatDTRes$Arp<-copy(ArPp)
        DatDTRes$ExtendDT<-copy(ExtendDTp)
	  DatDTRes
}

ExDataIS.3<-function(nmF,Vars,vIntP=0,lvlCh,TypCel) {
    # For trifactorial Mx {Design 2*2*(4*S)} of Global Remap Context Object or Unstable Cells
	require(data.table)
    DatDTRes<-list()
  	DatDTFullp <- data.table(read.table(nmF, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  	if (!("fullname" %in% names(DatDTFullp))) {DatDTFullp[,Subject:=interaction(Mouse,Cell)]
  	  }
  	if ("fullname" %in% names(DatDTFullp)) setnames(DatDTFullp, "fullname", "Subject")
  	setkey(DatDTFullp,Type)
  	DatDTFullp<-DatDTFullp[TypCel]
  	DatDTp<-DatDTFullp[,Vars,with=F]
  	LaVd<-length(DatDTp)
  	if (sum(grep("Mouse",names(DatDTp)))>0) setnames(DatDTp, "Mouse", "Subject")
  	
  	DatDTp$Age<-factor(DatDTp$Age);DatDTp$Age<-relevel(DatDTp$Age,"Young")
  	DatDTp$Sleep<-factor(DatDTp$Sleep);levels(DatDTp$Sleep) <- list("Control"="control", "SR"="restriction")
  	DatDTp$Subject<-factor(DatDTp$Subject)
	  setkey(DatDTp,Age,Sleep)
  	
  	
        NmIntra=names(DatDTp[,vIntP,with=F])
        ExtendDTp<-reshape(DatDTp,direction = "long",varying = list(vIntP),idvar = "Subject",timevar=c("Moment"),times=NmIntra)
        LaVd2<-length(ExtendDTp)	
        colnames(ExtendDTp)[LaVd2] <- "DepVar"
        ExtendDTp$Moment<-factor(ExtendDTp$Moment)
        levels(ExtendDTp$Moment) <-(lvlCh)
        ExtendDTp$Age<-factor(ExtendDTp$Age);ExtendDTp$Age<-relevel(ExtendDTp$Age,"Young")
        ExtendDTp$Sleep<-factor(ExtendDTp$Sleep);ExtendDTp$Sleep<-relevel(ExtendDTp$Sleep,"Control")
        ExtendDTp$Inter<-interaction(ExtendDTp$Age,ExtendDTp$Sleep)
        ExtendDTp$Inter<-factor( ExtendDTp$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
    
        ArPp<-unlist(unlist(lapply(1:2, function (x) lapply(1:2, function(y) lapply(vIntP, function(z) na.omit(DatDTp[.(levels(DatDTp$Age)[x],levels(DatDTp$Sleep)[y]),z,with=F][[1]])))),recursive = F),recursive = F)
        DatDTRes$DT<-copy(DatDTp)
  	    DatDTRes$Arp<-copy(ArPp)
        DatDTRes$ExtendDT<-copy(ExtendDTp)
	  DatDTRes
}

ExDataIS.3b<-function(nmF,Vars,vIntP=0,lvlCh,TypCel) {
    # For bifactorial Mx {Design 2*(4*S)} of Global Remap Context Object or Unstable Cells
	require(data.table)
    DatDTRes<-list()
  	DatDTFullp <- data.table(read.table(nmF, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  	if (!("fullname" %in% names(DatDTFullp))) {DatDTFullp[,Subject:=interaction(Mouse,Cell)]
  	  }
  	if ("fullname" %in% names(DatDTFullp)) setnames(DatDTFullp, "fullname", "Subject")
  	DatDTFullp[,Subject:=interaction(Mouse,Cell)]
  	setkey(DatDTFullp,Type)
  	DatDTFullp<-DatDTFullp[TypCel]
  	DatDTp<-DatDTFullp[,Vars,with=F]
  	LaVd<-length(DatDTp)
  	#if (sum(grep("Mouse",names(DatDTp)))>0) setnames(DatDTp, "Mouse", "Subject")
  	#if ("fullname" %in% names(DatDTp)) setnames(DatDTp, "fullname", "Subject")
  	DatDTp$Age<-factor(DatDTp$Age);DatDTp$Age<-relevel(DatDTp$Age,"Young")
  	DatDTp$Sleep<-factor(DatDTp$Sleep);levels(DatDTp$Sleep) <- list("Control"="control", "SR"="restriction")
  	DatDTp$Subject<-factor(DatDTp$Subject)
	  setkey(DatDTp,Age,Sleep)
  	
  	
        NmIntra=names(DatDTp[,vIntP,with=F])
        ExtendDTp<-reshape(DatDTp,direction = "long",varying = list(vIntP),idvar = "Subject",timevar=c("Moment"),times=NmIntra)
        LaVd2<-length(ExtendDTp)	
        colnames(ExtendDTp)[LaVd2] <- "DepVar"
        ExtendDTp$Moment<-factor(ExtendDTp$Moment)
        levels(ExtendDTp$Moment) <-(lvlCh)
        ExtendDTp$Age<-factor(ExtendDTp$Age);ExtendDTp$Age<-relevel(ExtendDTp$Age,"Young")
        ExtendDTp$Sleep<-factor(ExtendDTp$Sleep);ExtendDTp$Sleep<-relevel(ExtendDTp$Sleep,"Control")
        ExtendDTp$Group<-interaction(ExtendDTp$Age,ExtendDTp$Sleep,sep = " ",drop = T)
        #ExtendDTp$Inter<-factor( ExtendDTp$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
    
        ArPp<-unlist(lapply(1:2, function (x) lapply(vIntP, function(z) na.omit(DatDTp[.(levels(DatDTp$Age)[x]),z,with=F][[1]]))),recursive = F)
        NmIntra2<-c("Group","Subject",NmIntra)
        DatDTp[,Group:=interaction(DatDTp$Age,DatDTp$Sleep,sep = " ",drop = T)]
        DatDTRes$DT<-copy(DatDTp[,..NmIntra2])
  	    DatDTRes$Arp<-copy(ArPp)
  	    NmIntra3<-c("Group","Subject","Moment","DepVar")
        DatDTRes$ExtendDT<-copy(ExtendDTp[,..NmIntra3])
	  DatDTRes

	  
}

ExDataIS.3c<-function(nmF,Vars,vIntP=0,lvlCh) {
    # For bifactorial Mx {Design 2*(4*S)}
	require(data.table)
    DatDTRes<-list()
  	DatDTFullp <- data.table(read.table(nmF, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  	if (!("fullname" %in% names(DatDTFullp))) {DatDTFullp[,Subject:=interaction(Mouse,Cell)]
  	  }
  	if ("fullname" %in% names(DatDTFullp)) setnames(DatDTFullp, "fullname", "Subject")
  	DatDTp<-DatDTFullp[,Vars,with=F]
  	LaVd<-length(DatDTp)
  	if (sum(grep("Mouse",names(DatDTp)))>0) setnames(DatDTp, "Mouse", "Subject")
  	DatDTp$Age<-factor(DatDTp$Age);DatDTp$Age<-relevel(DatDTp$Age,"Young")
  	DatDTp$Sleep<-factor(DatDTp$Sleep);levels(DatDTp$Sleep) <- list("Control"="control", "SR"="restriction")
  	DatDTp$Subject<-factor(DatDTp$Subject)
	  setkey(DatDTp,Age,Sleep)
  	
  	
        NmIntra=names(DatDTp[,vIntP,with=F])
        ExtendDTp<-reshape(DatDTp,direction = "long",varying = list(vIntP),idvar = "Subject",timevar=c("Moment"),times=NmIntra)
        LaVd2<-length(ExtendDTp)	
        colnames(ExtendDTp)[LaVd2] <- "DepVar"
        ExtendDTp$Moment<-factor(ExtendDTp$Moment)
        levels(ExtendDTp$Moment) <-(lvlCh)
        ExtendDTp$Age<-factor(ExtendDTp$Age);ExtendDTp$Age<-relevel(ExtendDTp$Age,"Young")
        ExtendDTp$Sleep<-factor(ExtendDTp$Sleep);ExtendDTp$Sleep<-relevel(ExtendDTp$Sleep,"Control")
        ExtendDTp$Group<-interaction(ExtendDTp$Age,ExtendDTp$Sleep,sep = " ",drop = T)
        #ExtendDTp$Inter<-factor( ExtendDTp$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
    
        ArPp<-unlist(lapply(1:2, function (x) lapply(vIntP, function(z) na.omit(DatDTp[.(levels(DatDTp$Age)[x]),z,with=F][[1]]))),recursive = F)
        NmIntra2<-c("Group","Subject",NmIntra)
        DatDTp[,Group:=interaction(DatDTp$Age,DatDTp$Sleep,sep = " ",drop = T)]
        DatDTRes$DT<-copy(DatDTp[,..NmIntra2])
  	    DatDTRes$Arp<-copy(ArPp)
  	    NmIntra3<-c("Group","Subject","Moment","DepVar")
        DatDTRes$ExtendDT<-copy(ExtendDTp[,..NmIntra3])
	  DatDTRes

	  
}

Grph.1<-function(DatP,Dvp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test"),ylmP,hLin=F,GrpSel=c(2,4)){
    # For on-way design
    require(ggplot2)
    ColPer2<-ColPer[GrpSel]
    LabX2<-LabX[GrpSel]
  	g1<-ggplot2::ggplot(data=DatP, aes(x=Group, y=get(Dvp)))
  gg1<-g1+ scale_fill_manual(values=ColPer2) +
	  geom_boxplot(colour=ColPer2, outlier.shape = NA,lwd=1) +
    theme_classic2() + theme(legend.position="bottom", text = element_text(size=28),
                             axis.text.x = element_text(colour = "black"),axis.text.y = element_text(colour = "black")) +
    labs(tag=LblsP[2],y=LblsP[3]) +
    stat_summary(fun=tmmm, geom="point", shape=18,
                 size=4, color=ColPer2) + scale_x_discrete(name="",labels=LabX2) + ylim(ylmP)
  if(hLin) gg1<-gg1+geom_hline(yintercept=0, linetype="dashed", color = "gray30")
  gg1
}

Grph.2<-function(DatP,Dvp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test"),ylmP,hLin=F){
  # For Factorial Design Bw 2*2 
  require(ggplot2)
  	g1<-ggplot2::ggplot(data=DatP, aes(x=Age:Sleep, y=get(Dvp)))
  gg1<-g1+ scale_fill_manual(values=ColPer) +
	  geom_boxplot(colour=ColPer, outlier.shape = NA,lwd=1) +
    theme_classic2() + theme(legend.position="bottom", text = element_text(size=28),
                             axis.text.x = element_text(colour = "black"),axis.text.y = element_text(colour = "black")) +
    labs(tag=LblsP[2],y=LblsP[3]) +
    stat_summary(fun=tmmm, geom="point", shape=18,
                 size=4, color=ColPer) + scale_x_discrete(name="",labels=LabX) + ylim(ylmP)
  if(hLin) gg1<-gg1+geom_hline(yintercept=0, linetype="dashed", color = "gray30")
  gg1
  
}

Grph.3<-function(DatP,Dvp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test"),ylmP,hLin=F,lvIp=4,wMain=F){
  # For trifactorial Mx {Design 2*2*(4*S)} or {Design 2*2*(5*S)}
  require(ggplot2)
    ColPerI<-rep(ColPer,lvIp)
  	g1<-ggplot2::ggplot(data=DatP, aes(x=Moment, y=DepVar,fill=factor(Age:Sleep)))
  	df3<-DatP[,.(DepVar=tmean(na.omit(DepVar))),by=c("Age","Sleep","Moment")]
  	gg1<-g1+ 
	  geom_boxplot(colour=ColPerI, outlier.shape = NA,lwd=1) +
    theme_classic2()+
    theme(legend.position="None", text = element_text(size=28),
          axis.text.x = element_text(colour = "black"),axis.text.y = element_text(colour = "black")) +
  	  labs(tag=LblsP[2],y=LblsP[3],x="") +
    scale_fill_manual(values=c(rep("white",4*lvIp)))+stat_summary(fun=tmmm, geom="point", shape=18,
                 size=4, color=ColPerI,position=position_dodge(width=.75)) + ylim(ylmP) 
  if(hLin) gg1<-gg1+geom_hline(yintercept=0, linetype="dashed", color = "gray30")
  	if(wMain) gg1<-gg1+stat_summary(fun=mean, geom="point", shape=13, size=8, color="black", fill="gray30") +
  	  stat_summary(fun=mean, geom="point", shape=13, size=7, color="black", fill="gray30")
  gg1
}

Grph.3.2Intra<-function(DatP,Dvp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test"),ylmP,hLin=F,lvIp=4,GrpSel=c(1,3),wMain=F){
  # For trifactorial Mx {Design 2*2*(4*S)} or {Design 2*2*(5*S)}
  require(ggplot2)
    ColPerI<-rep(ColPer[GrpSel],lvIp)
  	g1<-ggplot2::ggplot(data=DatP, aes(x=Moment, y=DepVar,fill=factor(Group)))
  	df3<-DatP[,.(DepVar=tmean(na.omit(DepVar))),by=c("Group","Moment")]
  	gg1<-g1+ 
	  geom_boxplot(colour=ColPerI, outlier.shape = NA,lwd=1) +
    theme_classic2()+
    theme(legend.position="None", text = element_text(size=28),
          axis.text.x = element_text(colour = "black"),axis.text.y = element_text(colour = "black")) +
  	  labs(tag=LblsP[2],y=LblsP[3],x="") +
    scale_fill_manual(values=c(rep("white",4*lvIp)))+stat_summary(fun=tmmm, geom="point", shape=18,
                 size=4, color=ColPerI,position=position_dodge(width=.75)) + ylim(ylmP) 
  if(hLin) gg1<-gg1+geom_hline(yintercept=0, linetype="dashed", color = "gray30")
  	if(wMain) gg1<-gg1+stat_summary(fun=mean, geom="point", shape=13, size=8, color="black", fill="gray30") +
  	  stat_summary(fun=mean, geom="point", shape=13, size=7, color="black", fill="gray30")
  gg1
}

Grph.3b<-function(DatP,Dvp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test"),ylmP,hLin=F,lvIp=4,GrpSel=c(2,4),wMain=F){
  # For bifactorial Mx {Design 2*(4*S)} or {Design 2*(5*S)}
  require(ggplot2)
    ColPerI<-rep(ColPer[GrpSel],lvIp)
  	g1<-ggplot2::ggplot(data=DatP, aes(x=Moment, y=DepVar,fill=factor(Group)))
  	df3<-DatP[,.(DepVar=tmean(na.omit(DepVar))),by=c("Group","Moment")]
  	gg1<-g1+ 
	  geom_boxplot(colour=ColPerI, outlier.shape = NA,lwd=1) +
    theme_classic2()+
    theme(legend.position="None", text = element_text(size=28),
          axis.text.x = element_text(colour = "black"),axis.text.y = element_text(colour = "black")) +
  	  labs(tag=LblsP[2],y=LblsP[3],x="") +
    scale_fill_manual(values=c(rep("white",4*lvIp)))+stat_summary(fun=tmmm, geom="point", shape=18,
                 size=4, color=ColPerI,position=position_dodge(width=.75)) + ylim(ylmP)
  if(hLin) gg1<-gg1+geom_hline(yintercept=0, linetype="dashed", color = "gray30")
  	if(wMain) gg1<-gg1+stat_summary(fun=mean, geom="point", shape=13, size=8, color="black", fill="gray30") +
  	  stat_summary(fun=mean, geom="point", shape=13, size=7, color="black", fill="gray30")
  gg1
}

Grph.3c<-function(DatP,Dvp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test"),ylmP,hLin=F,lvIp=4,wMain=F){
  # For trifactorial Bw {Design 2*2*2} for Implant, center on Implant
  require(ggplot2)
    ColPerI<-rep(ColPer[1:lvIp],4)
    #ColPerI<-c("aquamarine","mediumaquamarine","cyan3","deepskyblue","darkblue","blue","lightsalmon","maroon","red","pink","purple","magenta2")
  	g1<-ggplot2::ggplot(data=DatP, aes(x=Age:Sleep, y=DepVar,fill=factor(Implant)))
  	df3<-DatP[,.(DepVar=tmean(na.omit(DepVar))),by=c("Age","Sleep","Implant")]
  	gg1<-g1+ 
	  geom_boxplot(colour=ColPerI, outlier.shape = NA,lwd=1) +
    theme_classic2()+
    theme(legend.position="None", text = element_text(size=28),
          axis.text.x = element_text(colour = "black"),axis.text.y = element_text(colour = "black")) +
  	  labs(tag=LblsP[2],y=LblsP[3],x="") + scale_x_discrete(labels=c("YC", "YSR", "OC","OSR")) +
    scale_fill_manual(values=c(rep("white",4*lvIp)))+stat_summary(fun=tmmm, geom="point", shape=18,
                 size=4, color=ColPerI,position=position_dodge(width=.75)) + ylim(ylmP) 
  if(hLin) gg1<-gg1+geom_hline(yintercept=0, linetype="dashed", color = "gray30")
  	if(wMain) gg1<-gg1+stat_summary(fun=mean, geom="point", shape=13, size=8, color="black", fill="gray30") +
  	  stat_summary(fun=mean, geom="point", shape=13, size=7, color="black", fill="gray30")
  gg1
}

Grph.3d<-function(DatP,Dvp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test"),ylmP,hLin=F,lvIp=4,wMain=F){
  # For trifactorial Bw {Design 2*2*2} For Implant, center on Interaction
  require(ggplot2)
    ColPerI<-rep(ColPer,lvIp)
  	g1<-ggplot2::ggplot(data=DatP, aes(x=Implant, y=DepVar,fill=factor(Age:Sleep)))
  	df3<-DatP[,.(DepVar=tmean(na.omit(DepVar))),by=c("Age","Sleep","Implant")]
  	gg1<-g1+ 
	  geom_boxplot(colour=ColPerI, outlier.shape = NA,lwd=1) +
    theme_classic2()+
    theme(legend.position="None", text = element_text(size=28),
          axis.text.x = element_text(colour = "black"),axis.text.y = element_text(colour = "black")) +
  	  labs(tag=LblsP[2],y=LblsP[3],x="") +
    scale_fill_manual(values=c(rep("white",4*lvIp)))+stat_summary(fun=tmmm, geom="point", shape=18,
                 size=4, color=ColPerI,position=position_dodge(width=.75)) + ylim(ylmP) 
  if(hLin) gg1<-gg1+geom_hline(yintercept=0, linetype="dashed", color = "gray30")
  	if(wMain) gg1<-gg1+stat_summary(fun=mean, geom="point", shape=13, size=8, color="black", fill="gray30") +
  	  stat_summary(fun=mean, geom="point", shape=13, size=7, color="black", fill="gray30")
  gg1
}

Grph.3.Otros<-function(ExtendDTp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test")) {
  df2<-ExtendDTp[,.(DepVar=Mean_MM(DepVar),sem=SEM_MM(DepVar)),by=c("Age", "Sleep","Moment")]
  g1<-ggplot2::ggplot(data=ExtendDTp, aes(x=Moment, y=DepVar, fill=factor(Age:Sleep)))
  g2<-ggplot2::ggplot(df2, aes(x=Moment, y=DepVar, fill=Age:Sleep)) 
  
  ggg<-list()  
  ggg$BP<-g1+
	  geom_boxplot() +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Age * Sleep:",
                         breaks=c("Young:Control","Young:SR","Old:Control", "Old:SR"),
                         labels=c("Young Control", "Young SR","Old Control", "Old SR")) +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue3","blue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])
    
  ggg$Bars<-g2+
    geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
    geom_errorbar(aes(ymin=DepVar-sem, ymax=DepVar+sem), width=.2,
                 position=position_dodge(.9)) +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Age * Sleep:",
                         breaks=c("Young:Control","Young:SR","Old:Control", "Old:SR"),
                         labels=c("Young Control", "Young SR","Old Control", "Old SR")) +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue3","blue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])

   # Marginals
  #AB
  df3<-ExtendDTp[,.(DepVar=Mean_MM(DepVar),sem=SEM_MM(DepVar)),by=c("Age", "Sleep")]  
  g3<-ggplot2::ggplot(df3, aes(x=Age, y=DepVar, fill=Sleep)) 
  
  ggg$MargAB<-g3+
    geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
    geom_errorbar(aes(ymin=DepVar-sem, ymax=DepVar+sem), width=.2,
                 position=position_dodge(.9)) +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Sleep:") +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue3","blue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])
  
  #AC
  df4<-ExtendDTp[,.(DepVar=Mean_MM(DepVar),sem=SEM_MM(DepVar)),by=c("Age", "Moment")]  
  g4<-ggplot2::ggplot(df4, aes(x=Moment, y=DepVar, fill=Age)) 
  
  ggg$MargAC<-g4+
    geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
    geom_errorbar(aes(ymin=DepVar-sem, ymax=DepVar+sem), width=.2,
                 position=position_dodge(.9)) +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Age:") +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue3","blue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])
  
  #BC
  df5<-ExtendDTp[,.(DepVar=Mean_MM(DepVar),sem=SEM_MM(DepVar)),by=c("Sleep", "Moment")]  
  g5<-ggplot2::ggplot(df5, aes(x=Moment, y=DepVar, fill=Sleep)) 
  
  ggg$MargBC<-g5+
    geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
    geom_errorbar(aes(ymin=DepVar-sem, ymax=DepVar+sem), width=.2,
                 position=position_dodge(.9)) +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Sleep:") +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue3","blue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])
  
  #C
  df2.b<-ExtendDTp[,.(DepVar=Mean_MM(DepVar),sem=SEM_MM(DepVar)),by=c("Moment")]
  g1.b<-ggplot2::ggplot(data=df2.b, aes(x=Moment, y=DepVar))
  ggg$MargC<-g1.b+
    geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
    geom_errorbar(aes(ymin=DepVar-sem, ymax=DepVar+sem), width=.2,
                 position=position_dodge(.9)) +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Group") +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])
  
  return(ggg)
}

Grph.3.Otrosb<-function(ExtendDTp,LblsP=c("Preference for Displaced Object", "B","Object Preference During Test")) {
  df2<-ExtendDTp[,.(DepVar=Mean_MM(DepVar),sem=SEM_MM(DepVar)),by=c("Age", "Moment")]
  g1<-ggplot2::ggplot(data=ExtendDTp, aes(x=Moment, y=DepVar, fill=factor(Age)))
  g2<-ggplot2::ggplot(df2, aes(x=Moment, y=DepVar, fill=Age)) 
  
  ggg<-list()  
  ggg$BP<-g1+
	  geom_boxplot() +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Age * Sleep:",
                         breaks=c("Young:Control","Young:SR","Old:Control", "Old:SR"),
                         labels=c("Young Control", "Young SR","Old Control", "Old SR")) +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue3","blue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])
    
  ggg$Bars<-g2+
    geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
    geom_errorbar(aes(ymin=DepVar-sem, ymax=DepVar+sem), width=.2,
                 position=position_dodge(.9)) +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Age * Sleep:",
                         breaks=c("Young:Control","Young:SR","Old:Control", "Old:SR"),
                         labels=c("Young Control", "Young SR","Old Control", "Old SR")) +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue3","blue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])

   # Marginals
  #AC
  df4<-ExtendDTp[,.(DepVar=Mean_MM(DepVar),sem=SEM_MM(DepVar)),by=c("Age","Moment")]  
  g4<-ggplot2::ggplot(df4, aes(x=Moment, y=DepVar, fill=Age)) 
  
  ggg$MargAC<-g4+
    geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
    geom_errorbar(aes(ymin=DepVar-sem, ymax=DepVar+sem), width=.2,
                 position=position_dodge(.9)) +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Age:") +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue3","blue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])
  
  
  #C
  df2.b<-ExtendDTp[,.(DepVar=Mean_MM(DepVar),sem=SEM_MM(DepVar)),by=c("Moment")]
  g1.b<-ggplot2::ggplot(data=df2.b, aes(x=Moment, y=DepVar))
  ggg$MargC<-g1.b+
    geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
    geom_errorbar(aes(ymin=DepVar-sem, ymax=DepVar+sem), width=.2,
                 position=position_dodge(.9)) +
    scale_fill_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3"),name="Age") +
    scale_colour_manual(values=c("gray30", "gray64", "dodgerblue","dodgerblue3")) +
    theme_classic2() + theme(legend.position="bottom") + labs(title = LblsP[1], tag=LblsP[2],y=LblsP[3])
  
  return(ggg)
}
  
NCPosH<-function(nLA,nLB){
      nL=nLA*nLB
      NCPosH<-matrix(NA,(nL*(nL-1))/2,8)
      NCombi<-matrix(NA,nL,2)
      cnt<-0
      for (i in (1:nLA)) for (j in (1:nLB)) NCombi[cnt<-cnt+1,1:2]<-c(i,j)
      cnt<-0
      for (i in (1:(nL-1))) for (j in ((i+1):(nL))) {
        NCPosH[cnt<-cnt+1,1:2]<-c(i,j)
        NCPosH[cnt,3:6]<-c(NCombi[i,],NCombi[j,])
        NCPosH[cnt,7:8]<-0
        if (NCPosH[cnt,3]==NCPosH[cnt,5]) NCPosH[cnt,7]<-1
        if (NCPosH[cnt,4]==NCPosH[cnt,6]) NCPosH[cnt,8]<-1
        }
      return(NCPosH)
    }
    
ContCAll<-function(A=1,B=1,C=2,Typ="Succ",CnSel=0) {
      require(data.table)
      conCRes<-matrix(0,nrow=A*B*C,ncol=1)
      if (Typ=="Succ") {
        conCRes<-matrix(0,nrow=A*B*C,ncol=C-1)
        for (j in 0:(A*B-1)) for (i in 1:(C-1)) conCRes[c(C*j+i,C*j+i+1),i]<-c(1,-1);
      }
      if (Typ=="Succ.EfS") {
        conCRes<-matrix(0,nrow=A*B*C,ncol=(C-1)*A*B)
        cnt<-0
        for (i in 1:(C-1)) for (j in 0:(A*B-1)) conCRes[c(C*j+i,C*j+i+1),cnt<-cnt+1]<-c(1,-1);
      }
      if (Typ=="Succ.AC") {
        conCRes<-matrix(0,nrow=A*B*C,ncol=(C-1)*A)
          cnt<-0
                for (i in 1:(C-1)) {
                  for (k in 0:(A-1)) {
                    cnt<-cnt+1
                    for (j in 0:(B-1)) {
                    conCRes[c((k*C*B)+(C*j+i),(k*C*B)+(C*j+i+1)),cnt]<-c(1,-1);
                  }
                }
              }
        
      }
      if (Typ=="Succ.BC") {
        conCRes<-matrix(0,nrow=A*B*C,ncol=(C-1)*B)
          cnt<-0
                for (i in 1:(C-1)) {
                  for (k in 0:(B-1)) {
                    cnt<-cnt+1
                    for (j in 0:(A-1)) {
                    conCRes[c((j*C*B)+(C*k+i),(j*C*B)+(C*k+i+1)),cnt]<-c(1,-1);
                  }
                }
              }
        
      }
      if (Typ=="PosHoc") {
        nContr=(C*(C-1))/2
        conCRes<-matrix(0,nrow=A*B*C,ncol=nContr)
        for (k in 0:(A*B-1)) {
          cont=0;
            for (i in (1:(C-1))) {
              for (j in ((i+1):(C))) {
              cont=cont+1
              conCRes[c(C*k+i,C*k+j),cont]=c(1,-1)
              }
            }
          }
      }
      if (Typ=="PosHoc.AB"|Typ=="Desgl.AB") {
        nCon<-A*B
        nContr=(nCon*(nCon-1))/2
        conCRes<-matrix(0,nrow=A*B*C,ncol=nContr)
        
          cont=0;
            for (i in (1:(nCon-1))) {
              for (j in ((i+1):(nCon))) {
                cont=cont+1
                for (k in 0:(C-1)) {
                conCRes[c(C*(i-1)+k+1,C*(j-1)+k+1),cont]=c(1,-1)
              }
            }
          }
      }
      if (Typ=="Desgl.AB") {
        aa<-data.frame(NCPosH(2,2))
        Selaa<-c(which(aa[7]==1),which(aa[8]==1))
        if (sum(CnSel)>0) Selaa<-c(Selaa, which(aa[1]==CnSel[1]&aa[2]==CnSel[2]))
        conCRes=conCRes[,c(Selaa)]
      }
      if (Typ=="AenC") {
        nContr=((A*(A-1))/2)*C
        conCRes<-matrix(0,nrow=A*B*C,ncol=nContr)
        #k=0;h=0
          for (l in 0:(B-1)) {
            cont=0;
            for (i in (1:(A-1))) { 
              for (j in ((i+1):(A))){ 
                
                for (k in 0:(C-1)) {
                  cont=cont+1
                  
                conCRes[c((C*B)*(i-1)+k+(l*C)+1,(C*B)*(j-1)+k+(l*C)+1),cont]=c(1,-1)
                }
              }
            }
          }
      }
      
      if (Typ=="BenC") {
        nContr=((B*(B-1))/2)*C
        conCRes<-matrix(0,nrow=A*B*C,ncol=nContr)
        #k=0;h=0
          for (l in 0:(A-1)) {
            cont=0;
            for (i in (1:(B-1))) { 
              for (j in ((i+1):(B))){
                for (k in 0:(C-1)) {
                  cont=cont+1
                  conCRes[c(C*(i-1)+k+(l*C*A)+1,C*(j-1)+k+(l*C*A)+1),cont]=c(1,-1)
                }
              }
            }
          }
        }
       # A=2;B=2;C=4
       if (Typ=="PosHoc.ABenC"|Typ=="Desgl.ABenC") {
        nCon<-A*B
        nContr=((nCon*(nCon-1))/2)*C
        conCRes<-matrix(0,nrow=A*B*C,ncol=nContr)
        
          cont=0;
           for (k in 0:(C-1)) {
            for (i in (1:(nCon-1))) {
              for (j in ((i+1):(nCon))) {
                cont=cont+1
                conCRes[c(C*(i-1)+k+1,C*(j-1)+k+1),cont]=c(1,-1)
              }
            }
            }
       }
      
       if (Typ=="Desgl.ABenC") {
        aa<-NCPosH(2,2)
        aaR <- data.table(aa[rep(seq_len(nrow(aa)), C),],V9=c(rep(c(1:C),each=nrow(aa))))
        #aaR<-aaR[order(-V7,-V8)]
        Res1<-lapply (1:C, function(x) c(
          which(aaR[,7]==1 & aaR[,9]==x),
          which(aaR[,8]==1 & aaR[,9]==x))
          )
        Selaa<-unlist(Res1)
        aaR[Selaa,]
        if (sum(CnSel)>0) Selaa<-c(Selaa, which(aa[1]==CnSel[1]&aa[2]==CnSel[2]))
        conCRes=conCRes[,c(Selaa)]
       }
      
       if (Typ=="PosHoc.CenB") {
        nContr=((C*(C-1))/2)
        conCRes<-matrix(0,nrow=A*B*C,ncol=nContr)
        #k=0;h=0;l=1
          for (l in 0:(B-1)) {
            cont=0;
            for (i in (1:(C-1))) { 
              for (j in ((i+1):(C))){
                  cont=cont+1
                  conCRes[c(C*l+i,C*l+j),cont]=c(1,-1)
              }
            }
          }
        }
      
      return(conCRes)
    }


  AOVSingle<-function(ArpP,Prc=2) {
 	# Robust AOV for 2-levels one-way design
 	# yuenv2, bdm
  	RestTestRob<-yuenv2(ArpP[[1]],ArpP[[2]])
	RestTestRk1<-bdm(ArpP)
    ResRoRes<-list()
	ResRoRes$t<-with (RestTestRob, paste0("Diff = ",round(dif,Prc),", V(",round(df,Prc),") = ",
	round(teststat,Prc),", Eff.Size = ",round(Effect.Size,Prc), ", p = ",round(p.value,4)))
    
    ResRoRes$tRk1<-with (RestTestRk1, paste0("Diff = ",round(RestTestRob$dif,Prc),", Fw(",
    round(nu1,Prc),",",round(nu2,Prc),") = ",round(F,Prc),", Eff.Size = ",
    round(RestTestRob$Effect.Size,Prc), ", p = ",round(p.value,4)))
    
    ResRoRes$t.2<- with (RestTestRob, as.data.table(cbind(round(dif,Prc), round(df,Prc),
     round(teststat,Prc), round(Effect.Size,Prc), round(p.value,4))))
     
	ResRoRes$tRk2<-with (RestTestRk1, as.data.table(cbind(
	round(RestTestRob$dif,Prc), round(nu1,Prc),
	round(nu2,Prc),round(F,Prc), round(RestTestRob$Effect.Size,Prc), 
	round(p.value,4))))
	
	names(ResRoRes$t.2)<-c("Diff","DF","FW", "Ef.Size", "p")
	names(ResRoRes$tRk2)<-c("Diff","DF1","DF2","Fw","Ef.Size", "p")
  
  	return(ResRoRes)
  	}
  
  AOVBwF<-function(A=2,B=2,DatPas,nBMM=10000,Prc=2) {
  # Omnibus design {2*2}
  # t2way & rimul, t2waybt, t2waybt_vMM, bdm2way, ESmainMCP, esImcp
  # ContAB2x2 vs ContAB2x2.Ext, lincon, yuen, t1waybt, 
	ExFin<-list()
  ResRo<-list()
  RsRb<-t2way(A,B,DatPas[[2]])

  ResRo$w<- c(RsRb$A.p.value, RsRb$B.p.value, RsRb$AB.p.value)
  ResRo$r<- rimul(A,B,DatPas[[2]],plotit = F)
  ResRo$BT<-c(t2waybt(A,B,DatPas[[2]]))
  APA.N1<-c(round(unlist(RsRb),4),round(unlist(ResRo$BT),4))
  rr<-ExtrSig(ResRo$BT)
  print(rr)
    
  ResRo$BT_MM<-c(t2waybt_vMM(A,B,DatPas[[2]],nboot = nBMM))
  ResRo$Rk1<- bdm2way(A,B,DatPas[[2]])
  rr2=ExtrSig(ResRo$BT_MM)
  print(rr2)
  
  # Approximation to estimate Effect Size  
  TamA=round(mean(ESmainMCP(A,B,DatPas[[2]])$Factor.A[,3]),Prc)
	TamB=round(mean(ESmainMCP(A,B,DatPas[[2]])$Factor.B[,3]),Prc)
	TamInt=round(mean(esImcp(A,B,DatPas[[2]])$Effect.Sizes),Prc)
    
  ExRsRbQ<-with(RsRb, round(c(Qa, Qb, Qab),Prc))
  ExRsRbp<-with(RsRb, round(c(A.p.value, B.p.value,AB.p.value),4))
  ExRsRb.QRMul<-copy(ExRsRbQ); ExRsRb.QRMul[3]<-round(ResRo$r$test[5],Prc);
  ExRsRb.pRMul<-copy(ExRsRbp); ExRsRb.pRMul[3]<-round(ResRo$r$test[8],Prc);
  ExRsRbF.Rk1<-with(ResRo$Rk1, round(c(A.F,B.F,AB.F),Prc));
  ExRsRbp.Rk1<-with(ResRo$Rk1, round(c(p.valueA, p.valueB, p.valueAB),4));
  ExFin$AOV<-data.table(ExRsRbQ,ExRsRbp,ExRsRb.QRMul, ExRsRb.pRMul, ExRsRbF.Rk1, ExRsRbp.Rk1, rr$p.V1,rr$p.Sig,rr2$p.V1,rr2$p.Sig)
  names(ExFin$AOV)<-c("Q","p","Q.RMul","p.RMul", "F.Rk1", "p.Rk1", "pBoot","Sig","pBootMas","SigMas")
  ExFin$AOV<-data.table(Names=c("Age","Sleep","Age*Sleep"),ExFin$AOV)
  ExFin$AOV[,EffSize:=c(TamA,TamB,TamInt)]
    
  #Interaction AB
  # A on each B & B on each A
  cnMM<-ContCAll(A=2,B=2,C=1,"Desgl.AB") #ContAB2x2 
  Contr.1<-lincon(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)

  # Approximation to estimate Effect Size 
  AExtrP<-c("test","p.value","Effect.Size")
  EffA<-parallel::mclapply(1:A, function(x) WRS2::yuen(DepV~Sleep,data=DatPas[[1]][Age==levels(Age)[x]])[6],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffB<-parallel::mclapply(1:B, function(x) WRS2::yuen(DepV~Age,data=DatPas[[1]][Sleep==levels(Sleep)[x]])[6], 
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffAb<-parallel::mclapply(1:A, function(x) WRS2::t1waybt(DepV~Sleep,data=DatPas[[1]][Age==levels(Age)[x]],nboot = 900)[AExtrP],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffBb<-parallel::mclapply(1:B, function(x) WRS2::t1waybt(DepV~Age,data=DatPas[[1]][Sleep==levels(Sleep)[x]],nboot = 900)[AExtrP],
                          mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  
  ConEntre.b2<-round(data.table(c(unlist(EffA),unlist(EffB))),Prc)
  ContrBooth1<-rbind(do.call(rbind, lapply(EffAb, as.data.table)),
do.call(rbind, lapply(EffBb, as.data.table)))
  ContrBooth<-round(ContrBooth1,Prc)
  ContrBooth$p.value<-round(ContrBooth1$p.value,4)
  
  names(ContrBooth)<-c("Test.Boot","p.Boot","EffSize.Boot")
  ConEntre.b3<-data.table(Contr=c("Sleep on Young", "Sleep on Old", "Age on Control", "Age on SR"),ConEntre.b1,EfSize=ConEntre.b2,ContrBooth)     
   ExFin$Detall<-ConEntre.b3
   
   #Extents Interaction AB
   	ConEntre.b3<-0
	  cnMM<-ContCAll(A=2,B=2,C=1,"Desgl.AB",CnSel<-c(2,3)) #ContAB2x2.Ext 
    Contr.1<-lincon(DatPas[[2]],con=cnMM)
    ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
    ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)
    
    # Approximation to estimate Effect Size
    DatSel<-DatPas[[1]][Sleep=="SR"&Age=="Young"|Sleep=="Control"&Age=="Old"]
    AExtrP<-c("test","p.value","Effect.Size")
  EffA<-parallel::mclapply(1:A, function(x) WRS2::yuen(DepV~Sleep,data=DatPas[[1]][Age==levels(Age)[x]])[6],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffB<-parallel::mclapply(1:B, function(x) WRS2::yuen(DepV~Age,data=DatPas[[1]][Sleep==levels(Sleep)[x]])[6], 
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffAb<-parallel::mclapply(1:A, function(x) WRS2::t1waybt(DepV~Sleep,data=DatPas[[1]][Age==levels(Age)[x]],nboot = 900)[AExtrP],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffBb<-parallel::mclapply(1:B, function(x) WRS2::t1waybt(DepV~Age,data=DatPas[[1]][Sleep==levels(Sleep)[x]],nboot = 900)[AExtrP],
                          mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffS5=WRS2::yuen(DepV~Age,data=DatSel)[6]
  EffS5b=WRS2::t1waybt(DepV~Age,data=DatSel,nboot = 900)[AExtrP]
  
  ConEntre.b2<-round(data.table(c(unlist(EffA),unlist(EffB),unlist(EffS5))),Prc)
  ContrBooth1<-rbind(do.call(rbind, lapply(EffAb, as.data.table)),
                     do.call(rbind, lapply(EffBb, as.data.table)),
                     as.data.table(EffS5b))
  ContrBooth<-round(ContrBooth1,Prc)
  ContrBooth$p.value<-round(ContrBooth1$p.value,4)
  names(ContrBooth)<-c("Test.Boot","p.Boot","EffSize.Boot")
    ConEntre.b3<-data.table(Contr=c("Sleep on Young", "Sleep on Old", "Age on Control", "Age on SR", "YSR vs OC"),ConEntre.b1,EfSize=ConEntre.b2,ContrBooth)
   	ExFin$DetallExt<-ConEntre.b3
   
   return(ExFin)
  }
  
  AOVMx<-function(A=2,B=2,C=4,DatPas,DatEfSp,nBMM1=10000,nBMM2=10000,Prc=2) {
  # Omnibus design {2*2*(4*S)}
  # bbwtrim, bbwtrimbt, bbwtrimbt_vMM  
  # ContC, rmmcp, rmmismcp, yuendv2
  # En Ef Simples de A*B en cada Momento, como AOVBwF
	ExFin<-list()
  ResRo<-list()
  
  # 1) ANOVA Omnibus
  RsRb<-bbwtrim(A,B,C,DatPas[[2]])
  ResRo$w<- round(c(RsRb$Qa.p.value, RsRb$Qb.p.value, RsRb$Qc.p.value, RsRb$Qab.p.value,RsRb$Qac.p.value,
                    RsRb$Qbc.p.value, RsRb$Qabc.p.value),4)
  ResRo$BT<-c(bbwtrimbt(A,B,C,DatPas[[2]]))
  APA.N1<-c(round(unlist(RsRb),4),round(unlist(ResRo$BT),4))
  rr<-ExtrSig(ResRo$BT)
  print(rr)
  
  ResRo$BT_MM<-c(bbwtrimbt_vMM(A,B,C,DatPas[[2]],nboot = nBMM1))
  ResRo$Rk1<- bdm2way(A,B,DatPas[[2]])
  rr2=ExtrSig(ResRo$BT_MM)
  print(rr2)
      
  ExRsRbQ<-with(RsRb, round(c(Qa, Qb,Qc, Qab, Qac, Qbc, Qabc),Prc))
  ExRsRbp<-with(RsRb, round(c(Qa.p.value, Qb.p.value,Qc.p.value, Qab.p.value, Qac.p.value, Qbc.p.value, Qabc.p.value),4))
  ExFin$AOV<-data.table(ExRsRbQ,ExRsRbp,rr$p.V1,rr$p.Sig,rr2$p.V1,rr2$p.Sig)
  names(ExFin$AOV)<-c("Q","p","pBoot","Sig","pBootMas","Sig2")
  ExFin$AOV<-data.table(Names=c("Age","Sleep","Time","Age*Sleep","Age*Time","Sleep*Time","Age*Sleep*Time"),ExFin$AOV)
   
    
  # 2) Main Effect of C (Time or Trial)
  cnMM<-ContCAll(A=2,B=2,C=4,"Succ") #ContC()
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  ContrFunde<-ContrFunde[,-2]
  ConEntre.b3Ap<-ContrFunde[,.(psihat,df=NA,test, p.value,Psihat2, p.value2)]
      
  # Approximation to estimate Effect Size
  EffS1=yuendv2(DatPas[[1]][,T1],DatPas[[1]][,T2])$Effect.Size
  EffS2=yuendv2(DatPas[[1]][,T2],DatPas[[1]][,T3])$Effect.Size
  EffS3=yuendv2(DatPas[[1]][,T3],DatPas[[1]][,T4])$Effect.Size
  ConEntre.b2<-round(data.table(unlist(rbind(EffS1,EffS2,EffS3))),Prc)
  ConEntre.b3<-data.table(Contr=c("M1-M2", "M2-M3", "M3-M4"),ContrFunde,EfSize=ConEntre.b2)
  ExFin$DetallMainC<-ConEntre.b3
  
  # 3) Learning (Time/Trial) on AB (each experimental condition)
  cnMM.Ap<-ContCAll(A=2,B=2,C=4,"Succ.EfS") #ContABC.Learn
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM.Ap)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM.Ap)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  
  TestContr2<-rbind(yuendv2(DatPas[[1]][.("Young","Control"),T1],
                              DatPas[[1]][.("Young","Control"),T2])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Young","SR"),T1],
                              DatPas[[1]][.("Young","SR"),T2])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Old","Control"),T1],
                              DatPas[[1]][.("Old","Control"),T2])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Old","SR"),T1],
                              DatPas[[1]][.("Old","SR"),T2])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Young","Control"),T2],
                              DatPas[[1]][.("Young","Control"),T3])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Young","SR"),T2],
                              DatPas[[1]][.("Young","SR"),T3])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Old","Control"),T2],
                              DatPas[[1]][.("Old","Control"),T3])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Old","SR"),T2],
                              DatPas[[1]][.("Old","SR"),T3])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Young","Control"),T3],
                              DatPas[[1]][.("Young","Control"),T4])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Young","SR"),T3],
                              DatPas[[1]][.("Young","SR"),T4])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Old","Control"),T3],
                              DatPas[[1]][.("Old","Control"),T4])
                      [c("dif","df","teststat","Effect.Size","p.value")],
                      yuendv2(DatPas[[1]][.("Old","SR"),T3],
                              DatPas[[1]][.("Old","SR"),T4])
                      [c("dif","df","teststat","Effect.Size","p.value")])
    
    ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Y_C", "M1-M2 on Y_SR", "M1-M2 on O_C", "M1-M2 on O_SR",
                                      "M2-M3 on Y_C", "M2-M3 on Y_SR", "M2-M3 on O_C", "M2-M3 on O_SR",
                                      "M3-M4 on Y_C", "M3-M4 on Y_SR", "M3-M4 on O_C", "M3-M4 on O_SR"),
                              ContrFunde)
    ConEntre.b3Ap<-ConEntre.b3Ap[,-3]
    ConEntre.b3Ap<-ConEntre.b3Ap[,.(Contr,psihat,df=NA,test, p.value,Psihat2, p.value2)]
    rrF<-data.table(ConEntre.b3Ap,dif.yuen=round(unlist(TestContr2[,1]),Prc),df.yuen=unlist(TestContr2[,2]),
                    test.yuen=round(unlist(TestContr2[,3]),Prc),EffSize.yuen=round(unlist(TestContr2[,4]),Prc),
                    pvaluet.yuen=round(unlist(TestContr2[,5]),4))
    ExFin$DetallTrialCadaCondAB<-rrF
    
    # 4) Simple Effect AxB on each Trial/Time
    ExFin$DetallSimple<-lapply(1:C, function (is) AOVBwF(2,2,DatPas = DatEfSp[[is]],nBMM2))  
    
    return(ExFin)
  }
  
  AOVMx2<-function(A=2,B=2,C=4,DatPas,DatEfSp,nBMM1=10000,nBMM2=10000,Prc=2) {
    require(parallel);require(data.table)
  # Omnibus design {2*2*(4*S)}
  # bbwtrim, bbwtrimbt, bbwtrimbt_vMM  
  # ContC, rmmcp, rmmismcp, yuendv2
  # En Ef Simples de A*B en cada Momento, como AOVBwF
	ExFin<-list()
  ResRo<-list()
  
  # 1) ANOVA Omnibus
  RsRb<-bbwtrim(A,B,C,DatPas[[2]])
  ResRo$w<- round(c(RsRb$Qa.p.value, RsRb$Qb.p.value, RsRb$Qc.p.value, RsRb$Qab.p.value,RsRb$Qac.p.value,
                    RsRb$Qbc.p.value, RsRb$Qabc.p.value),4)
  ResRo$BT<-c(bbwtrimbt(A,B,C,DatPas[[2]]))
  APA.N1<-c(round(unlist(RsRb),4),round(unlist(ResRo$BT),4))
  rr<-ExtrSig(ResRo$BT)
  print(rr)
  
  ResRo$BT_MM<-c(bbwtrimbt_vMM(A,B,C,DatPas[[2]],nboot = nBMM1))
  ResRo$Rk1<- bdm2way(A,B,DatPas[[2]])
  rr2=ExtrSig(ResRo$BT_MM)
  print(rr2)
      
  ExRsRbQ<-with(RsRb, round(c(Qa, Qb,Qc, Qab, Qac, Qbc, Qabc),Prc))
  ExRsRbp<-with(RsRb, round(c(Qa.p.value, Qb.p.value,Qc.p.value, Qab.p.value, Qac.p.value, Qbc.p.value, Qabc.p.value),4))
  ExFin$AOV<-data.table(ExRsRbQ,ExRsRbp,rr$p.V1,rr$p.Sig,rr2$p.V1,rr2$p.Sig)
  names(ExFin$AOV)<-c("Q","p","pBoot","Sig","pBootMas","Sig2")
  ExFin$AOV<-data.table(Names=c("Age","Sleep","Time","Age*Sleep","Age*Time","Sleep*Time","Age*Sleep*Time"),ExFin$AOV)
   
  # 2) Interaction AB
  # A on each B & B on each A
  cnMM<-ContCAll(A=2,B=2,C=4,"Desgl.AB") #ContAB 
  Contr.1<-lincon(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)
  
  # Approximation to estimate Effect Size
  DatPas[[1]][,NewIntra:=rowMeans(DatPas[[1]][,.(T1,T2,T3,T4)],na.rm = T)]
  
  EffA<-parallel::mclapply(1:A, function(x) WRS2::yuen(NewIntra~Sleep,data=DatPas[[1]][Age==levels(Age)[x]])[6],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffB<-parallel::mclapply(1:B, function(x) WRS2::yuen(NewIntra~Age,data=DatPas[[1]][Sleep==levels(Sleep)[x]])[6], 
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(c(unlist(EffA),unlist(EffB))),Prc)
  ConEntre.b3<-data.table(Contr=c("Sleep on Young", "Sleep on Old", "Age on Control",
                                    "Age on SR"),ConEntre.b1,EfSize=ConEntre.b2)
  ExFin$InterAB<-as.data.table(ConEntre.b3)
    
  # 3) Interaction AC
  # A on each Moment/Time/Trial of C
  cnMM<-ContCAll(A=2,B=2,C=4,"AenC")  #ContAC 
  Contr.1<-lincon(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)
    
  # Approximation to estimate Effect Size
  levIS<-paste0("T",1:C)
  EffS<-parallel::mclapply(1:C, function(x) WRS2::yuen(get(levIS[x])~Age,data=DatPas[[1]])[6],mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(unlist(EffS)),Prc)
  ConEntre.b3<-data.table(Contr=c("Age on M1", "Age on M2", "Age on M3", "Age on M4"),ConEntre.b1,EfSize=ConEntre.b2)
  
  # Learning on AC
  cnMM.Ap<-ContCAll(A=2,B=2,C=4,"Succ.AC") #ContAC.Learn 
  Contr.1Ap<-rmmcp(DatPas[[2]],con=cnMM.Ap)
  ConEntre.b1Ap<-round(as.data.table(cbind(Contr.1Ap$test,Contr.1Ap$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1Ap$p.value <-round(Contr.1Ap$test[,3],4)
    
  # Approximation to estimate Effect Size
  LosLv<-split(c(rep("T1",2),rep("T2",2),rep("T3",2),rep("T2",2),rep("T3",2),rep("T4",2)),1:6)
  LosLv2<-rep(levels(DatPas[[1]]$Age),3)
  EffSAp<- parallel::mclapply(1:6, function(x)   yuendv2(DatPas[[1]][Age==LosLv2[x],get(LosLv[[x]][1])],
                                               DatPas[[1]][Age==LosLv2[x],get(LosLv[[x]][2])])$Effect.Size,
                              mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2Ap<-round(data.table(unlist(EffSAp)),Prc)
  ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Young", "M1-M2 on Old", "M2-M3 on Young", "M2-M3 on Old",
                                    "M3-M4 on Young", "M3-M4 on Old"),ConEntre.b1Ap,EfSize=ConEntre.b2Ap)
  ConEntre.b3Ap<-ConEntre.b3Ap[,-3]
  ConEntre.b3Ap<-ConEntre.b3Ap[,.(Contr,psihat,df=NA,test, p.value ,EfSize.V1)]
  ConEntre.b3.Funde<-rbind(ConEntre.b3,ConEntre.b3Ap)
  #write.csv2(as.data.table(ConEntre.b3.Funde),paste0(NmBas,"ContrAC.csv"))
  ExFin$InterAC<-as.data.table(ConEntre.b3.Funde)
    
  # 4) Interaction BC
  # B on each Moment/Time/Trial C
  cnMM.2<-ContCAll(A=2,B=2,C=4,"BenC") #ContBC 
  Contr.2<-lincon(DatPas[[2]],con= cnMM.2)
  ConEntre.2.b1<-round(as.data.table(cbind(Contr.2$test,Contr.2$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.2.b1$p.value <-round(Contr.2$psihat[,5],4)
  
  # Approximation to estimate Effect Size
  levIS<-paste0("T",1:C)
  EffS<-parallel::mclapply(1:C, function(x) WRS2::yuen(get(levIS[x])~Sleep,data=DatPas[[1]])[6],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.2.b2<-round(data.table(unlist(EffS)),Prc)
  ConEntre.2.b3<-data.table(Contr=c("Sleep on M1", "Sleep on M2", "Sleep on M3",
                                    "Sleep on M4"),ConEntre.2.b1,EfSize=ConEntre.2.b2)
  
  # Learning on BC
  cnMM.Ap2<-ContCAll(A=2,B=2,C=4,"Succ.BC")  #ContBC.Learn 
  Contr.1Ap2<-rmmcp(DatPas[[2]],con=cnMM.Ap2)
  ConEntre.b1Ap2<-round(as.data.table(cbind( Contr.1Ap2$test, Contr.1Ap2$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1Ap2$p.value <-round(Contr.1Ap2$test[,3],4)
  
  # Approximation to estimate Effect Size
  LosLv<-split(c(rep("T1",2),rep("T2",2),rep("T3",2),rep("T2",2),rep("T3",2),rep("T4",2)),1:6)
  LosLv2<-rep(levels(DatPas[[1]]$Sleep),3)
  EffSAp<- parallel::mclapply(1:6, function(x)   yuendv2(DatPas[[1]][Sleep==LosLv2[x],get(LosLv[[x]][1])],
                                               DatPas[[1]][Sleep==LosLv2[x],get(LosLv[[x]][2])])$Effect.Size,
                              mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2Ap2<-round(data.table(unlist(EffSAp)),Prc)
  ConEntre.b3Ap2<-data.table(Contr=c("M1-M2 on Control", "M1-M2 on SR", "M2-M3 on Control", "M2-M3 on SR",
                                     "M3-M4 on Control", "M3-M4 on SR"),ConEntre.b1Ap2,EfSize=ConEntre.b2Ap2)
  ConEntre.b3Ap2<-ConEntre.b3Ap2[,-3]
  ConEntre.b3Ap2<-ConEntre.b3Ap2[,.(Contr,psihat,df=NA,test, p.value ,EfSize.V1)]
  ConEntre.b3.Funde2<-rbind(ConEntre.2.b3,ConEntre.b3Ap2)
  ExFin$InterBC<-as.data.table(ConEntre.b3.Funde2)
  
  # 5) Main Effect of C (Trial/Moment/Time)
  cnMM<-ContCAll(A=2,B=2,C=4,"Succ") #ContC()
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  ContrFunde<-ContrFunde[,-2]
  ConEntre.b3Ap<-ContrFunde[,.(psihat,df=NA,test, p.value,Psihat2, p.value2)]
      
  # Approximation to estimate Effect Size
  LosLv<-split(c("T1","T2","T3","T2","T3","T4"),1:3)
  EffSAp2<- parallel::mclapply(1:3, function(x) yuendv2(DatPas[[1]][,get(LosLv[[x]][1])],DatPas[[1]][,get(LosLv[[x]][2])])$Effect.Size,
                               mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(unlist(EffSAp2)),Prc)
  ConEntre.b3<-data.table(Contr=c("M1-M2", "M2-M3", "M3-M4"),ContrFunde,EfSize=ConEntre.b2)
  ExFin$DetallMainC<-ConEntre.b3
  
  # 6) Learning (successive Trial/Time/Moment) on AB (each experimental condition)
  cnMM.Ap<-ContCAll(A=2,B=2,C=4,"Succ.EfS") #ContABC.Learn
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM.Ap)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM.Ap)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  
  DtIntra<-copy(DatPas[[1]]);
  DtIntra[,Inter:=interaction(Age,Sleep)]
  DtIntra$Inter<-factor(DtIntra$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
  AExtr<-c("dif","df","teststat","Effect.Size","p.value")
  LosLv<-split(c(rep("T1",4),rep("T2",4),rep("T3",4),rep("T2",4),rep("T3",4),rep("T4",4)),1:12)
  LosLv2<-rep(levels(DtIntra$Inter),3)
  EffSApC<- parallel::mclapply(1:12, function(x)   yuendv2(DtIntra[Inter==LosLv2[x],get(LosLv[[x]][1])],
                                               DtIntra[Inter==LosLv2[x],get(LosLv[[x]][2])])
                                                [AExtr],
                               mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  TestContr2<-data.table(do.call(rbind, setNames(EffSApC,AExtr)))
  ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Y_C", "M1-M2 on Y_SR", "M1-M2 on O_C", "M1-M2 on O_SR",
                                      "M2-M3 on Y_C", "M2-M3 on Y_SR", "M2-M3 on O_C", "M2-M3 on O_SR",
                                      "M3-M4 on Y_C", "M3-M4 on Y_SR", "M3-M4 on O_C", "M3-M4 on O_SR"),
                              ContrFunde)
    ConEntre.b3Ap<-ConEntre.b3Ap[,-3]
    ConEntre.b3Ap<-ConEntre.b3Ap[,.(Contr,psihat,df=NA,test, p.value,Psihat2, p.value2)]
    rrF<-data.table(ConEntre.b3Ap,dif.yuen=round(unlist(TestContr2[,1]),Prc),df.yuen=unlist(TestContr2[,2]),
                    test.yuen=round(unlist(TestContr2[,3]),Prc),EffSize.yuen=round(unlist(TestContr2[,4]),Prc),
                    pvaluet.yuen=round(unlist(TestContr2[,5]),4))
    ExFin$DetallTrialCadaCondAB<-rrF
    
    # 7) Simple Simple Effect AxB on each Trial/Moment/Time
    ExFin$DetallSimple<-parallel::mclapply(1:C, function (is) AOVBwF(2,2,DatPas = DatEfSp[[is]],nBMM2),
                                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)  
    
    return(ExFin)
  }
  
  AOVMx2b<-function(A=2,C=4,DatPas,DatEfSp,nBMM1=10000,nBMM2=10000,Prc=2) {
    require(parallel);require(data.table)
  #A=2;C=4;DatPas = rrt;DatEfSp = DatEfS;nBMM1 = 10000;nBMM2 = 1000;Prc = 2
  # Omnibus design {2*(4*S)} & {2*(5*S)} 
  # bbwtrim, bbwtrimbt, bbwtrimbt_vMM  
  # ContC, rmmcp, rmmismcp, yuendv2
  # En Ef Simples de A*B en cada Momento, como AOVBwF
	ExFin<-list()
  ResRo<-list()
  rr2<-rr<-list()
  
  # 1) ANOVA Omnibus
  RsRb<-bwtrim(A,C,DatPas[[2]])
  ResRo$w<- round(c(RsRb$Qa.p.value, RsRb$Qb.p.value, RsRb$Qab.p.value),4)
  ResRo$BT<-try(c(bwtrimbt(A,C,DatPas[[2]])))
  APA.N1<-try(c(round(unlist(RsRb),Prc),round(unlist(ResRo$BT),Prc)))
  rr<-try(ExtrSig(ResRo$BT))
  #print(rr)
  ResRo$BT_MM<-try(c(bwtrimbt(A,C,DatPas[[2]],nboot = nBMM1)))
  rr2=try(ExtrSig(ResRo$BT_MM))
  #print(rr2)
  
  is_try_error <- function(x) inherits(x, "try-error")
  if (is_try_error(rr)) {rr<-list();rr$p.V1<-NA;rr$p.Sig<-NA}
  if (is_try_error(rr2)) {rr2<-list();rr2$p.V1<-NA;rr2$p.Sig<-NA}
  
  ExRsRbp<-with(RsRb, round(c(Qa.p.value, Qb.p.value,Qab.p.value),4))
  ExRsRbQ<-with(RsRb, round(c(Qa, Qb, Qab),Prc))
  ExFin$AOV<-data.table(ExRsRbQ,ExRsRbp,rr$p.V1,rr$p.Sig,rr2$p.V1,rr2$p.Sig)
  names(ExFin$AOV)<-c("Q","p","pBoot","Sig","pBootMas","Sig2")
  ExFin$AOV<-data.table(Names=c("Age","Trial","Age*Trial"),ExFin$AOV)
  
  TamA=round(mean(ESmainMCP(A,C,DatPas[[2]])$Factor.A[,3]),Prc)
	TamB=round(mean(ESmainMCP(A,C,DatPas[[2]])$Factor.B[,3]),Prc)
	TamInt=round(mean(esImcp(A,C,DatPas[[2]])$Effect.Sizes),Prc)
  ExFin$AOV[,EffSize:=c(TamA,TamB,TamInt)]
  
  # 2) Interaction AB
  # A on each C & C on each A
  cnMM<-ContCAll(A=A,B=1,C=C,"AenC") #ContAenBMixto 
  Contr.1<-lincon(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)
  
  # A on each C
  # Approximation to estimate Effect Size
  levIS<-paste0("T",1:C)
  EffS<-parallel::mclapply(1:C, function(x) WRS2::yuen(get(levIS[x])~Group,data=DatPas[[1]])[6],mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(unlist(EffS)),Prc)
  ConEntre.b3<-data.table(Contr=c(paste0("Age on M",1:C)),ConEntre.b1,EfSize=ConEntre.b2)
  
  # Learning (successive Time/Moment/Trial) on AC
  cnMM.Ap<-ContCAll(A=A,B=1,C=C,"Succ.AC") #ContBenAMixto 
  Contr.1Ap<-rmmcp(DatPas[[2]],con=cnMM.Ap)
  ConEntre.b1Ap<-round(as.data.table(cbind(Contr.1Ap$test,Contr.1Ap$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1Ap$p.value <-round(Contr.1Ap$test[,3],4)
  
  # C on each A  
  # Approximation to estimate Effect Size
  if (C==4) {
    LosLv<-split(c(rep("T1",2),rep("T2",2),rep("T3",2),rep("T2",2),rep("T3",2),rep("T4",2)),1:6)
    LosLv2<-rep(levels(DatPas[[1]]$Group),3)
    EffSAp<- parallel::mclapply(1:6, function(x)   yuendv2(DatPas[[1]][Group==LosLv2[x],get(LosLv[[x]][1])],
                                               DatPas[[1]][Group==LosLv2[x],get(LosLv[[x]][2])])$Effect.Size,
                              mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
    ConEntre.b2Ap<-round(data.table(unlist(EffSAp)),Prc)
    ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Young", "M1-M2 on Old", "M2-M3 on Young", "M2-M3 on Old",
                                    "M3-M4 on Young", "M3-M4 on Old"),ConEntre.b1Ap,EfSize=ConEntre.b2Ap)
  }
  if (C==5) {
    LosLv<-split(c(rep("T1",2),rep("T2",2),rep("T3",2),rep("T4",2),rep("T2",2),rep("T3",2),rep("T4",2),rep("T5",2)),1:8)
  LosLv2<-rep(levels(DatPas[[1]]$Group),4)
  EffSAp<- parallel::mclapply(1:8, function(x)   yuendv2(DatPas[[1]][Group==LosLv2[x],get(LosLv[[x]][1])],
                                               DatPas[[1]][Group==LosLv2[x],get(LosLv[[x]][2])])$Effect.Size,
                              mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2Ap<-round(data.table(unlist(EffSAp)),Prc)
  ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Young", "M1-M2 on Old", "M2-M3 on Young", "M2-M3 on Old",
                                    "M3-M4 on Young", "M3-M4 on Old", "M4-M5 on Young", "M4-M5 on Old"),
                            ConEntre.b1Ap,EfSize=ConEntre.b2Ap)
  }
  ConEntre.b3Ap<-ConEntre.b3Ap[,-3]
  ConEntre.b3Ap<-ConEntre.b3Ap[,.(Contr,psihat,df=NA,test, p.value ,EfSize.V1)]
  ConEntre.b3.Funde<-rbind(ConEntre.b3,ConEntre.b3Ap)
  #write.csv2(as.data.table(ConEntre.b3.Funde),paste0(NmBas,"ContrAC.csv"))
  ExFin$InterAC<-as.data.table(ConEntre.b3.Funde)
    
  # 3) Main Effect of C (Trial/Moment/Time)
  cnMM<-ContCAll(A=A,B=1,C=C,"Succ") #ContC.3b
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  ContrFunde<-ContrFunde[,-2]
  ConEntre.b3Ap<-ContrFunde[,.(psihat,df=NA,test, p.value,Psihat2, p.value2)]
      
  # Approximation to estimate Effect Size
  if (C==4) {
    LosLv<-split(c("T1","T2","T3","T2","T3","T4"),1:3)
    EffSAp2<- parallel::mclapply(1:3, function(x) yuendv2(DatPas[[1]][,get(LosLv[[x]][1])],DatPas[[1]][,get(LosLv[[x]][2])])$Effect.Size,
                               mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
    ConEntre.b2<-round(data.table(unlist(EffSAp2)),Prc)
    ConEntre.b3<-data.table(Contr=c("M1-M2", "M2-M3", "M3-M4"),ContrFunde,EfSize=ConEntre.b2)  
  }
  if (C==5) {
    LosLv<-split(c("T1","T2","T3","T4","T2","T3","T4","T5"),1:4)
    EffSAp2<- parallel::mclapply(1:4, function(x) yuendv2(DatPas[[1]][,get(LosLv[[x]][1])],DatPas[[1]][,get(LosLv[[x]][2])])$Effect.Size,
                               mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
    ConEntre.b2<-round(data.table(unlist(EffSAp2)),Prc)
    ConEntre.b3<-data.table(Contr=c("M1-M2", "M2-M3", "M3-M4", "M4-M5"),ContrFunde,EfSize=ConEntre.b2)
  }
  ExFin$DetallMainC<-ConEntre.b3
  
    return(ExFin)
  }
  
  AOVMx2.2<-function(A=2,B=2,C=2,DatPas,DatEfSp,nBMM1=10000,nBMM2=10000,Prc=2) {
    require(parallel);require(data.table)
  # Variant for Intra variable of 2 levels
  # Omnibus design {2*2*(2*S)}
  # bbwtrim, bbwtrimbt, bbwtrimbt_vMM  
  # ContC, rmmcp, rmmismcp, yuendv2
  # On Simple Effects of AxB on each Moment/Trual/Moment, as in AOVBwF
	ExFin<-list()
  ResRo<-list()
  
  # 1) ANOVA Omnibus
  RsRb<-bbwtrim(A,B,C,DatPas[[2]])
  ResRo$w<- round(c(RsRb$Qa.p.value, RsRb$Qb.p.value, RsRb$Qc.p.value, RsRb$Qab.p.value,RsRb$Qac.p.value,
                    RsRb$Qbc.p.value, RsRb$Qabc.p.value),4)
  ResRo$BT<-c(bbwtrimbt(A,B,C,DatPas[[2]]))
  APA.N1<-c(round(unlist(RsRb),4),round(unlist(ResRo$BT),4))
  rr<-ExtrSig(ResRo$BT)
  print(rr)
  
  ResRo$BT_MM<-c(bbwtrimbt_vMM(A,B,C,DatPas[[2]],nboot = nBMM1))
  ResRo$Rk1<- bdm2way(A,B,DatPas[[2]])
  rr2=ExtrSig(ResRo$BT_MM)
  print(rr2)
      
  ExRsRbQ<-with(RsRb, round(c(Qa, Qb,Qc, Qab, Qac, Qbc, Qabc),Prc))
  ExRsRbp<-with(RsRb, round(c(Qa.p.value, Qb.p.value,Qc.p.value, Qab.p.value, Qac.p.value, Qbc.p.value, Qabc.p.value),4))
  ExFin$AOV<-data.table(ExRsRbQ,ExRsRbp,rr$p.V1,rr$p.Sig,rr2$p.V1,rr2$p.Sig)
  names(ExFin$AOV)<-c("Q","p","pBoot","Sig","pBootMas","Sig2")
  ExFin$AOV<-data.table(Names=c("Age","Sleep","Time","Age*Sleep","Age*Time","Sleep*Time","Age*Sleep*Time"),ExFin$AOV)
   
  # 2) Interacion AB
  # A on each B & B on each A
  cnMM<-ContCAll(A=2,B=2,C=2,"Desgl.AB") #ContAB.2Intra 
  Contr.1<-lincon(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)
  
  # Approximation to estimate Effect Size
  DatPas[[1]][,NewIntra:=rowMeans(DatPas[[1]][,.(T1,T2)],na.rm = T)]
  
  EffA<-parallel::mclapply(1:A, function(x) WRS2::yuen(NewIntra~Sleep,data=DatPas[[1]][Age==levels(Age)[x]])[6],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffB<-parallel::mclapply(1:B, function(x) WRS2::yuen(NewIntra~Age,data=DatPas[[1]][Sleep==levels(Sleep)[x]])[6], 
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(c(unlist(EffA),unlist(EffB))),Prc)
  ConEntre.b3<-data.table(Contr=c("Sleep on Young", "Sleep on Old", "Age on Control",
                                    "Age on SR"),ConEntre.b1,EfSize=ConEntre.b2)
  ExFin$InterAB<-as.data.table(ConEntre.b3)
  
  # 3) Interaction AC
  # A on each C
  cnMM<-ContCAll(A=2,B=2,C=2,"AenC")  #ContAC.2Intra 
  Contr.1<-lincon(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)
    
  # Approximation to estimate Effect Size
  levIS<-paste0("T",1:C)
  EffS<-parallel::mclapply(1:C, function(x) WRS2::yuen(get(levIS[x])~Age,data=DatPas[[1]])[6],mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(unlist(EffS)),Prc)
  ConEntre.b3<-data.table(Contr=c("Age on M1", "Age on M2"),ConEntre.b1,EfSize=ConEntre.b2)
  
  # Learning (successive) on AC
  cnMM.Ap<-ContCAll(A=2,B=2,C=2,"Succ.AC")  #ContAC.2Learn 
  Contr.1Ap<-rmmcp(DatPas[[2]],con=cnMM.Ap)
  ConEntre.b1Ap<-round(as.data.table(cbind(Contr.1Ap$test,Contr.1Ap$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1Ap$p.value <-round(Contr.1Ap$test[,3],4)
    
  # Approximation to estimate Effect Size
  LosLv<-split(c(rep("T1",2),rep("T2",2)),1:2)
  LosLv2<-rep(levels(DatPas[[1]]$Age),1)
  EffSAp<- parallel::mclapply(1:2, function(x)   yuendv2(DatPas[[1]][Age==LosLv2[x],get(LosLv[[x]][1])],
                                               DatPas[[1]][Age==LosLv2[x],get(LosLv[[x]][2])])$Effect.Size,
                              mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2Ap<-round(data.table(unlist(EffSAp)),Prc)
  ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Young", "M1-M2 on Old"),ConEntre.b1Ap,EfSize=ConEntre.b2Ap)
  ConEntre.b3Ap<-ConEntre.b3Ap[,-3]
  ConEntre.b3Ap<-ConEntre.b3Ap[,.(Contr,psihat,df=NA,test, p.value ,EfSize.V1)]
  ConEntre.b3.Funde<-rbind(ConEntre.b3,ConEntre.b3Ap)
  #write.csv2(as.data.table(ConEntre.b3.Funde),paste0(NmBas,"ContrAC.csv"))
  ExFin$InterAC<-as.data.table(ConEntre.b3.Funde)
    
  # 4) Interaction BC
  # B on each C
  cnMM.2<-ContCAll(A=2,B=2,C=2,"BenC") #ContBC.2Intra 
  Contr.2<-lincon(DatPas[[2]],con= cnMM.2)
  ConEntre.2.b1<-round(as.data.table(cbind(Contr.2$test,Contr.2$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.2.b1$p.value <-round(Contr.2$psihat[,5],4)
  
  # Approximation to estimate Effect Size
  levIS<-paste0("T",1:C)
  EffS<-parallel::mclapply(1:C, function(x) WRS2::yuen(get(levIS[x])~Sleep,data=DatPas[[1]])[6],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.2.b2<-round(data.table(unlist(EffS)),Prc)
  ConEntre.2.b3<-data.table(Contr=c("Sleep on M1", "Sleep on M2"),ConEntre.2.b1,EfSize=ConEntre.2.b2)
  
  # Learning (successive) on BC
  cnMM.Ap2<-ContCAll(A=2,B=2,C=2,"Succ.BC") #ContBC.2Learn 
  Contr.1Ap2<-rmmcp(DatPas[[2]],con=cnMM.Ap2)
  ConEntre.b1Ap2<-round(as.data.table(cbind( Contr.1Ap2$test, Contr.1Ap2$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1Ap2$p.value <-round(Contr.1Ap2$test[,3],4)
  
  # Approximation to estimate Effect Size
  LosLv<-split(c(rep("T1",2),rep("T2",2)),1:2)
  LosLv2<-rep(levels(DatPas[[1]]$Sleep),1)
  EffSAp<- parallel::mclapply(1:2, function(x)   yuendv2(DatPas[[1]][Sleep==LosLv2[x],get(LosLv[[x]][1])],
                                               DatPas[[1]][Sleep==LosLv2[x],get(LosLv[[x]][2])])$Effect.Size,
                              mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2Ap2<-round(data.table(unlist(EffSAp)),Prc)
  ConEntre.b3Ap2<-data.table(Contr=c("M1-M2 on Control", "M1-M2 on SR"),ConEntre.b1Ap2,EfSize=ConEntre.b2Ap2)
  ConEntre.b3Ap2<-ConEntre.b3Ap2[,-3]
  ConEntre.b3Ap2<-ConEntre.b3Ap2[,.(Contr,psihat,df=NA,test, p.value ,EfSize.V1)]
  ConEntre.b3.Funde2<-rbind(ConEntre.2.b3,ConEntre.b3Ap2)
  #write.csv2(as.data.table(ConEntre.b3.Funde2),paste0(NmBas,"ContrBC.csv"))
  ExFin$InterBC<-as.data.table(ConEntre.b3.Funde2)
  
  # 5) Main Effect of C (Trial/Moment/Time) which I keep although it is not necessary because C = 2
  cnMM<-ContCAll(A=2,B=2,C=2,"Succ") #ContC.2
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  ContrFunde<-ContrFunde[,-2]
  ConEntre.b3Ap<-ContrFunde[,.(psihat,df=NA,test, p.value,Psihat2, p.value2)]
      
  # Approximation to estimate Effect Size
  LosLv<-c("T1","T2")
  EffSAp2<- parallel::mclapply(1:1, function(x) yuendv2(DatPas[[1]][,get(LosLv[1])],DatPas[[1]][,get(LosLv[2])])$Effect.Size,
                               mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(unlist(EffSAp2)),Prc)
  ConEntre.b3<-data.table(Contr=c("M1-M2"),ContrFunde,EfSize=ConEntre.b2)
  ExFin$DetallMainC<-ConEntre.b3
  
  # 6) Learning (successive Trial/Moment/Time) on AB (each experimental condition)
  cnMM.Ap<-ContCAll(A=2,B=2,C=2,"Succ.EfS") #ContABC.2Learn
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM.Ap)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM.Ap)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  
  DtIntra<-copy(DatPas[[1]]);
  DtIntra[,Inter:=interaction(Age,Sleep)]
  DtIntra$Inter<-factor(DtIntra$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
  AExtr<-c("dif","df","teststat","Effect.Size","p.value")
  LosLv<-split(c(rep("T1",4),rep("T2",4)),1:4)
  LosLv2<-rep(levels(DtIntra$Inter),1)
  x=2
  EffSApC<- parallel::mclapply(1:4, function(x)   yuendv2(DtIntra[Inter==LosLv2[x],get(LosLv[[x]][1])],
                                               DtIntra[Inter==LosLv2[x],get(LosLv[[x]][2])])
                                                [AExtr],
                               mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  TestContr2<-data.table(rbind(unlist(EffSApC[[1]]),unlist(EffSApC[[2]]),unlist(EffSApC[[3]]),unlist(EffSApC[[4]])))
  ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Y_C", "M1-M2 on Y_SR", "M1-M2 on O_C", "M1-M2 on O_SR"),
                              ContrFunde)
    ConEntre.b3Ap<-ConEntre.b3Ap[,-3]
    ConEntre.b3Ap<-ConEntre.b3Ap[,.(Contr,psihat,df=NA,test, p.value,Psihat2, p.value2)]
    rrF<-data.table(ConEntre.b3Ap,dif.yuen=round(unlist(TestContr2[,1]),Prc),df.yuen=unlist(TestContr2[,2]),
                    test.yuen=round(unlist(TestContr2[,3]),Prc),EffSize.yuen=round(unlist(TestContr2[,4]),Prc),
                    pvaluet.yuen=round(unlist(TestContr2[,5]),4))
    ExFin$DetallTrialCadaCondAB<-rrF
    
    # 7) Simple Simple Effect AxB on each Trial/Moment/Time
    ExFin$DetallSimple<-parallel::mclapply(1:C, function (is) AOVBwF(2,2,DatPas = DatEfSp[[is]],nBMM2),
                                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)  
    
    return(ExFin)
  }
  
  AOVMx2.5<-function(A=2,B=2,C=5,DatPas,DatEfSp,nBMM1=10000,nBMM2=10000,Prc=2) {
    require(parallel);require(data.table)
  # Variant for Intra variable of 5 levels
  # Omnibus design {2*2*(5*S)}
  # bbwtrim, bbwtrimbt, bbwtrimbt_vMM  
  # ContC, rmmcp, rmmismcp, yuendv2
  # On Simple Effects of AxB on each Moment/Trual/Moment, as in AOVBwF
	ExFin<-list()
  ResRo<-list()
  
  # 1) ANOVA Omnibus
  RsRb<-bbwtrim(A,B,C,DatPas[[2]])
  ResRo$w<- round(c(RsRb$Qa.p.value, RsRb$Qb.p.value, RsRb$Qc.p.value, RsRb$Qab.p.value,RsRb$Qac.p.value,
                    RsRb$Qbc.p.value, RsRb$Qabc.p.value),4)
  ResRo$BT<-c(bbwtrimbt(A,B,C,DatPas[[2]]))
  APA.N1<-c(round(unlist(RsRb),4),round(unlist(ResRo$BT),4))
  rr<-ExtrSig(ResRo$BT)
  print(rr)
 
  ResRo$BT_MM<-c(bbwtrimbt_vMM(A,B,C,DatPas[[2]],nboot = nBMM1))
  ResRo$Rk1<- bdm2way(A,B,DatPas[[2]])
  rr2=ExtrSig(ResRo$BT_MM)
  print(rr2)
      
  ExRsRbQ<-with(RsRb, round(c(Qa, Qb,Qc, Qab, Qac, Qbc, Qabc),Prc))
  ExRsRbp<-with(RsRb, round(c(Qa.p.value, Qb.p.value,Qc.p.value, Qab.p.value, Qac.p.value, Qbc.p.value, Qabc.p.value),4))
  ExFin$AOV<-data.table(ExRsRbQ,ExRsRbp,rr$p.V1,rr$p.Sig,rr2$p.V1,rr2$p.Sig)
  names(ExFin$AOV)<-c("Q","p","pBoot","Sig","pBootMas","Sig2")
  ExFin$AOV<-data.table(Names=c("Age","Sleep","Time","Age*Sleep","Age*Time","Sleep*Time","Age*Sleep*Time"),ExFin$AOV)
   
  # 2) Interaction AB
  # A on each B & B on each A
  cnMM<-ContCAll(A=2,B=2,C=5,"Desgl.AB") #ContAB.5 
  Contr.1<-lincon(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)
  
  # Approximation to estimate Effect Size
  DatPas[[1]][,NewIntra:=rowMeans(DatPas[[1]][,.(T1,T2,T3,T4,T5)],na.rm = T)]
  
  EffA<-parallel::mclapply(1:A, function(x) WRS2::yuen(NewIntra~Sleep,data=DatPas[[1]][Age==levels(Age)[x]])[6],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  EffB<-parallel::mclapply(1:B, function(x) WRS2::yuen(NewIntra~Age,data=DatPas[[1]][Sleep==levels(Sleep)[x]])[6], 
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(c(unlist(EffA),unlist(EffB))),Prc)
  ConEntre.b3<-data.table(Contr=c("Sleep on Young", "Sleep on Old", "Age on Control",
                                    "Age on SR"),ConEntre.b1,EfSize=ConEntre.b2)
  ExFin$InterAB<-as.data.table(ConEntre.b3)
    
  # 3) Interaction AC
  # A on each Moment/Time/Trial of C
  cnMM<-ContCAll(A=2,B=2,C=5,"AenC") #ContAC.5 
  Contr.1<-lincon(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$psihat[,5],4)
    
  # Approximation to estimate Effect Size
  levIS<-paste0("T",1:C)
  EffS<-parallel::mclapply(1:C, function(x) WRS2::yuen(get(levIS[x])~Age,data=DatPas[[1]])[6],mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(unlist(EffS)),Prc)
  ConEntre.b3<-data.table(Contr=c("Age on M1", "Age on M2", "Age on M3", "Age on M4","Age on M5"),ConEntre.b1,EfSize=ConEntre.b2)
  
  # Learning (successive Trial/Time/Moment) on AC
  cnMM.Ap<-ContCAll(A=2,B=2,C=5,"Succ.AC") #ContAC.5Learn 
  Contr.1Ap<-rmmcp(DatPas[[2]],con=cnMM.Ap)
  ConEntre.b1Ap<-round(as.data.table(cbind(Contr.1Ap$test,Contr.1Ap$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1Ap$p.value <-round(Contr.1Ap$test[,3],4)
    
  # Approximation to estimate Effect Size
  LosLv<-split(c(rep("T1",2),rep("T2",2),rep("T3",2),rep("T4",2),rep("T2",2),rep("T3",2),rep("T4",2),rep("T5",2)),1:8)
  LosLv2<-rep(levels(DatPas[[1]]$Age),4)
  EffSAp<- parallel::mclapply(1:8, function(x)   yuendv2(DatPas[[1]][Age==LosLv2[x],get(LosLv[[x]][1])],
                                               DatPas[[1]][Age==LosLv2[x],get(LosLv[[x]][2])])$Effect.Size,
                              mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2Ap<-round(data.table(unlist(EffSAp)),Prc)
  ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Young", "M1-M2 on Old", "M2-M3 on Young", "M2-M3 on Old",
                                    "M3-M4 on Young", "M3-M4 on Old", "M4-M5 on Young", "M4-M5 on Old"),
                            ConEntre.b1Ap,EfSize=ConEntre.b2Ap)
  ConEntre.b3Ap<-ConEntre.b3Ap[,-3]
  ConEntre.b3Ap<-ConEntre.b3Ap[,.(Contr,psihat,df=NA,test, p.value ,EfSize.V1)]
  ConEntre.b3.Funde<-rbind(ConEntre.b3,ConEntre.b3Ap)
  ExFin$InterAC<-as.data.table(ConEntre.b3.Funde)
    
  # 4) Interaction BC
  # B on each C
  cnMM.2<-ContCAll(A=2,B=2,C=5,"BenC") #ContBC.5 
  Contr.2<-lincon(DatPas[[2]],con= cnMM.2)
  ConEntre.2.b1<-round(as.data.table(cbind(Contr.2$test,Contr.2$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.2.b1$p.value <-round(Contr.2$psihat[,5],4)
  
  # Approximation to estimate Effect Size
  levIS<-paste0("T",1:C)
  EffS<-parallel::mclapply(1:C, function(x) WRS2::yuen(get(levIS[x])~Sleep,data=DatPas[[1]])[6],
                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.2.b2<-round(data.table(unlist(EffS)),Prc)
  ConEntre.2.b3<-data.table(Contr=c("Sleep on M1", "Sleep on M2", "Sleep on M3",
                                    "Sleep on M4", "Sleep on M5"),ConEntre.2.b1,EfSize=ConEntre.2.b2)
  
  # Learning (successive Time/Trial/Moment) on BC
  cnMM.Ap2<-ContCAll(A=2,B=2,C=5,"Succ.BC") #ContBC.5Learn
  Contr.1Ap2<-rmmcp(DatPas[[2]],con=cnMM.Ap2)
  ConEntre.b1Ap2<-round(as.data.table(cbind( Contr.1Ap2$test, Contr.1Ap2$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1Ap2$p.value <-round(Contr.1Ap2$test[,3],4)
  
  # Approximation to estimate Effect Size
  LosLv<-split(c(rep("T1",2),rep("T2",2),rep("T3",2),rep("T4",2),rep("T2",2),rep("T3",2),rep("T4",2),rep("T5",2)),1:8)
  LosLv2<-rep(levels(DatPas[[1]]$Sleep),4)
  EffSAp<- parallel::mclapply(1:8, function(x)   yuendv2(DatPas[[1]][Sleep==LosLv2[x],get(LosLv[[x]][1])],
                                               DatPas[[1]][Sleep==LosLv2[x],get(LosLv[[x]][2])])$Effect.Size,
                              mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2Ap2<-round(data.table(unlist(EffSAp)),Prc)
  ConEntre.b3Ap2<-data.table(Contr=c("M1-M2 on Young", "M1-M2 on Old", "M2-M3 on Young", "M2-M3 on Old",
                                    "M3-M4 on Young", "M3-M4 on Old", "M4-M5 on Young", "M4-M5 on Old"),
                             ConEntre.b1Ap2,EfSize=ConEntre.b2Ap2)
  ConEntre.b3Ap2<-ConEntre.b3Ap2[,-3]
  ConEntre.b3Ap2<-ConEntre.b3Ap2[,.(Contr,psihat,df=NA,test, p.value ,EfSize.V1)]
  ConEntre.b3.Funde2<-rbind(ConEntre.2.b3,ConEntre.b3Ap2)
  ExFin$InterBC<-as.data.table(ConEntre.b3.Funde2)
  
  # 5) Main Effect of C (Trial/Moment/Time)
  cnMM<-ContCAll(A=2,B=2,C=5,"Succ") #ContC.5
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  ContrFunde<-ContrFunde[,-2]
  ConEntre.b3Ap<-ContrFunde[,.(psihat,df=NA,test, p.value,Psihat2, p.value2)]
      
  # Approximation to estimate Effect Size
  LosLv<-split(c("T1","T2","T3","T4","T2","T3","T4","T5"),1:4)
  EffSAp2<- parallel::mclapply(1:4, function(x) yuendv2(DatPas[[1]][,get(LosLv[[x]][1])],DatPas[[1]][,get(LosLv[[x]][2])])$Effect.Size,
                               mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  ConEntre.b2<-round(data.table(unlist(EffSAp2)),Prc)
  ConEntre.b3<-data.table(Contr=c("M1-M2", "M2-M3", "M3-M4", "M4-M5"),ContrFunde,EfSize=ConEntre.b2)
  ExFin$DetallMainC<-ConEntre.b3
  
  # 6) Learning (successive Trial/Moment/time) on AB (each experimental condition)
  cnMM.Ap<-ContCAll(A=2,B=2,C=5,"Succ.EfS") #ContABC.5Learn
  Contr.1<-rmmcp(DatPas[[2]],con=cnMM.Ap)
  Contr.1b<-rmmismcp(DatPas[[2]],con=cnMM.Ap)
  ConEntre.b1<-round(as.data.table(cbind(Contr.1$test,Contr.1$psihat)),Prc)[,.(psihat,df,test,p.value)]
  ConEntre.b1$p.value <-round(Contr.1$test[,3],4)
  ConEntre.b1b<-as.data.table(cbind(round(Contr.1b$output[,2],Prc), round(Contr.1b$output[,3],4)))
  names(ConEntre.b1b)<-c("Psihat2","p.value2")
  ContrFunde<-cbind(ConEntre.b1,ConEntre.b1b)
  
  DtIntra<-copy(DatPas[[1]]);
  DtIntra[,Inter:=interaction(Age,Sleep)]
  DtIntra$Inter<-factor(DtIntra$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
  AExtr<-c("dif","df","teststat","Effect.Size","p.value")
  LosLv<-split(c(rep("T1",4),rep("T2",4),rep("T3",4),rep("T4",4),rep("T2",4),rep("T3",4),rep("T4",4),rep("T5",4)),1:16)
  LosLv2<-rep(levels(DtIntra$Inter),4)
  EffSApC<- parallel::mclapply(1:16, function(x)   yuendv2(DtIntra[Inter==LosLv2[x],get(LosLv[[x]][1])],
                                               DtIntra[Inter==LosLv2[x],get(LosLv[[x]][2])])
                                                [AExtr],
                               mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)
  TestContr2<-data.table(do.call(rbind, setNames(EffSApC,AExtr)))
  ConEntre.b3Ap<-data.table(Contr=c("M1-M2 on Y_C", "M1-M2 on Y_SR", "M1-M2 on O_C", "M1-M2 on O_SR",
                                      "M2-M3 on Y_C", "M2-M3 on Y_SR", "M2-M3 on O_C", "M2-M3 on O_SR",
                                      "M3-M4 on Y_C", "M3-M4 on Y_SR", "M3-M4 on O_C", "M3-M4 on O_SR",
                                     "M4-M5 on Y_C", "M4-M5 on Y_SR", "M4-M5 on O_C", "M4-M5 on O_SR"),
                              ContrFunde)
    ConEntre.b3Ap<-ConEntre.b3Ap[,-3]
    ConEntre.b3Ap<-ConEntre.b3Ap[,.(Contr,psihat,df=NA,test, p.value,Psihat2, p.value2)]
    rrF<-data.table(ConEntre.b3Ap,dif.yuen=round(unlist(TestContr2[,1]),Prc),df.yuen=unlist(TestContr2[,2]),
                    test.yuen=round(unlist(TestContr2[,3]),Prc),EffSize.yuen=round(unlist(TestContr2[,4]),Prc),
                    pvaluet.yuen=round(unlist(TestContr2[,5]),4))
    ExFin$DetallTrialCadaCondAB<-rrF
    
    # 7) Simple Simple Effect AxB on each Trial/Time/Moment
    ExFin$DetallSimple<-parallel::mclapply(1:C, function (is) AOVBwF(2,2,DatPas = DatEfSp[[is]],nBMM2),
                                           mc.cores = parallel::detectCores(), mc.allow.recursive = TRUE)  
    
    return(ExFin)
  }
  
  AlmacenGen<-function(GrpP,Grp2P=GrpP,DataPas, PathDesignP, NmBasP,Typ=1){
    NmFAl<-paste0(PathDesignP,NmBasP)
    if (!dir.exists(NmFAl)) {dir.create(NmFAl)}
    NmFAl<-paste0(NmFAl,"/")
    
    pdf(paste0(NmFAl,NmBasP,".pdf"),family = "ArialMT")
      plot(GrpP)
    dev.off()
    pdf(paste0(NmFAl,NmBasP,"_Asterisk.pdf"),family = "ArialMT")
      plot(Grp2P)
    dev.off()
    png(paste0(NmFAl,NmBasP,".png"),width = 1200, height = 1000,family = "ArialMT")
      plot(GrpP)
    dev.off()
    png(paste0(NmFAl,NmBasP,"_Asterisk.png"),width = 1200, height = 1000,family = "ArialMT")
      plot(Grp2P)
    dev.off()
  
    
    rtffile <- RTF(paste0(NmFAl,NmBasP,"AllStats.doc"))
    if (length(DataPas)<2 & Typ==1){
        write.csv2(as.data.table(DataPas[[1]]),paste0(NmFAl,NmBasP,"ResStat",1,"_",names(DataPas)[1],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[1]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[1]]));
        addNewLine(rtffile)
    }
    if (length(DataPas)>2 & Typ==2){
      for (i in 1:3) {
        write.csv2(as.data.table(DataPas[[i]]),paste0(NmFAl,NmBasP,"ResStat",i,"_",names(DataPas)[i],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[i]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[i]]));
        addNewLine(rtffile)  
      }
    }
    
    cont<-3
    if (length(DataPas)>2 & Typ==1){
      for (i in 1:length(DataPas)) {
        write.csv2(as.data.table(DataPas[[i]]),paste0(NmFAl,NmBasP,"ResStat",i,"_",names(DataPas)[i],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[i]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[i]]));
        addNewLine(rtffile)
      }
    }
    if (length(DataPas)>2 & Typ==2){
      for (j in 1:length(DataPas[[4]])) {
        for (k in 1:length(DataPas[[4]][[j]])) {
          cont<-cont+1
          write.csv2(as.data.table(DataPas[[4]][[j]][[k]]),paste0(NmFAl,NmBasP,"ResStat",cont,"_Cond",j,
                                                                  names(DataPas[[4]][[j]])[k],".csv"))
          addText(rtffile,paste0("Simple Effect A*B on Time_","_Cond",j,names(DataPas[[4]][[j]])[k]))
          addNewLine(rtffile)
          addTable(rtffile, as.data.table(DataPas[[4]][[j]][[k]]));
          addNewLine(rtffile)
        }
      }
    }
    addPlot(rtffile,plot.fun=print,width=6,height=6,res=600, GrpP)
    addNewLine(rtffile)
    addPlot(rtffile,plot.fun=print,width=6,height=6,res=600, Grp2P)
    done(rtffile)
  }
  
  AlmacenGen2<-function(GrpP,Grp2P=GrpP,DataPas, PathDesignP, NmBasP,Typ=1){
    NmFAl<-paste0(PathDesignP,NmBasP)
    if (!dir.exists(NmFAl)) {dir.create(NmFAl)}
    NmFAl<-paste0(NmFAl,"/")
    
    pdf(paste0(NmFAl,NmBasP,".pdf"),family = "ArialMT")
      plot(GrpP)
    dev.off()
    pdf(paste0(NmFAl,NmBasP,"_Asterisk.pdf"),family = "ArialMT")
      plot(Grp2P)
    dev.off()
    png(paste0(NmFAl,NmBasP,".png"),width = 1200, height = 1000,family = "ArialMT")
      plot(GrpP)
    dev.off()
    png(paste0(NmFAl,NmBasP,"_Asterisk.png"),width = 1200, height = 1000,family = "ArialMT")
      plot(Grp2P)
    dev.off()
  
    
    rtffile <- RTF(paste0(NmFAl,NmBasP,"AllStats.doc"))
    if (length(DataPas)<2 & Typ==1){
        write.csv2(as.data.table(DataPas[[1]]),paste0(NmFAl,NmBasP,"ResStat",1,"_",names(DataPas)[1],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[1]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[1]]));
        addNewLine(rtffile)
    }
    if (length(DataPas)>2 & Typ==2){
      for (i in 1:6) {
        write.csv2(as.data.table(DataPas[[i]]),paste0(NmFAl,NmBasP,"ResStat",i,"_",names(DataPas)[i],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[i]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[i]]));
        addNewLine(rtffile)  
      }
    }
    
    cont<-6
    if (length(DataPas)>2 & Typ==1){
      for (i in 3:length(DataPas)) {
        write.csv2(as.data.table(DataPas[[i]]),paste0(NmFAl,NmBasP,"ResStat",i,"_",names(DataPas)[i],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[i]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[i]]));
        addNewLine(rtffile)
      }
    }
    if (length(DataPas)>2 & Typ==2){
      for (j in 1:length(DataPas[[7]])) {
        for (k in 1:length(DataPas[[7]][[j]])) {
          cont<-cont+1
          write.csv2(as.data.table(DataPas[[7]][[j]][[k]]),paste0(NmFAl,NmBasP,"ResStat",cont,"_Cond",j,
                                                                  names(DataPas[[7]][[j]])[k],".csv"))
          addText(rtffile,paste0("Simple Effect A*B on Time_","_Cond",j,names(DataPas[[7]][[j]])[k]))
          addNewLine(rtffile)
          addTable(rtffile, as.data.table(DataPas[[7]][[j]][[k]]));
          addNewLine(rtffile)
        }
      }
    }
    addPlot(rtffile,plot.fun=print,width=6,height=6,res=600, GrpP)
    addNewLine(rtffile)
    addPlot(rtffile,plot.fun=print,width=6,height=6,res=600, Grp2P)
    done(rtffile)
  }
  
  AlmacenGen3<-function(GrpP,Grp2P=GrpP,DataPas, PathDesignP, NmBasP,Typ=1){
    NmFAl<-paste0(PathDesignP,NmBasP)
    if (!dir.exists(NmFAl)) {dir.create(NmFAl)}
    NmFAl<-paste0(NmFAl,"/")
    
    rtffile <- RTF(paste0(NmFAl,NmBasP,"AllStats.doc"))
    if (length(DataPas)<2 & Typ==1){
        write.csv2(as.data.table(DataPas[[1]]),paste0(NmFAl,NmBasP,"ResStat",1,"_",names(DataPas)[1],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[1]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[1]]));
        addNewLine(rtffile)
    }
    if (length(DataPas)>2 & Typ==2){
      for (i in 1:6) {
        write.csv2(as.data.table(DataPas[[i]]),paste0(NmFAl,NmBasP,"ResStat",i,"_",names(DataPas)[i],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[i]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[i]]));
        addNewLine(rtffile)  
      }
    }
    
    cont<-6
    if (length(DataPas)>2 & Typ==1){
      for (i in 3:length(DataPas)) {
        write.csv2(as.data.table(DataPas[[i]]),paste0(NmFAl,NmBasP,"ResStat",i,"_",names(DataPas)[i],".csv"))
        addText(rtffile,paste0("Overall_",names(DataPas)[i]))
        addNewLine(rtffile)
        addTable(rtffile, as.data.table(DataPas[[i]]));
        addNewLine(rtffile)
      }
    }
    if (length(DataPas)>2 & Typ==2){
      for (j in 1:length(DataPas[[7]])) {
        for (k in 1:length(DataPas[[7]][[j]])) {
          cont<-cont+1
          write.csv2(as.data.table(DataPas[[7]][[j]][[k]]),paste0(NmFAl,NmBasP,"ResStat",cont,"_Cond",j,
                                                                  names(DataPas[[7]][[j]])[k],".csv"))
          addText(rtffile,paste0("Simple Effect A*B on Time_","_Cond",j,names(DataPas[[7]][[j]])[k]))
          addNewLine(rtffile)
          addTable(rtffile, as.data.table(DataPas[[7]][[j]][[k]]));
          addNewLine(rtffile)
        }
      }
    }
    done(rtffile)
  }
  
  Kbl3<-function(ResPas,lbl) {
      ResPas %>%
      kbl(caption = lbl,digits=4,escape = F, align = "c")  %>%
      kable_paper("hover", bootstrap_options = c("striped", "hover", "condensed", "responsive"),full_width = F,font_size = 10)
    }
  
```

```{r ResCtrl1, eval=F}
    # Results
    plot(Grp)
    plot(Grp2) # Only this graph is printed in the html file.
    ResGen  # Lean option to view the results of statistical analysis
    
    Kbl3(ResGen[[1]], "Omnibus AOV. Design 2x2");cat("\n")
    Kbl3(ResGen[[2]], "Simple Effects Age-Sleep. Design 2x2")
    Kbl3(ResGen[[3]], "Extense Simple Effects Age-Sleep. Design 2x2")
```
```{r ResCtrl2, eval=F}
    # Results
    plot(Grp)
    plot(Grp2) # Only this graph is printed in the html file.
    ResGen  # Lean option to view the results of statistical analysis
    
    Kbl3(ResGen[[1]], "Omnibus AOV. Design 2x(5xS)");cat("\n")
    Kbl3(ResGen[[2]], "Simple Effects Age-Time. Design 2x(5xS)")
    Kbl3(ResGen[[3]], "Main Effects of Time. Design 2x(5xS)")
```
```{r ResCtrl3, eval=F}
    # Results
    plot(Grp)
    plot(Grp2) # Only this graph is printed in the html file.
    GrpO
    plot(Grp3)
    ResGen # Lean option to view the results of statistical analysis
    
    Kbl3(ResPas = ResGen[[1]], lbl = "Omnibus AOV. Design 2x2x(4xS)");cat("\n")
    Kbl3(ResGen[[2]], "Interaction Age-Sleep. Design 2x2x(4xS)")
    Kbl3(ResGen[[3]], "Interaction Age-Time. Design 2x2x(4xS)")
    Kbl3(ResGen[[4]], "Interaction Sleep-Time. Design 2x2x(4xS)")
    Kbl3(ResGen[[5]], "Main Effect Time. Design 2x2x(4xS)")
    Kbl3(ResGen[[6]], "Simple Effect Time each Age-Sleep condition. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[1]][[1]], "Simple Effect Age-Sleep on Time=1 Omnibus AOV. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[1]][[2]], "Simple Effect Age-Sleep on Time=1 Simple Effects. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[1]][[3]], "Simple Effect Age-Sleep on Time=1 Extense Simple Effects. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[2]][[1]], "Simple Effect Age-Sleep on Time=2 Omnibus AOV. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[2]][[2]], "Simple Effect Age-Sleep on Time=2 Simple Effects. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[2]][[3]], "Simple Effect Age-Sleep on Time=2 Extense Simple Effects. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[3]][[1]], "Simple Effect Age-Sleep on Time=3 Omnibus AOV. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[3]][[2]], "Simple Effect Age-Sleep on Time=3 Simple Effects. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[3]][[3]], "Simple Effect Age-Sleep on Time=3 Extense Simple Effects. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[4]][[1]], "Simple Effect Age-Sleep on Time=4 Omnibus AOV. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[4]][[2]], "Simple Effect Age-Sleep on Time=4 Simple Effects. Design 2x2x(4xS)")
    Kbl3(ResGen[[7]][[4]][[3]], "Simple Effect Age-Sleep on Time=4 Extense Simple Effects. Design 2x2x(4xS)")
```
```{r ResCtrl4, eval=F}
    # Results
    plot(Grp)
    plot(Grp2) # Only this graph is printed in the html file.
    GrpO
    plot(Grp3)
    ResGen # Lean option to view the results of statistical analysis
    
    Kbl3(ResPas = ResGen[[1]], lbl = "Omnibus AOV. Design 2x2x(5xS)");cat("\n")
    Kbl3(ResGen[[2]], "Interaction Age-Sleep. Design 2x2x(5xS)")
    Kbl3(ResGen[[3]], "Interaction Age-Time. Design 2x2x(5xS)")
    Kbl3(ResGen[[4]], "Interaction Sleep-Time. Design 2x2x(5xS)")
    Kbl3(ResGen[[5]], "Main Effect Time. Design 2x2x(5xS)")
    Kbl3(ResGen[[6]], "Simple Effect Time each Age-Sleep condition. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[1]][[1]], "Simple Effect Age-Sleep on Time=1 Omnibus AOV. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[1]][[2]], "Simple Effect Age-Sleep on Time=1 Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[1]][[3]], "Simple Effect Age-Sleep on Time=1 Extense Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[2]][[1]], "Simple Effect Age-Sleep on Time=2 Omnibus AOV. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[2]][[2]], "Simple Effect Age-Sleep on Time=2 Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[2]][[3]], "Simple Effect Age-Sleep on Time=2 Extense Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[3]][[1]], "Simple Effect Age-Sleep on Time=3 Omnibus AOV. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[3]][[2]], "Simple Effect Age-Sleep on Time=3 Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[3]][[3]], "Simple Effect Age-Sleep on Time=3 Extense Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[4]][[1]], "Simple Effect Age-Sleep on Time=4 Omnibus AOV. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[4]][[2]], "Simple Effect Age-Sleep on Time=4 Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[4]][[3]], "Simple Effect Age-Sleep on Time=4 Extense Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[5]][[1]], "Simple Effect Age-Sleep on Time=5 Omnibus AOV. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[5]][[2]], "Simple Effect Age-Sleep on Time=5 Simple Effects. Design 2x2x(5xS)")
    Kbl3(ResGen[[7]][[5]][[3]], "Simple Effect Age-Sleep on Time=5 Extense Simple Effects. Design 2x2x(5xS)")
```
```{r ResCtrl5, eval=F}
    # Results
    plot(Grp)
    plot(Grp2) # Only this graph is printed in the html file.
    ResGen  # Lean option to view the results of statistical analysis
    
    Kbl3(ResGen[[1]], "Omnibus AOV Design 2x(4xS)");cat("\n")
    Kbl3(ResGen[[2]], "Simple Effects Age-Time Design 2x(4xS)")
    Kbl3(ResGen[[3]], "Main Effects Time Design 2x(4xS)")
```
```{r ResCtrl6, eval=F}
    
    # Results
    plot(Grp)
    plot(Grp2) # Only this graph is printed in the html file.
    plot(Grp3)
    GrpO
    ResGen # Lean option to view the results of statistical analysis
    
    Kbl3(ResPas = ResGen[[1]], lbl = "Omnibus AOV. Design 2x2x(2xS)");cat("\n")
    Kbl3(ResGen[[2]], "Interaction Age-Sleep. Design 2x2x(2xS)")
    Kbl3(ResGen[[3]], "Interaction Age-Time. Design 2x2x(2xS)")
    Kbl3(ResGen[[4]], "Interaction Sleep-Time. Design 2x2x(2xS)")
    Kbl3(ResGen[[5]], "Main Effect Time. Design 2x2x(2xS)")
    Kbl3(ResGen[[6]], "Simple Effect Time each Age-Sleep condition. Design 2x2x(2xS)")
    Kbl3(ResGen[[7]][[1]][[1]], "Simple Effect Age-Sleep on Time=1 Omnibus AOV. Design 2x2x(2xS)")
    Kbl3(ResGen[[7]][[1]][[2]], "Simple Effect Age-Sleep on Time=1 Simple Effects. Design 2x2x(2xS)")
    Kbl3(ResGen[[7]][[1]][[3]], "Simple Effect Age-Sleep on Time=1 Extense Simple Effects. Design 2x2x(2xS)")
    Kbl3(ResGen[[7]][[2]][[1]], "Simple Effect Age-Sleep on Time=2 Omnibus AOV. Design 2x2x(2xS)")
    Kbl3(ResGen[[7]][[2]][[2]], "Simple Effect Age-Sleep on Time=2 Simple Effects. Design 2x2x(2xS)")
    Kbl3(ResGen[[7]][[2]][[3]], "Simple Effect Age-Sleep on Time=2 Extense Simple Effects. Design 2x2x(2xS)")
```

***   

# **Figure 1. Object place recognition (OPR) behavioral performance**  

***   

> **Figure 1.** Object place recognition (OPR) behavioral performance. A) Schematic of behavioral design. B) Percent change in preference for displaced object [number of animals (n): young control (YC): n=16, young SD (YSD): n=15, old control (OC): n=13, old SD (OSD): n=15]. C) Percent change in preference for the unmoved objects. D) Total time of object exploration during training and testing in seconds (s). E) Percent change in preference for displaced object excluding trial 1. F) Percent change in preference for displaced object in young (n=7) and old (n=7) mice receiving delayed SD, 5 hr after training (YSD: n=6, OSD: n=7). G) Levels of plasma corticosterone in control (young: n=5; old: n=5) and SD (young: n=5; old: n=6) mice. In all Figures data are graphed using Box Plots according to robust statistics based on the median. The inner line corresponds to the median, the lower box represents the first quartile, the upper box the third quartile, and the extending lines, known as whiskers, represent the minimum and maximum, showing the extent of variability. The diamond represents the trimmed mean (e.g., adjusted average without outliers) used for analysis, which was set at 0.2, according to robust statistics recommendations (Wilcox, 2012) for all age groups and sleep conditions. T1-T3: training trials. Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Figure 1.   


***   



## Fig 1B Percent change in preference for displaced object {Design 2x2}   
```{r F1B, }
  NmBas="Fig1B OPR"
  ResGen<-NA

  rrt<-ExData.2(nmF = paste0(PathDesign,"OPR.csv"),Vars = c(1:3))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  #Graphs 
  Grp<- Grph.2(DatDT,"OPR",LblsP =c("Preference for Displaced Object", "","% Change in Object Preference"),c(-40,50),T)

  Grp2<- Grp + geom_signif(annotation="*",
              y_position=50, xmin=1  , xmax=2, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation="*",
              y_position=40, xmin=3  , xmax=4, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)+
    geom_signif(annotation="*",
              y_position=35, xmin=1  , xmax=3, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)+
    geom_signif(annotation="*",
              y_position=45, xmin=2  , xmax=4, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)
    
    # AOV & Simple Effects
    names(rrt$DT)[3]<-"DepV"
    ResGen<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
    AlmacenGen(Grp,Grp2,ResGen,PathDesign,NmBas,Typ=1)
    
    <<ResCtrl1>>
```   
   
   
## Fig 1C Percent change in preference for the unmoved objects {Design 2x2}   
```{r F1C, }
  NmBas="Fig1C PreferenceUnmoved"
  ResGen<-NA
  
  rrt<-ExData.2(nmF = paste0(PathDesign,"Preference.csv"),Vars = c(1:3))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  #Graphs
  Grp<- Grph.2(DatDT,"Preference",LblsP =c("Preference for Unmoved Objects", "","% Change in Object Preference"),c(-25,25),T)
  
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=17, xmin=1  , xmax=2, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation="*",
              y_position=12, xmin=3  , xmax=4, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)+
    geom_signif(annotation="*",
              y_position=10, xmin=1  , xmax=3, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)+
    geom_signif(annotation="*",
              y_position=15, xmin=2  , xmax=4, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)
  
  
    # AOV & Simple Effects
    names(rrt$DT)[3]<-"DepV"
    ResGen<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
    AlmacenGen(Grp,Grp2,ResGen,PathDesign,NmBas,Typ=1)
    
    <<ResCtrl1>>
```   
   
   
## Fig 1D Total time of object exploration during training and testing in seconds (s) {Design 2x2x(4xS)}   
```{r F1D, }
  NmBas="Fig1D ObjectExploration"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"Exploration Final.csv"),Vars = c(1:7),vIntP =c(4:7),lvlCh = list("T1"="T1","T2"="T2","T3"="T3","Test"="Test" ))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:4) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Exploration Final.csv"),Vars = c(1:2,(3+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  #Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Total Object Exploration Time (s)"),ylmP =c(0,100),hLin = F,lvIp = 4,wMain = F)
  
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + 
    geom_signif(annotation=c("","","*"),
              y_position=c(95,95,100),
              xmin=c(levBp[1],levBp[1+5], mean(levBp[c(1,4)])),
              xmax=c(levBp[4],levBp[4+5], mean(levBp[c(1+5,4+5)])), 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)+
    geom_signif(annotation=c("","","*"),
              y_position=c(95,95,100),
              xmin=c(levBp[1+10],levBp[1+15], mean(levBp[c(1+10,1+15)])),
              xmax=c(levBp[4+10],levBp[4+15], mean(levBp[c(1+15,4+15)])), 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)
   
  #AOV
  names(rrt$DT)[4:7]<-c("T1","T2","T3","T4")
  ResGen<-AOVMx2(A=2,B=2,C=4,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Object Exploration", "D","Total Object Exploration Time (s)"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "D","Total Object Exploration Time (s)"),ylmP =c(0,100),hLin = F,lvIp = 5,wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    <<ResCtrl3>>
```

## Fig 1E Percent change in preference for displaced object excluding trial 1 {Design 2x2}   
```{r F1E, }
  NmBas="Fig1E OPRWithoutT1"
  ResGen<-NA
  
  rrt<-ExData.2(nmF = paste0(PathDesign,"OPR.csv"),Vars = c(1:2,4))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  #Graphs
  Grp<- Grph.2(DatDT,"OPRSinT1",LblsP =c("Preference for Displaced Object", "","% Change in Object Preference"),c(-40,50),T)
  
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=50, xmin=1  , xmax=2, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation="*",
              y_position=40, xmin=3  , xmax=4, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)+
    geom_signif(annotation="*",
              y_position=35, xmin=1  , xmax=3, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)+
    geom_signif(annotation="*",
              y_position=45, xmin=2  , xmax=4, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)
  
    # AOV & Simple Effects
    names(rrt$DT)[3]<-"DepV"
    ResGen<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
    AlmacenGen(Grp,Grp2,ResGen,PathDesign,NmBas,Typ=1)
    
    <<ResCtrl1>>
```

## Fig 1F Percent change in preference for displaced object in young and old mice receiving delayed SD 5 hr after training {Design 2}   
```{r F1F, }
  NmBas="Fig1F OPRDelayed"
  
  DatDTFull <- data.table(read.table(paste0(PathDesign,"OPRDelayed.csv"), header=TRUE, sep=";",
                                     na.strings="NA", dec=",",strip.white=TRUE))
  DatDT<-DatDTFull
  DatDT$Group<-factor(DatDT$Group);DatDT$Group<-relevel(DatDT$Group,"Young_DSR")
  
  #Graphs
  Grp<- Grph.1(DatDT,"OPRDelayed",LblsP =c("Preference for Displaced Object", "","% Change in Object Preference"),c(-10,15),T,GrpSel=c(2,4))
  
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=15, xmin=1  , xmax=2, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)
    
  YuenRes<-WRS2::yuen(OPRDelayed~Group,DatDT)
  ResFn<-list()
  ResFn$AOV<-data.table(with(YuenRes, cbind(diff=round(diff,2),df=round(df,2),test=round(test,2),EffSize=round(effsize,2),p=round(p.value,4))))
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResFn,PathDesignP = PathDesign,NmBasP = NmBas,Typ = 1)
  
  #Results
    plot(Grp)
    plot(Grp2)
    ResFn
```

## Fig 1G Levels of plasma corticosterone in control and SD mice {Design 2x2}   
```{r F1G, }
  NmBas="Fig1G Cortisol"
  ResGen<-NA
  
  rrt<-ExData.2(nmF = paste0(PathDesign,"Cortisol.csv"),Vars = c(1:4))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  #Graphs
  Grp<- Grph.2(DatDT,"cortisol",LblsP =c("Preference for Displaced Object", "","Corticosterone (ng/ml)"),c(0,200),F)
  
  Grp2<-Grp + 
    geom_signif(annotation=c("","","*"),
              y_position=c(190,195,200),
              xmin=c(1,2, 1.9),
              xmax=c(3,4, 3), 
              tip_length = c(c(0.02, 0.02),c(0.02, 0.02),c(0.08, 0.02)),vjust=0.5,textsize=10)

  # AOV & Simple Effects
  names(rrt$DT)[4]<-"DepV"
  ResGen<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
  AlmacenGen(Grp,Grp2,ResGen,PathDesign,NmBas,Typ=1)
  
  <<ResCtrl1>>
```   
    
    
***   
   

# **Figure 2. Rate and global remapping across sessions and percentage.**   

***   

> **Figure 2.** Rate and global remapping across sessions and percentage of different cell types during OPR performance. A) OPR performance comparing tetrode, EEG/EMG and all implanted animals. B) Isolation distance showing absence of differences in spike cluster quality across conditions over time. C) Average rate remapping for all groups across trials. Young controls and old SD mice displayed higher rate remapping during the test trial in comparison to the last training trial (T3). Additionally, these groups also displayed more rate remapping than young SD mice during the test. D) Average global remapping (map similarity) for all groups across trials. Old animals displayed more remapping (i.e., instability) than young mice between the habituation and trial 1 and during testing. E-F) Percentage of context, object configuration, and unstable cells recorded in young (E) and old (F) mice. Young controls: 6 mice, 60 cells, range of cells per animal: 6-16, young SD: 4 mice, 50 cells, range of cells per animal: 8-18, old control: 5 mice, 36 cells, range of cells per animal: 5-13, old SD: 5 mice, 41 cells: range of cells per animal: 4-13. Hab: habituation, T1-T3: training trials. Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Figure 2.   

***   
   
## Fig 2A OPR performance comparing tetrode, EEG/EMG and all implanted animals {Design 2x2x2}   
```{r F2A, }

    NmBas="Fig2A CompareTetrodeEEG"
    NmFich="OPR.csv";
    NmFAlL<-paste0(PathDesign,NmBas)
    if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
    NmFAlL<-paste0(NmFAlL,"/")
    
    NmFich<-paste0(PathDesign,NmFich);
    DatDTFull <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
    DatDTFull$Age<-factor(DatDTFull$Age);DatDTFull$Age<-relevel(DatDTFull$Age,"Young")
    DatDTFull$Sleep<-factor(DatDTFull$Sleep);levels(DatDTFull$Sleep) <- list("Control"="control", "SR"="restriction")
    DatDTFull$Implant<-factor(DatDTFull$Implant);DatDTFull$Implant<-relevel(DatDTFull$Implant,"Tetrode")
    setkey(DatDTFull,Age,Sleep,Implant)
    
    ArP3w<-unlist(unlist(lapply(1:2, function (x) lapply(1:2, function(y) lapply(1:2, function(z) na.omit(DatDTFull[.(levels(DatDTFull$Age)[x],levels(DatDTFull$Sleep)[y],levels(DatDTFull$Implant)[z]),3,with=F][[1]])))),recursive = F),recursive = F)
                        

    ResRo<-list()
    RsRb<-t3way(2,2,2,ArP3w)
    
    ExRsRbp<-with(RsRb, round(c(A.p.value, B.p.value,C.p.value, AB.p.value, AC.p.value, BC.p.value, ABC.p.value),4))
    ExRsRbQ<-with(RsRb, round(c(Qa, Qb,Qc, Qab, Qac, Qbc, Qabc),2))
    ExFn<-data.table(ExRsRbQ,ExRsRbp)
    names(ExFn)<-c("Q","p")
    ExFnFn<-data.table(Names=c("Age","Sleep","Implant","Age*Sleep","Age*Implant","Sleep*Implant","Age*Sleep*Implant"),ExFn)
   
    #write.csv2(ExFnFn,paste0(NmFAlL,NmBas,"Omn.csv"))
    DatDTCop<-copy(DatDTFull)
    names(DatDTCop)[3]<-"DepVar"
    Grp<- Grph.3d(DatP = DatDTCop,"OPR",LblsP =c("Preference for Unmoved Objects", "","% Change in Object Preference"),ylmP =c(-40,50),hLin = T,lvIp = 2,wMain = F)
  
    levBp<-seq(0.7, 4, by=0.2)
    Grp2<- Grp + 
    geom_signif(annotation=c("","","*"),
              y_position=c(33,34,35),
              xmin=c(levBp[1],levBp[2], 0.1+mean(levBp[c(1)])),
              xmax=c(levBp[1+5],levBp[2+5], mean(levBp[c(2,2+5)])), 
              tip_length = c(c(0.01, 0.01),c(0.01, 0.01),c(0.02, 0.01)),vjust=0.5,textsize=10) +
    geom_signif(annotation=c("","","*"),
              y_position=c(37,38,39),
              xmin=c(levBp[3],levBp[4], 0.1+mean(levBp[c(3)])),
              xmax=c(levBp[3+5],levBp[4+5], mean(levBp[c(4,4+5)])), 
              tip_length = c(c(0.01, 0.01),c(0.01, 0.01),c(0.02, 0.01)),vjust=0.5,textsize=10) +
    geom_signif(annotation=c("","","*"),
              y_position=c(41,42,43),
              xmin=c(levBp[1],levBp[3], 0.1+mean(levBp[c(1)])),
              xmax=c(levBp[1+5],levBp[3+5], mean(levBp[c(3,3+5)])), 
              tip_length = c(c(0.01, 0.01),c(0.01, 0.01),c(0.02, 0.01)),vjust=0.5,textsize=10) +
    geom_signif(annotation=c("","","*"),
              y_position=c(45,46,47),
              xmin=c(levBp[2],levBp[4], 0.1+mean(levBp[c(2)])),
              xmax=c(levBp[2+5],levBp[4+5], mean(levBp[c(4,4+5)])), 
              tip_length = c(c(0.01, 0.01),c(0.01, 0.01),c(0.02, 0.01)),vjust=0.5,textsize=10)
    
    ExtendDTCol<-copy(DatDTCop)
    ExtendDTCol$Implant<-"All"
    ExtendDTCol<-data.table(rbind(DatDTCop,ExtendDTCol))
    
    Grp3<- Grph.3c(DatP = ExtendDTCol,"OPR",LblsP =c("Preference for Unmoved Objects", "","% Change in Object Preference"),ylmP =c(-40,50),hLin = T,lvIp = 3,wMain = F)
    
    ResFn<-list()
    ResFn$AOV<-ExFnFn
    AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResFn,PathDesignP = PathDesign,NmBasP = NmBas,Typ = 1)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
    dev.off()
    
    #Results
    plot(Grp)
    plot(Grp2)
    plot(Grp3)
    ResFn
    
    Kbl3(ResPas = ResFn[[1]], lbl = "Omnibus AOV. Design 2x2x2")
    
```   
   
   
## Fig 2B Cluster Quality Analysis of Isolation Distance {Design 2x2x(5xS)}   
```{r F2B, }
  NmBas="Fig2B IsolationDistance"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"ClusterQuality.csv"),Vars = c(1,5,6,7:11),vIntP =c(4:8),lvlCh = list("HAB"="id_s1", "T1"="id_s2","T2"="id_s3","T3"="id_s4","Test"="id_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # For Simple Effects
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"ClusterQuality.csv"),Vars = c(5:6,(6+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  #Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Cluster Quality", "","Isolation Distance"),ylmP =c(0,40),hLin = F,lvIp=5)
  Grp2=Grp
    
    #AOV
    names(rrt$DT)[4:8]<-c("T1","T2","T3","T4","T5")
    ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Cluster Quality", "H","Isolation Distance"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Cluster Quality", "H","Isolation Distance"),
                 ylmP =c(0,40),hLin = F,lvIp = 6,wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    <<ResCtrl4>>
```   
   
   
## Fig 2C Average rate remapping for all groups across trials {Design 2x2x(4xS)}   
```{r F2C, }
  NmBas="Fig2C RateRemap"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = ,c(1,5,6,32:35),vIntP =c(4:7),lvlCh = list("HABxT1"="RatRemap_Hab.S1", "T1xT2"="RatRemap_S1.S2","T2xT3"="RatRemap_S2.S3","T3xTest"="RatRemap_S3.test"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Para Ef Simples:
  DatEfS<-list()
  for(is in 1:4) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(5,6,(31+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Rate and Global Remapping", "","Rate Remapping (Hz)"),ylmP =c(0,6),hLin = F,lvIp = 4)
  
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=5, xmin=levBp[1+15]  , xmax=levBp[2+15], 
              tip_length = c(0.02, 0.02),textsize=6) +
    geom_signif(annotation="*",
              y_position=5.2, xmin=levBp[2+15]  , xmax=levBp[4+15], 
              tip_length = c(0.02, 0.02),textsize=6)+
    geom_signif(annotation="*",
              y_position=4.8, xmin=levBp[1+10]  , xmax=levBp[1+15], 
              tip_length = c(0.02, 0.02),textsize=6)+
    geom_signif(annotation="*",
              y_position=5.5, xmin=levBp[4+10]  , xmax=levBp[4+15], 
              tip_length = c(0.02, 0.02),textsize=6)
  
    #AOV
    names(rrt$DT)[4:7]<-c("T1","T2","T3","T4")
    ResGen<-AOVMx2(A=2,B=2,C=4,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Rate and Global Remapping", "A","Rate Remapping (Hz)"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
  
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Rate and Global Remapping", "A","Rate Remapping (Hz)"),ylmP=c(0,6), hLin = F,lvIp = 5,wMain = T)
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()

    <<ResCtrl3>>
```   
   

## Fig 2D Average global remapping (map similarity) for all groups across trials {Design 2x2x(4xS)}   
```{r F2D, }
  NmBas="Fig2D GlobalRemapAllCells"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.2b(nmF = paste0(PathDesign,"Cell_types (ANOVA_Overall_correlations).csv"),Vars = ,c(3,4,12,7:10),vIntP =c(4:7),lvlCh = list("HABxT1"="s1xs2", "T1xT2"="s2xs3","T2xT3"="s3xs4","T3xTest"="s4xs5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # For Simple Effects:
  DatEfS<-list()
  for(is in 1:4) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(5,6,(31+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  #Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Rate and Global Remapping", "","Similarity Score"),ylmP =c(-0.5,1),hLin = T,lvIp = 4)
  
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp +
    geom_signif(annotation=c("","","*"),
              y_position=c(0.95,0.95,1),
              xmin=c(levBp[1],levBp[3], mean(levBp[c(1,2)])),
              xmax=c(levBp[2],levBp[4], mean(levBp[c(3,4)])), 
              tip_length = c(0.02, 0.02),vjust = 0.5,textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(0.95,0.95,1),
              xmin=c(levBp[1+15],levBp[3+15], mean(levBp[c(1+15,2+15)])),
              xmax=c(levBp[2+15],levBp[4+15], mean(levBp[c(3+15,4+15)])), 
              tip_length = c(0.02, 0.02),vjust = .5,textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(0.8,0.82,0.85),
              xmin=c(levBp[1+15],levBp[2+15], mean(levBp[c(1+15,3+15)])-.1),
              xmax=c(levBp[3+15],levBp[4+15], mean(levBp[c(2+15,4+15)])), 
              tip_length = c(0.02, 0.02),vjust = .5,textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(-0.45,-0.45,-0.5),
              xmin=c(levBp[1],levBp[1+5], mean(levBp[c(1,4)])),
              xmax=c(levBp[4],levBp[4+5], mean(levBp[c(1+5,4+5)])), 
              tip_length = c(-0.02, -0.02),vjust = 2,textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(-0.45,-0.45,-0.5),
              xmin=c(levBp[1+10],levBp[1+15], mean(levBp[c(1+10,4+10)])),
              xmax=c(levBp[4+10],levBp[4+15], mean(levBp[c(1+15,4+15)])), 
              tip_length = c(-0.02, -0.02),vjust = 2,textsize=6)
  
    #AOV
    names(rrt$DT)[4:7]<-c("T1","T2","T3","T4")
    ResGen<-AOVMx2(A=2,B=2,C=4,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Rate and Global Remapping", "B","Similarity Score"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Rate and Global Remapping", "B","Similarity Score"),ylmP=c(-0.5,1), hLin = T,lvIp = 5,wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    <<ResCtrl3>>
```
   
***   


   
   
# **Figure 3. Cell-type remapping across sessions during performance in the OPR task.**   

***   

> **Figure 3.** Cell-type remapping across sessions during performance in the OPR task. A) Schematic indicating how similarity scores were computed. B-D) Average global remapping of context (B), object configuration (C), and unstable (D) cells across trials and corresponding examples of color-coded place cell rate maps, trajectory spike maps, and waveforms. Context cells are only unstable in the old control group, suggesting that poor performance in this group stems from inability to recall the context. Conversely, object configuration cells, which by definition remap when the objects are introduced, display intermediate levels of stability in young controls and old SD, the groups that show successful performance in the OPR task. Conversely, poor OPR performance is associated with either too much object configuration stability (young SD animals) or too much object configuration instability (old controls). No differences across conditions and/or time were observed in unstable cells. Blue indicates that the animal has visited the region but the cell has not fired, vivid colors indicate high neuronal activity (as shown in the color bar at the upper right corner). Number on top of each map represents peak firing rate (Hz) used to normalize the map colors. Red dots on the trajectory maps indicate location of action potentials. Waveform similarity indicates recording stability during the 24 hr period of training and testing. Context cells: Young controls (YC=23 cells), young SD (YSD=20 cells), old control (OC=8 cells), old SD (OSD=9 cells). Object cells: Young control (YC: 15 cells), young SD (YSD: 13 cells), old control (OC: 17 cells), old SD (OSD: 14 cells). Unstable cells:  Young control (YC=22 cells), young SD (YSD=17 cells), old control (OC=11 cells), old SD (OSD=18 cells). Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Figure 3.   

***   

## Fig 3B Average global remapping of context cells {Design 2x2x(4xS)}   
```{r F3B, }
  NmBas="Fig3B ContextCells"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
    
  rrt<-ExDataIS.3(nmF = paste0(PathDesign,"Cell_types (ANOVA_Overall_correlations).csv"),Vars = ,c(3,4,12,7:10),vIntP =c(4:7),lvlCh = list("HABxT1"="s1xs2", "T1xT2"="s2xs3","T2xT3"="s3xs4","T3xTest"="s4xs5"),TypCel = "Context")
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # For Simple Effects:
  DatEfS<-list()
  for(is in 1:4) {
    DatEfS[[is]]<-ExData.2b(nmF = paste0(PathDesign,"Cell_types (ANOVA_Overall_correlations).csv"),Vars = c(3:4,(6+is)),TypCel = "Context")
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }

  # Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Cell-Type Remapping Context Cells", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 4)
  
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=0.95, xmin=levBp[1+15]  , xmax=levBp[3+15], 
              tip_length = c(0.02, 0.02),textsize=6) +
    geom_signif(annotation="*",
              y_position=0.8, xmin=levBp[3+15]  , xmax=levBp[4+15], 
              tip_length = c(0.02, 0.02),textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(0.3,0.3,0.25),
              xmin=c(levBp[1],levBp[1+5], mean(levBp[c(1,2)])),
              xmax=c(levBp[2],levBp[2+5], mean(levBp[c(1+5,2+5)])), 
              tip_length = c(-0.02, -0.02),vjust=2,textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(0.3,-0.35,-0.4),
              xmin=c(levBp[1+10], levBp[1+15], mean(levBp[c(1+10,4+10)])),
              xmax=c(levBp[4+10], levBp[4+15], mean(levBp[c(1+15,4+15)])), 
              tip_length = c(c(-0.02, -0.02),c(-0.02, -0.02),c(-.52, -0.02)),vjust=14,textsize=6)
  
  #AOV
  names(rrt$DT)[4:7]<-c("T1","T2","T3","T4")
  ResGen<-AOVMx2(A=2,B=2,C=4,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  
  AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Cell-Type Remapping Context Cells", "B","Similarity Score"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Cell-Type Remapping Context Cells", "B","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 5,wMain = T)
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
  
    <<ResCtrl3>>
```

## Fig 3C Average global remapping of object configuration cells {Design 2x2x(4xS)}   
```{r F3C, }
  NmBas="Fig3C ObjectCells"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.3(nmF = paste0(PathDesign,"Cell_types (ANOVA_Overall_correlations).csv"),Vars = ,c(3,4,12,7:10),vIntP =c(4:7),lvlCh = list("HABxT1"="s1xs2", "T1xT2"="s2xs3","T2xT3"="s3xs4","T3xTest"="s4xs5"),TypCel = "Object")
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # For  Simple Effects:
  DatEfS<-list()
  for(is in 1:4) {
    DatEfS[[is]]<-ExData.2b(nmF = paste0(PathDesign,"Cell_types (ANOVA_Overall_correlations).csv"),Vars = c(3:4,(6+is)),TypCel = "Object")
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }

  #Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Cell-Type Remapping Object Cells", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 4)
  
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + geom_signif(annotation="#",
              y_position=0.95, xmin=levBp[1+15]  , xmax=levBp[2+15], 
              tip_length = c(0.02, 0.02),textsize=6) +
    geom_signif(annotation="*",
              y_position=0.9, xmin=levBp[2+15]  , xmax=levBp[4+15], 
              tip_length = c(0.02, 0.02),textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(-0.45,0.30,-0.5),
              xmin=c(levBp[1],levBp[1+5], mean(levBp[c(1,4)])),
              xmax=c(levBp[4],levBp[4+5], mean(levBp[c(1+5,4+5)])), 
              tip_length = c(c(-0.02, -0.02),c(-0.02, -0.02),c(-0.02,-.52)),vjust=15.5,textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(0.3,-0.45,-0.5),
              xmin=c(levBp[1+10], levBp[1+15], mean(levBp[c(1+10,4+10)])),
              xmax=c(levBp[4+10], levBp[4+15], mean(levBp[c(1+15,4+15)])), 
              tip_length = c(c(-0.02, -0.02),c(-0.02, -0.02),c(-.52, -0.02)),vjust=15.5,textsize=6)
  
  #AOV
  names(rrt$DT)[4:7]<-c("T1","T2","T3","T4")
  ResGen<-AOVMx2(A=2,B=2,C=4,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Cell-Type Remapping Object Cells", "C","Similarity Score"))

    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Cell-Type Remapping Object Cells", "C","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 5,wMain = T)
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    <<ResCtrl3>>
```
## Fig 3D Average global remapping of unstable cells across trials {Design 2x2x(4xS)}   
```{r F3D, }
  NmBas="Fig3D UnstableCells"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA  

  rrt<-ExDataIS.3(nmF = paste0(PathDesign,"Cell_types (ANOVA_Overall_correlations).csv"),Vars = ,c(3,4,12,7:10),vIntP =c(4:7),lvlCh = list("HABxT1"="s1xs2", "T1xT2"="s2xs3","T2xT3"="s3xs4","T3xTest"="s4xs5"),TypCel = "Unstable")
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # For Simple Effects:
  DatEfS<-list()
  for(is in 1:4) {
    DatEfS[[is]]<-ExData.2b(nmF = paste0(PathDesign,"Cell_types (ANOVA_Overall_correlations).csv"),Vars = c(3:4,(6+is)),TypCel = "Unstable")
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  # Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Cell-Type Remapping Unstable Cells", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 4)
  Grp2=Grp
  
  #AOV
  names(rrt$DT)[4:7]<-c("T1","T2","T3","T4")
  ResGen<-AOVMx2(A=2,B=2,C=4,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Cell-Type Remapping Unstable Cells", "D","Similarity Score"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Cell-Type Remapping Unstable Cells", "D","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 5,wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()

    <<ResCtrl3>>
```
      
      
# **Figure 4. Place cell stability during unmoved object control task**      

***   

> **Figure 4.** Place cell stability during unmoved object control task. A) Schematics of the task. B) Isolation distance showing absence of differences in spike cluster quality across conditions over time. C-E) Examples of context (C), object configuration (D), and unstable (D) rate maps, trajectory spike maps, and waveforms recorded from young and old control mice trained in the unmoved object control task. Context and object configuration cells recorded in young mice were more stable during the test than those recorded in old controls. Unstable cells did not show differences across groups and/or time. Blue indicates that the animal has visited the region but the cell has not fired, vivid colors indicate high neuronal activity (as shown in the color bar at the upper right corner). Number on top of each map represents peak firing rate (Hz) used to normalize the map colors. Red dots on the trajectory maps indicate location of action potentials. Waveform similarity indicates recording stability during the 24 hr period of training and testing. Young: 3 mice, 30 cells, old: 4 mice, 24 cells. Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Figure 4.   

***   
   
## Fig 4B Unmoved Isolation distance {Design 2x(5xS)}
```{r F4B, }
  NmBas="Fig4B UnMovedIsolationDistance"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
    
  rrt<-ExDataIS.3c(nmF = paste0(PathDesign,"ClusterQualityNonMovedControl.csv"),Vars = ,c(4,5,1,6:10),vIntP =c(4:8),lvlCh = list("HAB"="id_s1", "T1"="id_s2","T2"="id_s3","T3"="id_s4","Test"="id_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  #Graphs
  Grp<- Grph.3b(DatP = ExtendDT,"OPR",LblsP =c("Cluster Quality", "","Isolation Distance"),ylmP =c(0,40),hLin = F,lvIp = 5,GrpSel = c(1,3))

  Grp2=Grp
  
  #AOV
  names(rrt$DT)[3:7]<-c("T1","T2","T3","T4","T5")
  ResGen<-AOVMx2b(A=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
   # Other Graphs
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<- Grph.3b(DatP = ExtendDTCol,"OPR",LblsP =c("Cluster Quality", "","Isolation Distance"),ylmP =c(0,40),hLin = F,lvIp = 6,GrpSel = c(1,3),wMain = T)
    
    ExtendCpy<-copy(ExtendDT)
    names(ExtendCpy)[1]<-"Age"
    GrpO<-Grph.3.Otrosb(ExtendDTp = ExtendCpy,LblsP =c("Cluster Quality", "","Isolation Distance"))
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()

    <<ResCtrl2>>
```   
   
   
## Fig 4C Unmoved Controls Global Remapping Context Cells {Design 2x(4xS)}   
```{r F4C, warning=F,message=F}
  NmBas="Fig4C UnMovedContextCells"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA

  rrt<-ExDataIS.3b(nmF = paste0(PathDesign,"NonMovedControls Final.csv"),Vars = ,c(3,4,12,7:10),vIntP =c(4:7),lvlCh = list("HABxT1"="s1xs2", "T1xT2"="s2xs3","T2xT3"="s3xs4","T3xTest"="s4xs5"),TypCel = "Context")
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  #Graphs
  Grp<- Grph.3b(DatP = ExtendDT,"OPR",LblsP =c("Unmoved Object Control Context Cells", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 4,GrpSel = c(1,3))
  
  levBp<-seq(0.82, 25, by=4/12)
  Grp2<- Grp + 
    geom_signif(annotation=c("*"),
              y_position=c(1),
              xmin=c(levBp[9+1]),
              xmax=c(levBp[9+2]), 
              tip_length = c(.02,.4),vjust=0.5,textsize=10) +
      geom_signif(annotation=c("","","*"),
              y_position=c(-.25,-.25,-.3),
              xmin=c(levBp[6+1],levBp[9+1], mean(levBp[c(6+1,6+2)])),
              xmax=c(levBp[6+2],levBp[9+2], mean(levBp[c(9+1,9+2)])), 
              tip_length = c(c(-0.65,-0.4,-0.4,-0.02),c(-.04,-.04)),vjust=2,textsize=10)
  
  #AOV
  names(rrt$DT)[3:6]<-c("T1","T2","T3","T4")
  ResGen<-AOVMx2b(A=2,C=4,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
  # Other Graphs
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<- Grph.3b(DatP = ExtendDTCol,"OPR",LblsP =c("Unmoved Object Control Context Cells", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 5,GrpSel = c(1,3),wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
    dev.off()
  
  <<ResCtrl5>>
```   
   
   
## Fig 4D Unmoved Controls Global Remapping Object configuration Cells {Design 2x(4xS)}   
```{r F4D, }
  NmBas="Fig4D UnMovedObjectCells"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA

  rrt<-ExDataIS.3b(nmF = paste0(PathDesign,"NonMovedControls Final.csv"),Vars = ,c(3,4,12,7:10),vIntP =c(4:7),lvlCh = list("HABxT1"="s1xs2", "T1xT2"="s2xs3","T2xT3"="s3xs4","T3xTest"="s4xs5"),TypCel = "Object")
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  Grp<- Grph.3b(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 4,GrpSel = c(1,3))
  
  levBp<-seq(0.82, 25, by=4/12)
  Grp2<- Grp + geom_signif(annotation=c("*"),
              y_position=c(1),
              xmin=c(levBp[9+1]),
              xmax=c(levBp[9+2]), 
              tip_length = c(.02,.02),vjust=0.5,textsize=6)
   
  #AOV
  names(rrt$DT)[3:6]<-c("T1","T2","T3","T4")
  ResGen<-AOVMx2b(A=2,C=4,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
  # Other Graphs
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<- Grph.3b(DatP = ExtendDTCol,"OPR",LblsP =c("Unmoved Object Control Context Cells", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 5,GrpSel = c(1,3),wMain = T)
    

    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
    dev.off()
  
    <<ResCtrl5>>
```

## Fig 4E Unmoved Controls Global Remapping Unstable Cells {Design 2x(4xS)}   
```{r F4E, }
  NmBas="Fig4E UnMovedUnstableCells"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA

  rrt<-ExDataIS.3b(nmF = paste0(PathDesign,"NonMovedControls Final.csv"),Vars = ,c(3,4,12,7:10),vIntP =c(4:7),lvlCh = list("HABxT1"="s1xs2", "T1xT2"="s2xs3","T2xT3"="s3xs4","T3xTest"="s4xs5"),TypCel = "Unstable")
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  Grp<- Grph.3b(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 4,GrpSel = c(1,3))
  Grp2=Grp
   
   #AOV
  # DatEfS Absent because there are are not A*B factorial design
  names(rrt$DT)[3:6]<-c("T1","T2","T3","T4")
  ResGen<-AOVMx2b(A=2,C=4,DatPas = rrt,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
  # Other Graphs
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<- Grph.3b(DatP = ExtendDTCol,"OPR",LblsP =c("Unmoved Object Control Context Cells", "","Similarity Score"),ylmP =c(-0.5,1.2),hLin = T,lvIp = 5,GrpSel = c(1,3),wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
    dev.off()
  
    <<ResCtrl5>>
```   
   

# **Figure 5. Sleep patterns during post-training and recovery sleep in young and old mice.**     
   
***   

> **Figure 5.** Sleep patterns during post-training and recovery sleep in young and old mice. A-C) Percentage of total time (A), number of bouts (B), and bout length (C) in Wake, NREM, and REM during post-training sleep in young and old control mice. D-F) Percentage of total time (D), number of bouts (E), and bout length (F) in Wake, NREM and REM during recovery sleep in control and SD groups. Young control (n=11), young SD (n=11), old control (n=8), old SD (n=10). Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Figure 5.   

***   

 A) Percentage of total time in Wake, NREM, and REM during post-training sleep young-old control mice.
 B) Number of bouts in Wake, NREM, and REM during post-training
 C) Bout length in Wake, NREM, and REM during post-training sleep   
 
##    Fig 5A,B,C Sleep Post Learning {Design 2 MANOVA}   
```{r F5ABC, fig.keep='all'}
  NmBas="Fig5A_B_C PostL"
  NmFich<-paste0(PathDesign,"PostLearn.csv");
  NmFAlL<-paste0(PathDesign,NmBas)
  
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  DatDT <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))

  Nms<-names(DatDT)
  Final=ncol(DatDT)
  VarsS<-c(3:Final)
  NmsSel<-names(DatDT[,VarsS,with=F])
  
  DatDT$Factor<-factor(DatDT$Factor);levels(DatDT$Factor) <- list("Young"="YC", "Old"="OC")
  DatDT$Factor<-relevel(DatDT$Factor,"Young")
  setkeyv(DatDT,c("Factor")) 
  
  ResRo<-list(); rR<-list()
  
	for (i in 3:11) {
	  ArP<-list()
    ArP<-c(lapply(1:2, function (x) na.omit(DatDT[.(levels(DatDT$Factor)[x]),i,with=F][[1]])),recursive = F)
    rR[[i-2]]<-AOVSingle(ArP,2)
	}
  #AOV
  rbResRb22<-data.table(NmsSel,do.call(rbind, lapply(rR, as.data.table)))
  
  #MANOVA  
  NwLst<-list()
	NwLst[[1]]<-DatDT[.("Young"),c(3:5),with=F]
	NwLst[[2]]<-DatDT[.("Old"),c(3:5),with=F]
	ResRo$MANOVA1<-MULAOVp(NwLst,2,3);	MULtr.anova(NwLst,2,3)
	NwLst[[1]]<-DatDT[.("Young"),c(6:8),with=F]
	NwLst[[2]]<-DatDT[.("Old"),c(6:8),with=F]
	MULAOVp(NwLst,2,3);	MULtr.anova(NwLst,2,3)
	ResRo$MANOVA2<-MULAOVp(NwLst,2,3);	MULtr.anova(NwLst,2,3)
	NwLst[[1]]<-DatDT[.("Young"),c(9:11),with=F]
	NwLst[[2]]<-DatDT[.("Old"),c(9:11),with=F]
	MULAOVp(NwLst,2,3);	MULtr.anova(NwLst,2,3)
	ResRo$MANOVA3<-MULAOVp(NwLst,2,3);	MULtr.anova(NwLst,2,3)
	
	write.csv2(rbResRb22,paste0(NmFAlL, NmBas,"AllOmnContr.csv"))
	ResMANOVA<-data.table(rbind(unlist(ResRo$MANOVA1),unlist(ResRo$MANOVA2),unlist(ResRo$MANOVA3)))
	write.csv2(cbind(c("N","Length","Porc"),ResMANOVA),paste0(NmFAlL,NmBas,"AllMANOVA.csv"))
	
# Graphs
# Fig.5A
	NmBas="Fig6A PostL"
	DatDTG<-DatDT[,c(1,2,9:11)]
  setnames(DatDTG, "Factor", "Age")

  DatDTG$Age<-factor(DatDTG$Age);DatDTG$Age<-relevel(DatDTG$Age,"Young")
	DatDTG$Subject<-factor(DatDTG$Subject)
	setkey(DatDTG,Age)
  
  VIntra=3:5
  NmIntra=names(DatDTG[,VIntra,with=F])
  ExtendDT<-reshape(DatDTG,direction = "long",varying = list(3:5),idvar = "Subject",
          timevar=c("Moment"),times=NmIntra)
  colnames(ExtendDT)[4] <- "DepVar"
  
  ExtendDT$Moment<-factor(ExtendDT$Moment)
  levels(ExtendDT$Moment) <- list("WAKE"="Porc_Wake", "NREM"="Porc_NREM","REM"="Porc_REM")
  ExtendDT$Age<-factor(ExtendDT$Age);ExtendDT$Age<-relevel(ExtendDT$Age,"Young")
  
  ExtendDTRel<-copy(ExtendDT)
  names(ExtendDTRel)[2]<-"Group"
  Grp<- Grph.3b(DatP = ExtendDTRel,"OPR",LblsP =c("Sleep Patterns", "","Percent Total Time"),ylmP =c(0,80),hLin = F,lvIp = 3,GrpSel = c(1,3))
  plot(Grp)
  
  png(paste0(NmFAlL,NmBas,"6A.png"),width = 1200, height = 1000)
  plot(Grp)
  dev.off()
  pdf(paste0(NmFAlL,NmBas,"6A.pdf"),family = "ArialMT")
  plot(Grp)
  dev.off() 
  
  
# Fig.5B
  NmBas="Fig6B PostL"
	DatDTG<-DatDT[,c(1:5)]
  setnames(DatDTG, "Factor", "Age")
  
  DatDTG$Age<-factor(DatDTG$Age);DatDTG$Age<-relevel(DatDTG$Age,"Young")
	DatDTG$Subject<-factor(DatDTG$Subject)
	setkey(DatDTG,Age)
  
  VIntra=3:5
  NmIntra=names(DatDTG[,VIntra,with=F])
  ExtendDT<-reshape(DatDTG,direction = "long",varying = list(3:5),idvar = "Subject",
          timevar=c("Moment"),times=NmIntra)
  colnames(ExtendDT)[4] <- "DepVar"
  
  
  ExtendDT$Moment<-factor(ExtendDT$Moment)
  levels(ExtendDT$Moment) <- list("WAKE"="N_Wake", "NREM"="N_NREM","REM"="N_REM")
  ExtendDT$Age<-factor(ExtendDT$Age);ExtendDT$Age<-relevel(ExtendDT$Age,"Young")
  
  ExtendDTRel<-copy(ExtendDT)
  names(ExtendDTRel)[2]<-"Group"
  Grp<- Grph.3b(DatP = ExtendDTRel,"OPR",LblsP =c("Sleep Patterns", "","Number of Bouts"),
                ylmP =c(0,200),hLin = F,lvIp = 3,GrpSel = c(1,3))
  plot(Grp)
  
  levBp<-seq(0.8, 6, by=0.34)
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=180, xmin=levBp[4]  , xmax=levBp[5], 
              tip_length = c(0.45, 0.02),vjust=0.5,textsize=10)+
              geom_signif(annotation="*",
              y_position=105, xmin=levBp[7]  , xmax=levBp[8], 
              tip_length = c(0.35, 0.02),vjust=0.5,textsize=10)
  plot(Grp2)
  
  png(paste0(NmFAlL,NmBas,"6B.png"),width = 1200, height = 1000)
    plot(Grp)
  dev.off()
  pdf(paste0(NmFAlL,NmBas,"6B.pdf"),family = "ArialMT")
    plot(Grp)
  dev.off() 
  pdf(paste0(NmFAlL,NmBas,"6B_Asterisk.pdf"),family = "ArialMT")
    plot(Grp2)
  dev.off() 
  
# Fig.5C
  NmBas="Fig6C PostL"
	DatDTG<-DatDT[,c(1,2,6:8)]
  setnames(DatDTG, "Factor", "Age")
  
  DatDTG$Age<-factor(DatDTG$Age);DatDTG$Age<-relevel(DatDTG$Age,"Young")
	DatDTG$Subject<-factor(DatDTG$Subject)
	setkey(DatDTG,Age)
  
  VIntra=3:5
  NmIntra=names(DatDTG[,VIntra,with=F])
  ExtendDT<-reshape(DatDTG,direction = "long",varying = list(3:5),idvar = "Subject",
          timevar=c("Moment"),times=NmIntra)
  colnames(ExtendDT)[4] <- "DepVar"
  
  ExtendDT$Moment<-factor(ExtendDT$Moment)
  levels(ExtendDT$Moment) <- list("WAKE"="Length_Wake", "NREM"="Length_NREM","REM"="Length_REM")
  ExtendDT$Age<-factor(ExtendDT$Age);ExtendDT$Age<-relevel(ExtendDT$Age,"Young")
   
  ExtendDTRel<-copy(ExtendDT)
  names(ExtendDTRel)[2]<-"Group"
  Grp<- Grph.3b(DatP = ExtendDTRel,"OPR",LblsP =c("Sleep Patterns", "","Average Bout Length (s)"),
                ylmP =c(0,200),hLin = F,lvIp = 3,GrpSel = c(1,3))
  plot(Grp)
 
  levBp<-seq(0.8, 6, by=0.34)
  Grp2<- Grp + geom_signif(annotation="#",
              y_position=125, xmin=levBp[1]  , xmax=levBp[2], 
              tip_length = c(0.02, 0.20),vjust=0,textsize=10)+
              geom_signif(annotation="#",
              y_position=195, xmin=levBp[4]  , xmax=levBp[5], 
              tip_length = c(0.02, 0.25),vjust=0,textsize=10)
  plot(Grp2)
  
  png(paste0(NmFAlL,NmBas,"6C.png"),width = 1200, height = 1000)
    plot(Grp)
  dev.off()
  pdf(paste0(NmFAlL,NmBas,"6C.pdf"),family = "ArialMT")
    plot(Grp)
  dev.off() 
  pdf(paste0(NmFAlL,NmBas,"6C_Asterisk.pdf"),family = "ArialMT")
    plot(Grp2)
  dev.off()
  
  # Results
  rbResRb22
  Kbl3(rbResRb22, "Omnibus AOV. Design 2");cat("\n")
```   
   
 D) Percentage of total time in Wake, NREM and REM during recovery sleep control-SR group
 E) Number of bouts in Wake, NREM and REM during recovery sleep 
 F) bout length in Wake, NREM and REM during recovery sleep   
 
##     Fig 5D,E,F Sleep Recovery {2x2 MANOVA}   
```{r F5DEF, fig.keep='all'}
  NmBas="Fig6D_E_F Recovery"
  NmFich<-paste0(PathDesign,"RecoverSleep.csv");
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  DatDT <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))

  Nms<-names(DatDT)
  Final=ncol(DatDT)
  VarsS<-c(4:Final)
  NmsSel<-names(DatDT[,VarsS,with=F])
  
  setnames(DatDT, "FactorA", "Age")
  setnames(DatDT, "FactorB", "Sleep")
  setnames(DatDT, "subject", "Subject")
  
  DatDT$Age<-factor(DatDT$Age);levels(DatDT$Age) <- list("Young"="y", "Old"="O")
  DatDT$Age<-relevel(DatDT$Age,"Young")
  DatDT$Sleep<-factor(DatDT$Sleep);levels(DatDT$Sleep) <- list("Control"="C", "SR"="SD")
  DatDT$Sleep<-relevel(DatDT$Sleep,"Control")
	DatDT$Subject<-factor(DatDT$Subject)
	setkey(DatDT,Age,Sleep)
  
	ResRo<-list()
	ResRo2AOV<-ResRo2Detall<-ResRo2DetallExt<-list()
	i=4
	for (i in 4:12) {
	  rrt<-list()
	  VarSel<-c(2,3,i)
	  rrt$DT<-DatDT[,..VarSel]
	  ArP<-unlist(lapply(1:2, function (x) lapply(1:2, function(y) DatDT[.(levels(DatDT$Age)[x],levels(DatDT$Sleep)[y]),i,with=F][[1]])),recursive = F)
	  rrt$ArP<-ArP
	  names(rrt$DT)[3]<-"DepV"
    ResRo2<-AOVBwF(2,2,DatPas = rrt,nBMM = 1000)
    
    ResRo2AOV[[i-3]]<-ResRo2$AOV
    ResRo2Detall[[i-3]]<-ResRo2$Detall
    ResRo2DetallExt[[i-3]]<-ResRo2$DetallExt
	}
	
	  rbResRb23AOV<-data.table(NmsSel,do.call(rbind, lapply(ResRo2AOV, as.data.table)))
	  rbResRb23Detall<-data.table(NmsSel,do.call(rbind, lapply(ResRo2Detall, as.data.table)))
	  rbResRb23DetallExt<-data.table(NmsSel,do.call(rbind, lapply(ResRo2DetallExt, as.data.table)))
	
		write.csv2(rbResRb23AOV,paste0(NmFAlL,NmBas,"AllAOV.csv"))
		write.csv2(rbResRb23Detall,paste0(NmFAlL,NmBas,"AllDetallContr.csv"))
		write.csv2(rbResRb23DetallExt,paste0(NmFAlL,NmBas,"AllDetallExtContr.csv"))
	
# Graphs
# Fig.5D
	NmBas="Fig6D Recovery"
	DatDTG<-DatDT[,c(1,2,3,10:12)]
  
  VIntra=4:6
  NmIntra=names(DatDTG[,VIntra,with=F])
  ExtendDT<-reshape(DatDTG,direction = "long",varying = list(4:6),idvar = "Subject",
          timevar=c("Moment"),times=NmIntra)
  colnames(ExtendDT)[5] <- "DepVar"
  
  ExtendDT$Moment<-factor(ExtendDT$Moment)
  levels(ExtendDT$Moment) <- list("WAKE"="Porc_Wake", "NREM"="Porc_NREM","REM"="Porc_REM")
  ExtendDT$Age<-factor(ExtendDT$Age);ExtendDT$Age<-relevel(ExtendDT$Age,"Young")
  ExtendDT$Sleep<-factor(ExtendDT$Sleep);ExtendDT$Sleep<-relevel(ExtendDT$Sleep,"Control")
  ExtendDT$Inter<-interaction(ExtendDT$Age,ExtendDT$Sleep)
  ExtendDT$Inter<-factor( ExtendDT$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
  
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Sleep Patterns", "","Percent Total Time"),ylmP =c(0,80),hLin = F,lvIp = 3)
  plot(Grp)
  
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + geom_signif(annotation=c("","","*"),
              y_position=c(75,77,79),
              xmin=c(levBp[1+5],levBp[2+5], mean(levBp[c(1+5,2+5)])),
              xmax=c(levBp[3+5],levBp[4+5], mean(levBp[c(2+5,4+5)])), 
              tip_length = c(c(0.02, 0.02),c(0.02, 0.02),c(0.05, 0.02)),vjust=0.5,textsize=10)
  
  plot(Grp2)
  
  png(paste0(NmFAlL,NmBas,"6D.png"),width = 1200, height = 1000)
    plot(Grp)
  dev.off()
  pdf(paste0(NmFAlL,NmBas,"6D.pdf"),family = "ArialMT")
    plot(Grp)
  dev.off() 
  pdf(paste0(NmFAlL,NmBas,"6D_Asterisk.pdf"),family = "ArialMT")
    plot(Grp2)
  dev.off() 
   
  
# Fig.5E
  NmBas="Fig6E Recovery"
	DatDTG<-DatDT[,c(1,2,3,4:6)]
  
  VIntra=4:6
  NmIntra=names(DatDTG[,VIntra,with=F])
  ExtendDT<-reshape(DatDTG,direction = "long",varying = list(4:6),idvar = "Subject",
          timevar=c("Moment"),times=NmIntra)
  colnames(ExtendDT)[5] <- "DepVar"
  
  ExtendDT$Moment<-factor(ExtendDT$Moment)
  levels(ExtendDT$Moment) <- list("WAKE"="N_Wake", "NREM"="N_NREM","REM"="N_REM")
  ExtendDT$Age<-factor(ExtendDT$Age);ExtendDT$Age<-relevel(ExtendDT$Age,"Young")
  ExtendDT$Sleep<-factor(ExtendDT$Sleep);ExtendDT$Sleep<-relevel(ExtendDT$Sleep,"Control")
  ExtendDT$Inter<-interaction(ExtendDT$Age,ExtendDT$Sleep)
  ExtendDT$Inter<-factor( ExtendDT$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
  
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Sleep Patterns", "","Number of Bouts"),ylmP =c(0,200),hLin = F,lvIp = 3)
  plot(Grp)
  
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=195, xmin=levBp[3+5]  , xmax=levBp[4+5], 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation="#",
              y_position=180, xmin=levBp[2+5]  , xmax=levBp[4+5], 
              tip_length = c(0.02, 0.02),vjust=0,textsize=8)
  
  plot(Grp2)
  
  png(paste0(NmFAlL,NmBas,"6D.png"),width = 1200, height = 1000)
    plot(Grp)
  dev.off()
  pdf(paste0(NmFAlL,NmBas,"6D.pdf"),family = "ArialMT")
    plot(Grp)
  dev.off() 
  pdf(paste0(NmFAlL,NmBas,"6D_Asterisk.pdf"),family = "ArialMT")
    plot(Grp2)
  dev.off()
  
# Fig.5F
  NmBas="Fig6F Recovery"
	DatDTG<-DatDT[,c(1,2,3,7:9)]
  
  VIntra=4:6
  NmIntra=names(DatDTG[,VIntra,with=F])
  ExtendDT<-reshape(DatDTG,direction = "long",varying = list(4:6),idvar = "Subject",
          timevar=c("Moment"),times=NmIntra)
  colnames(ExtendDT)[5] <- "DepVar"
  
  ExtendDT$Moment<-factor(ExtendDT$Moment)
  levels(ExtendDT$Moment) <- list("WAKE"="Length_Wake", "NREM"="Length_NREM","REM"="Length_REM")
  ExtendDT$Age<-factor(ExtendDT$Age);ExtendDT$Age<-relevel(ExtendDT$Age,"Young")
  ExtendDT$Sleep<-factor(ExtendDT$Sleep);ExtendDT$Sleep<-relevel(ExtendDT$Sleep,"Control")
  ExtendDT$Inter<-interaction(ExtendDT$Age,ExtendDT$Sleep)
  ExtendDT$Inter<-factor( ExtendDT$Inter,levels=c("Young.Control", "Young.SR", "Old.Control","Old.SR"))
  
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Sleep Patterns", "","Average Bout Length (s)"),ylmP =c(0,200),hLin = F,lvIp = 3)
  plot(Grp)
  
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + geom_signif(annotation=c("","","*"),
              y_position=c(185,195,200),
              xmin=c(levBp[1+5],levBp[2+5], mean(levBp[c(1+5,2+5)])),
              xmax=c(levBp[3+5],levBp[4+5], mean(levBp[c(2+5,4+5)])), 
              tip_length = c(c(0.10, 0.10),c(0.02, 0.02),c(0.05, 0.02)),vjust=0.5,textsize=10)
  plot(Grp2)
  
  png(paste0(NmFAlL,NmBas,"6D.png"),width = 1200, height = 1000)
    plot(Grp)
  dev.off()
  pdf(paste0(NmFAlL,NmBas,"6D.pdf"),family = "ArialMT")
    plot(Grp)
  dev.off() 
  pdf(paste0(NmFAlL,NmBas,"6D_Asterisk.pdf"),family = "ArialMT")
    plot(Grp2)
  dev.off()
  
  # Results
  rbResRb23AOV    #Omnibus AOV. Design 2x2"
  rbResRb23Detall #Simple Effects Age-Sleep. Design 2x2
	rbResRb23DetallExt # Extense Simple Effects Age-Sleep. Design 2x2
	
	Kbl3(rbResRb23AOV, "Omnibus AOV. Design 2x2");cat("\n")
  Kbl3(rbResRb23Detall, "Simple Effects Age-Sleep. Design 2x2")
  Kbl3(rbResRb23DetallExt, "Extense Simple Effects Age-Sleep. Design 2x2")
```   
   

# **Figure 6. Average power spectra and relative delta (RDP) and theta (RTP).**   
   
***   
   
> **Figure 6.** Average power spectra and relative delta (RDP) and theta (RTP) power during post-learning and recovery. A-D) Average NREM (A) and REM (B) power spectra and RDP in NREM (C) and RTP in REM during post-learning. E-H) Average NREM (E) and REM (F) power spectra and RDP in NREM (G) and RTP in REM (H) during recovery. RDP: 0.25-4 Hz, RTP: 4-10 Hz. Young control (n=11), young SD (n=11), old control (n=8), old SD (n=10). Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Figure 6.   

***   
   
## Fig 6C,D Band Power PostL {Design 2}   
```{r F6CD, fig.keep='all'}
  NmBas="Fig6 C_D Band Power PostL"
  NmFich<-paste0(PathDesign,"BandPowerPostL.csv");
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  DatDTFull <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  DatDT<-DatDTFull
  DatDT$Group<-factor(DatDT$Group);DatDT$Group<-relevel(DatDT$Group,"Young_C")
  ResFn<-ResAOV1<-list()
  
  for (i in 1:5) {
    DepVar<-names(DatDTFull)[8+i]
    YuenRes<-WRS2::yuen(get(DepVar)~Group,DatDT)
    ResFnPrv<-data.table(with(YuenRes,
                              cbind(DepV=DepVar,diff=round(diff,2),df=round(df,2),test=round(test,2),
                                    EffSize=round(effsize,2),p=round(p.value,4))))
    ResFn<-rbind(ResFn,ResFnPrv)
    lvs<-c(4,7,8+i)
    DatDTG<-DatDTFull[,..lvs];
    DatDTG$Age<-factor(DatDTG$Age)
    DatDTG$Age<-relevel(DatDTG$Age,"Young")
    setkey(DatDTG,Age)

    ArPGlobal<-c(lapply(1:2, function (x) DatDTG[.(levels(DatDTG$Age)[x]),3,with=F][[1]]),recursive = F)
    ResAOV1[[i]]<-AOVSingle(ArPGlobal,2)
  }
  rbResRb22<-data.table(Vars=names(DatDTFull)[9:13],do.call(rbind, lapply(ResAOV1, as.data.table)))
  
  GrpF<-list()
  DepVar1<-names(DatDTFull)[8+1]
  GrpF$A<- Grph.1(DatDT,DepVar1,LblsP =c("Preference for Displaced Object", "","Relative Delta Power"),c(0,50),F,GrpSel=c(1,3))
  DepVar2<-names(DatDTFull)[8+2]
  GrpF$B<- Grph.1(DatDT,DepVar2,LblsP =c("Preference for Displaced Object", "","Relative Sigma Power"),c(0,50),F,GrpSel=c(1,3))
  DepVar3<-names(DatDTFull)[8+3]
  GrpF$C<- Grph.1(DatDT,DepVar3,LblsP =c("Preference for Displaced Object", "","Relative Theta Power"),c(0,100),F,GrpSel=c(1,3))
  DepVar4<-names(DatDTFull)[8+4]
  GrpF$D<- Grph.1(DatDT,DepVar4,LblsP =c("Preference for Displaced Object", "","Relative Beta Power"),c(0,50),F,GrpSel=c(1,3))
  DepVar5<-names(DatDTFull)[8+5]
  GrpF$E<- Grph.1(DatDT,DepVar5,LblsP =c("Preference for Displaced Object", "",DepVar5),c(300,320),F,GrpSel=c(1,3))
  
  ResRes<-list()
  #ResRes[[1]]<-ResFn
  ResRes[[1]]<-rbResRb22
  AlmacenGen3(GrpP = GrpF,DataPas = ResRes,PathDesignP = PathDesign,NmBasP = NmBas, Typ=1)
  
  NmBas2="Fig6C RelDeltaPower PostL"
  pdf(paste0(NmFAlL,NmBas2,".pdf"))
     GrpF$A
  dev.off()
  NmBas3="Fig6D RelTethaPower PostL"
  pdf(paste0(NmFAlL,NmBas3,".pdf"))
     GrpF$C
  dev.off()
    
  pdf(paste0(NmFAlL,NmBas,"TodosGraphs.pdf"))
     GrpF
  dev.off()
  
  # All
  rrt<-ExDataIS.3c(nmF = paste0(PathDesign,"BandPowerPostL.csv"),Vars = c(4,5,7,9:12),vIntP =c(4:7),lvlCh = list("Delta"="delta_NREM", "Sigma"="sigma_NREM","Theta"="theta_REM","Beta"="beta_REM"))
  
  GrpF2<-list()
  GrpF2<-Grph.3b(rrt$ExtendDT,"Moment",LblsP =c("Preference for Unmoved Objects", "","Relative Power"),c(0,100),GrpSel = c(1,3),F)
  
  pdf(paste0(NmFAlL,NmBas,"TodosGraphs.pdf"))
     GrpF2
    dev.off()
    
    #Results
    print("Fig6C RelDeltaPower PostL")
    plot(GrpF$A)
    print("Fig6D RelTethaPower PostL")
    plot(GrpF$C)
    ResRes
    
    Kbl3(ResRes, "Omnibus AOV. Design 2")
```   
   
   
## Fig 6G,H Band Power Recover {Design 2*2}   
```{r F6GH, fig.keep='all'}
  
  NmBas="Fig6G RelDeltaPowerNREM Recover"
  rrt<-ExData.2(nmF = paste0(PathDesign,"BandPowerRecover.csv"),Vars = c(4:5,9))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  #Graphs
  Grp<- Grph.2(DatDT,"delta_NREM",LblsP =c("Preference for Unmoved Objects", "","Relative Delta Power"),c(0,50),F)
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=40, xmin=1  , xmax=2, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation="*",
              y_position=40, xmin=3  , xmax=4, 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)
  # AOV & Simple Effects
  names(rrt$DT)[3]<-"DepV"
  ResGen<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
  #Results Fig6G RelDeltaPowerNREM Recover
    <<ResCtrl1>>
  
NmBas="Fig6H RelThetaPowerREM Recover"
  rrt<-ExData.2(nmF = paste0(PathDesign,"BandPowerRecover.csv"),Vars = c(4:5,11))
  DatDT<-rrt$DT
  ArP<-rrt$Arp  
  
  #Graphs
  Grp<- Grph.2(DatDT,"theta_REM",LblsP =c("Preference for Unmoved Objects", "","Relative Theta Power"),c(0,100),F)
  Grp2=Grp
  
  # AOV & Simple Effects
  names(rrt$DT)[3]<-"DepV"
  ResGen<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
  AlmacenGen(Grp,Grp2,ResGen,PathDesign,NmBas,Typ=1)
  
  #Results Fig6H RelThetaPowerREM Recover
    <<ResCtrl1>>
  
# All
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"BandPowerRecover.csv"),Vars = c(4,5,7,9:12),vIntP =c(4:7),
                  lvlCh = list("Delta"="delta_NREM", "Sigma"="sigma_NREM","Theta"="theta_REM","Beta"="beta_REM"))
  GrpF<-Grph.3(rrt$ExtendDT,"Moment",LblsP =c("Preference for Unmoved Objects", "","Relative Power"),c(0,100),F)
  NmBas="FigBP_Band Power Recover All Bands"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
    
  pdf(paste0(NmFAlL,NmBas,"TodosGraphs.pdf"))
     GrpF
  dev.off()
```   
   

# **Figure 7. Spindle characteristics.**   

***   
   
> **Figure 7.** Spindle characteristics. A) Representation of the automated spindle detection method. Top panel shows the cubed root-mean squared (RMS) of the filtered EEG computed over 750 ms windows. The spindle detection method used a two-threshold approach. These values are derived from the mean cubed RMS transform value of all the NREM traces and included both a lower threshold and upper threshold. The second panel shows the band-pass filtered EEG, followed by the unfiltered EEG signal, and the results of the spindle detection. The bottom panel shows the corresponding EMG signal. Red marks the regions of the signal where spindles are detected, 1 indicates the presence and 0 the absence of spindles, respectively. B-D) Spindle counts (B), duration (C), and frequency (D) during the post-learning sleep period. B) There were no differences between the groups in total average number of spindles, but segment analysis revealed that old control animals displayed less spindles than young control animals during the first hour post-learning. C-D) There were no differences in spindles duration (D) or frequency (D) during post-learning. E-G) Spindle numbers (E), duration (F), and frequency (G) during recovery. G) Old SD animals displayed more average total number of spindles than old controls during the 5 hr recovery sleep period. The 1 hr segment analysis indicated that the groups displayed more spindles during the last segment than the preceding one. F) There were no differences in spindles duration. G) Young SD mice displayed higher spindle frequency than old SD animals. Young control (n=11), young SD (n=11), old control (n=8), old SD (n=10). Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Figure 7.   
   
***   
   
   
## Fig 7B Spindle counts during the post-learning sleep period {Design 2x((5+1)xS)   
```{r F7B, }
  NmBas="Fig7B SpindCount PosL"
  NmFich<-paste0(PathDesign,"DeltaTetaSpindlePostL.csv");
  DatDTFull <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA;rbResRbGl<-list()
  
  # Graphs Previously
  rrt<-ExDataIS.3c(nmF = NmFich,Vars = ,c(4,5,7,17:22),vIntP =c(4:9),lvlCh = list("Hr 1"="NREM_Spindle_1", "Hr 2"="NREM_Spindle_2","Hr 3"="NREM_Spindle_3","Hr 4"="NREM_Spindle_4","Hr 5"="NREM_Spindle_5","Total"="NREM_Spindle_TT"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  Grp<- Grph.3b(DatP = ExtendDT,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Count"),ylmP =c(0,500),hLin = F,lvIp = 6,GrpSel = c(1,3))
  
  levBp<-seq(0.8, 6, by=0.4)
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=350, xmin=levBp[1]  , xmax=levBp[2], 
              tip_length = c(0.20, 0.35),vjust = 0.5, textsize=10)
  
  #AOV 1 Global
  DatDTG<-DatDTFull[,c(4,7,22)];
  DatDTG$Age<-factor(DatDTG$Age)
  DatDTG$Age<-relevel(DatDTG$Age,"Young")
  setkey(DatDTG,Age)

  ArPGlobal<-c(lapply(1:2, function (x) DatDTG[.(levels(DatDTG$Age)[x]),3,with=F][[1]]),recursive = F)
  ResAOV1<-AOVSingle(ArPGlobal,2)
  rbResRbGl$AOV<-do.call(cbind, lapply(ResAOV1, as.data.table))
	write.csv2(rbResRbGl$AOV,paste0(NmFAlL, NmBas,"GlobalOmnContr.csv"))
  
  #AOV 2 For Time Details
  rrt2<-ExDataIS.3c(nmF = NmFich,Vars = ,c(4,5,7,17:21),vIntP =c(4:8),lvlCh = list("Hr 1"="NREM_Spindle_1", "Hr 2"="NREM_Spindle_2","Hr 3"="NREM_Spindle_3","Hr 4"="NREM_Spindle_4","Hr 5"="NREM_Spindle_5"))

  names(rrt2$DT)[3:7]<-c("T1","T2","T3","T4","T5")
  ResGen<-AOVMx2b(A=2,C=5,DatPas = rrt2,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
  # Other Graphs for Time details
    ExtendDT2<-rrt2$ExtendDT
    ExtendDTCol<-copy(ExtendDT2)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT2,ExtendDTCol))
    
    Grp3<- Grph.3b(DatP = ExtendDTCol,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Count"),ylmP =c(0,500),hLin = F,lvIp = 6,GrpSel = c(1,3),wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
    dev.off()
    
    #Results
    plot(Grp)
    plot(Grp2)
    plot(Grp3)
    
    #AOV 1 Global
    rbResRbGl
    Kbl3(rbResRbGl, "Global Omnibus AOV. Design 2")
    
    #AOV 2 For Time Details
    ResGen
    Kbl3(ResGen[[1]], "Omnibus AOV. Design 2x(5xS)")
    Kbl3(ResGen[[2]], "Simple Effects Age-Time. Design 2x(5xS)")
    Kbl3(ResGen[[3]], "Main Effects Time. Design 2x(5xS)")
```   
   
   
## Fig 7C Duration during the post-learning sleep period {Design 2x((5+1)xS)   
```{r F7C, }
  NmBas="Fig7C AvgSpindDurat PostL"
  NmFich<-paste0(PathDesign,"DeltaTetaSpindlePostL.csv");
  DatDTFull <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA;rbResRbGl<-list()

 # Graphs Previously
  rrt<-ExDataIS.3c(nmF = NmFich,Vars = ,c(4,5,7,23:28),vIntP =c(4:9),lvlCh = list("Hr 1"="Avg_SpindleDuration_NREM_1", "Hr 2"="Avg_SpindleDuration_NREM_2","Hr 3"="Avg_SpindleDuration_NREM_3","Hr 4"="Avg_SpindleDuration_NREM_4","Hr 5"="Avg_SpindleDuration_NREM_5","Total"="Avg_SpindleDuration_NREM_TT"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  Grp<- Grph.3b(DatP = ExtendDT,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Duration (s)"),ylmP =c(0,3),hLin = F,lvIp = 6,GrpSel = c(1,3))
  Grp2=Grp
  
  #AOV 1 Global
  DatDTG<-DatDTFull[,c(4,7,28)];
  DatDTG$Age<-factor(DatDTG$Age)
  DatDTG$Age<-relevel(DatDTG$Age,"Young")
  setkey(DatDTG,Age)

  ArPGlobal<-c(lapply(1:2, function (x) DatDTG[.(levels(DatDTG$Age)[x]),3,with=F][[1]]),recursive = F)
  ResAOV1<-AOVSingle(ArPGlobal,2)
  rbResRbGl$AOV<-do.call(cbind, lapply(ResAOV1, as.data.table))
	write.csv2(rbResRbGl$AOV,paste0(NmFAlL, NmBas,"GlobalOmnContr.csv"))
  
  #AOV 2 For Time Details
  rrt2<-ExDataIS.3c(nmF = NmFich,Vars = ,c(4,5,7,23:27),vIntP =c(4:8),lvlCh = list("Hr 1"="Avg_SpindleDuration_NREM_1", "Hr 2"="Avg_SpindleDuration_NREM_2","Hr 3"="Avg_SpindleDuration_NREM_3","Hr 4"="Avg_SpindleDuration_NREM_4","Hr 5"="Avg_SpindleDuration_NREM_5"))

  names(rrt2$DT)[3:7]<-c("T1","T2","T3","T4","T5")
  ResGen<-AOVMx2b(A=2,C=5,DatPas = rrt2,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)

  # Other Graphs for Time details
    ExtendDT2<-rrt2$ExtendDT
    ExtendDTCol<-copy(ExtendDT2)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT2,ExtendDTCol))
    
    Grp3<- Grph.3b(DatP = ExtendDTCol,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Duration (s)"),ylmP =c(0,3),hLin = F,lvIp = 6,GrpSel = c(1,3),wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
    dev.off()
    
    #Results
    plot(Grp)
    plot(Grp2)
    plot(Grp3)
    
    #AOV 1 Global
    rbResRbGl
    Kbl3(rbResRbGl, "Global Omnibus AOV. Design 2")
    
    #AOV 2 For Time Details
    ResGen
    Kbl3(ResGen[[1]], "Omnibus AOV. Design 2x(5xS)")
    Kbl3(ResGen[[2]], "Simple Effects Age-Time. Design 2x(5xS)")
    Kbl3(ResGen[[3]], "Main Effects Time. Design 2x(5xS)")
  
```   
   
   
## Fig 7D Frequency during the post-learning sleep period {Design 2x((5+1)xS)   
```{r F7D, }
  NmBas="Fig7D SpindFreq PostL"
  NmFich<-paste0(PathDesign,"DeltaTetaSpindlePostL.csv");
  DatDTFull <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA;rbResRbGl<-list()
  
# Graphs Previously
  rrt<-ExDataIS.3c(nmF = NmFich,Vars = ,c(4,5,7,29:34),vIntP =c(4:9),lvlCh = list("Hr 1"="Avg_SpindleHz_NREM_1", "Hr 2"="Avg_SpindleHz_NREM_2","Hr 3"="Avg_SpindleHz_NREM_3","Hr 4"="Avg_SpindleHz_NREM_4","Hr 5"="Avg_SpindleHz_NREM_5","Total"="Avg_SpindleHz_NREM_TT"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  Grp<- Grph.3b(DatP = ExtendDT,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Frequency (Hz)"),ylmP =c(10,12),hLin = F,lvIp = 6,GrpSel = c(1,3))
  
  Grp2=Grp
  
  #AOV 1 Global
  DatDTG<-DatDTFull[,c(4,7,34)];
  DatDTG$Age<-factor(DatDTG$Age)
  DatDTG$Age<-relevel(DatDTG$Age,"Young")
  setkey(DatDTG,Age)

  ArPGlobal<-c(lapply(1:2, function (x) DatDTG[.(levels(DatDTG$Age)[x]),3,with=F][[1]]),recursive = F)
  ResAOV1<-AOVSingle(ArPGlobal,2)
  rbResRbGl$AOV<-do.call(cbind, lapply(ResAOV1, as.data.table))
	write.csv2(rbResRbGl$AOV,paste0(NmFAlL, NmBas,"GlobalOmnContr.csv"))
  
  #AOV 2 For Time Details
  rrt2<-ExDataIS.3c(nmF = NmFich,Vars = ,c(4,5,7,29:33),vIntP =c(4:8),lvlCh = list("Hr 1"="Avg_SpindleHz_NREM_1", "Hr 2"="Avg_SpindleHz_NREM_2","Hr 3"="Avg_SpindleHz_NREM_3","Hr 4"="Avg_SpindleHz_NREM_4","Hr 5"="Avg_SpindleHz_NREM_5"))

  names(rrt2$DT)[3:7]<-c("T1","T2","T3","T4","T5")
  ResGen<-AOVMx2b(A=2,C=5,DatPas = rrt2,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
  # Other Graphs for Time details
    ExtendDT2<-rrt2$ExtendDT
    ExtendDTCol<-copy(ExtendDT2)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT2,ExtendDTCol))
    
    Grp3<- Grph.3b(DatP = ExtendDTCol,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Frequency (Hz)"),ylmP =c(10,12),hLin = F,lvIp = 6,GrpSel = c(1,3),wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
    dev.off()
    
    #Results
    plot(Grp)
    plot(Grp2)
    plot(Grp3)
    
    #AOV 1 Global
    rbResRbGl
    Kbl3(rbResRbGl, "Global Omnibus AOV. Design 2")
    
    #AOV 2 For Time Details
    ResGen
    Kbl3(ResGen[[1]], "Omnibus AOV. Design 2x(5xS)")
    Kbl3(ResGen[[2]], "Simple Effects Age-Time. Design 2x(5xS)")
    Kbl3(ResGen[[3]], "Main Effects Time Design. 2x(5xS)")
```   
   

## Fig 7E Spindle numbers during recovery {Design 2x2x((5+1)xS)   
```{r F7E, }
  NmBas="Fig7E SpindCount Recover"
  NmFich<-paste0(PathDesign,"DeltaTetaSpindleRecover.csv");
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA;ResGen1<-NA;
  
  # Graphs Previously
  rrt<-ExDataIS.2(nmF = NmFich,Vars = ,c(4,5,7,9:14),vIntP =c(4:9),lvlCh = list("Hr 1"="NREM_Spindle_1", "Hr 2"="NREM_Spindle_2","Hr 3"="NREM_Spindle_3","Hr 4"="NREM_Spindle_4","Hr 5"="NREM_Spindle_5","Total"="NREM_Spindle_TT"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Count"),ylmP =c(0,500),hLin = F,lvIp = 6)
  
  levBp<-seq(0.7, 25, by=0.2)
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=325, xmin=levBp[2+25]  , xmax=levBp[4+25], 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation="*",
              y_position=300, xmin=levBp[3+25]  , xmax=levBp[4+25], 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)+
    geom_signif(annotation=c("","","*"),
              y_position=c(300,320,330),
              xmin=c(levBp[1+15],levBp[1+20], mean(levBp[c(1+15,4+15)])),
              xmax=c(levBp[4+15],levBp[4+20], mean(levBp[c(1+20,4+20)])), 
              tip_length = c(c(0.02, 0.02),c(0.02, 0.02),c(.05, 0.02)),vjust=0.5,textsize=10)
  
  #AOV 1 Global
  rrt<-ExData.2(nmF = NmFich,Vars = c(4,5,14))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  names(rrt$DT)[3]<-"DepV"
  ResGen1<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
  AlmacenGen(Grp,Grp2,ResGen1,PathDesign,paste0(NmBas,"_Total"),Typ=1)
  
  #AOV 2 For Time Details
  rrt2<-ExDataIS.2(nmF = NmFich,Vars = c(4,5,7,9:13),vIntP =c(4:8),lvlCh = list("Hr 1"="NREM_Spindle_1", "Hr 2"="NREM_Spindle_2","Hr 3"="NREM_Spindle_3","Hr 4"="NREM_Spindle_4","Hr 5"="NREM_Spindle_5"))
  DatDT<-rrt2$DT
  ArP<-rrt2$Arp
  ExtendDT<-rrt2$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = NmFich,Vars = c(4:5,(8+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  names(rrt2$DT)[4:8]<-c("T1","T2","T3","T4","T5")
  ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt2,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign, NmBasP = paste0(NmBas,"_TimeDetail"),Typ=2)
  
  # Other Graphs for Time details
    ExtendDT2<-rrt2$ExtendDT
    ExtendDTCol<-copy(ExtendDT2)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT2,ExtendDTCol))
    
    Grp3<- Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Count"),ylmP =c(0,500),hLin = F,lvIp = 6,wMain = T)
    
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Spindle Characteristics", "","Spindle Count"))
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    #Results
    #AOV 1 Global
    ResGen1
    Kbl3(ResGen1[[1]], "Omnibus AOV. Design 2x2")
    Kbl3(ResGen1[[2]], "Simple Effects Age-Sleep. Design 2x2")
    Kbl3(ResGen1[[3]], "Extense Simple Effects Age-Sleep. Design 2x2")
    
    #AOV 2 For Time Details
    <<ResCtrl4>>
```   
   
   
## Fig 7F Duration during recovery {Design 2x2x((5+1)xS)   
```{r F7F, }
  NmBas="Fig7F AvgSpindDurat Recover"
  NmFich<-paste0(PathDesign,"DeltaTetaSpindleRecover.csv");
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA;ResGen1<-NA;

  # Graphs Previously
  rrt<-ExDataIS.2(nmF = NmFich,Vars = ,c(4,5,7,15:20),vIntP =c(4:9),lvlCh = list("Hr 1"="Avg_SpindleDuration_NREM_1", "Hr 2"="Avg_SpindleDuration_NREM_2","Hr 3"="Avg_SpindleDuration_NREM_3","Hr 4"="Avg_SpindleDuration_NREM_4","Hr 5"="Avg_SpindleDuration_NREM_5","Total"="Avg_SpindleDuration_NREM_TT"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Duration (s)"),ylmP =c(0,3),hLin = F,lvIp = 6)
  Grp2=Grp
  
  #AOV 1 Global
  rrt<-ExData.2(nmF =NmFich,Vars = c(4,5,20))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  names(rrt$DT)[3]<-"DepV"
  ResGen1<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
  AlmacenGen(Grp,Grp2,ResGen1,PathDesign,paste0(NmBas,"_Total"),Typ=1)
  
  #AOV 2 For Time Details
  rrt2<-ExDataIS.2(nmF = NmFich,Vars = c(4,5,7,15:19),vIntP =c(4:8),lvlCh = list("Hr 1"="Avg_SpindleDuration_NREM_1", "Hr 2"="Avg_SpindleDuration_NREM_2","Hr 3"="Avg_SpindleDuration_NREM_3","Hr 4"="Avg_SpindleDuration_NREM_4","Hr 5"="Avg_SpindleDuration_NREM_5"))
  DatDT<-rrt2$DT
  ArP<-rrt2$Arp
  ExtendDT<-rrt2$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = NmFich,Vars = c(4:5,(8+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  names(rrt2$DT)[4:8]<-c("T1","T2","T3","T4","T5")
  ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt2,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = paste0(NmBas,"_TimeDetail"),Typ=2)
  
  # Other Graphs for Time details
    ExtendDT2<-rrt2$ExtendDT
    ExtendDTCol<-copy(ExtendDT2)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT2,ExtendDTCol))
    
    Grp3<- Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Duration (s)"),ylmP =c(0,3),hLin = F,lvIp = 6,wMain = T)
    
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Spindle Characteristics", "","Spindle Duration (s)"))
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    #Results
    #AOV 1 Global
    ResGen1
    Kbl3(ResGen1[[1]], "Omnibus AOV. Design 2x2")
    Kbl3(ResGen1[[2]], "Simple Effects Age-Sleep. Design 2x2")
    Kbl3(ResGen1[[3]], "Extense Simple Effects Age-Sleep. Design 2x2")
    
    #AOV 2 For Time Details
    <<ResCtrl4>>
```   
   
   
## Fig 7G Frequency during recovery {Design 2x2x((5+1)xS)   
```{r F7G, }
  NmBas="Fig7G SpindFreq Recover"
  NmFich<-paste0(PathDesign,"DeltaTetaSpindleRecover.csv");
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA;ResGen1<-NA;
  
  # Graphs Previously
  rrt<-ExDataIS.2(nmF = NmFich,Vars = ,c(4,5,7,21:26),vIntP =c(4:9),lvlCh = list("Hr 1"="Avg_SpindleHz_NREM_1", "Hr 2"="Avg_SpindleHz_NREM_2","Hr 3"="Avg_SpindleHz_NREM_3","Hr 4"="Avg_SpindleHz_NREM_4","Hr 5"="Avg_SpindleHz_NREM_5","Total"="Avg_SpindleHz_NREM_TT"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Frequency (Hz)"),ylmP =c(10,12),hLin = F,lvIp = 6)
  
  levBp<-seq(0.7, 25, by=0.2)
  Grp2<- Grp + geom_signif(annotation="*",
              y_position=11.5, xmin=levBp[2+25]  , xmax=levBp[4+25], 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10)
  
  #AOV 1 Global
  rrt<-ExData.2(nmF = NmFich,Vars = c(4,5,26))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  names(rrt$DT)[3]<-"DepV"
  ResGen1<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
  AlmacenGen(Grp,Grp2,ResGen1,PathDesign,paste0(NmBas,"_Total"),Typ=1)
  
  #AOV 2 For Time Details
  rrt2<-ExDataIS.2(nmF = NmFich,Vars = c(4,5,7,21:25),vIntP =c(4:8),lvlCh = list("Hr 1"="Avg_SpindleHz_NREM_1", "Hr 2"="Avg_SpindleHz_NREM_2","Hr 3"="Avg_SpindleHz_NREM_3","Hr 4"="Avg_SpindleHz_NREM_4","Hr 5"="Avg_SpindleHz_NREM_5"))
  DatDT<-rrt2$DT
  ArP<-rrt2$Arp
  ExtendDT<-rrt2$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = NmFich,Vars = c(4:5,(8+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  names(rrt2$DT)[4:8]<-c("T1","T2","T3","T4","T5")
  ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt2,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = paste0(NmBas,"_TimeDetail"),Typ=2)
  
  # Other Graphs for Time details
    ExtendDT2<-rrt2$ExtendDT
    ExtendDTCol<-copy(ExtendDT2)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT2,ExtendDTCol))
    
    Grp3<- Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Spindle Characteristics", "","Spindle Frequency (Hz)"),ylmP =c(10,12),hLin = F,lvIp = 6,wMain = T)
    
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Spindle Characteristics", "","Spindle Frequency (Hz)"))
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    #Results
    #AOV 1 Global
    ResGen1
    Kbl3(ResGen1[[1]], "Omnibus AOV. Design 2x2")
    Kbl3(ResGen1[[2]], "Simple Effects Age-Sleep. Design 2x2")
    Kbl3(ResGen1[[3]], "Extense Simple Effects Age-Sleep. Design 2x2")
    
    #AOV 2 For Time Details
    <<ResCtrl4>>
```   
   

# **Figure 8. Spindle counts during NREM/REM sigma transitions correlate with memory performance.**   

***   

> **Figure 8.** Spindle counts during NREM/REM sigma transitions correlate with memory performance. A-F) Spectrograms showing NREM/REM sigma transitions and associated average spindle counts during the same transitions for controls during post-learning (A-B) and experimental and controls groups during recovery (C-F). G-H) Sum of spindle counts during the NREM/REM sigma transitions during post-learning (G) and recovery (H). I) Correlations between OPR memory performance and spindle counts during NREM/REM sigma transitions. Young control (n=11), young SD (n=11), old control (n=8), old SD (n=10). Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Figure 8.   

***   
   
## Fig 8G Spnidle Transition PostL {Design 2x(2xS)}   
```{r 8G, }
  NmBas="Fig8G SpinTransPostL"
  NmFich<-paste0(PathDesign,"SpindleTransitionPostL.csv");
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
    
  DatDTFull <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  
  DatDT<-DatDTFull[,c(3,7,9:10)]
  setnames(DatDT, "fullname", "Subject")
  
  DatDT$Group<-factor(DatDT$Group);levels(DatDT$Group) <- list("Young Control"="Young_C", "Old Control"="Old_C")
  DatDT$Group<-relevel(DatDT$Group,"Young Control")
  DatDT$Subject<-factor(DatDT$Subject)
 	setkey(DatDT,Group)
  
  VIntra=3:4
  NmIntra=names(DatDT[,VIntra,with=F])
  ExtendDT<-reshape(DatDT,direction = "long",varying = list(3:4),idvar = "Subject",
          timevar=c("Moment"),times=NmIntra)
  colnames(ExtendDT)[4] <- "DepVar"
  
  ExtendDT$Group<-factor(ExtendDT$Group);ExtendDT$Group<-relevel(ExtendDT$Group,"Young Control")
  
  ExtendDT$Moment<-factor(ExtendDT$Moment)
  levels(ExtendDT$Moment)<-list("-60 sec to 0"="sum_before", "0 to +60 sec"="sum_after")
	ExtendDT$Group<-relevel(ExtendDT$Group,"Young Control")
    
  ArP<-unlist(lapply(1:2, function (x) lapply(3:4, function(y) DatDT[.(levels(DatDT$Group)[x]),y,with=F][[1]])),recursive = F)
  
  
  Grp<- Grph.3.2Intra(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Sum of Spindle Counts"),ylmP =c(0,50),hLin = F,lvIp = 2,wMain = F)
 
  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + 
    geom_signif(annotation=c("","","*"),
              y_position=c(2,2,1),
              xmin=c(levBp[1],levBp[1+5], mean(levBp[c(1,4)])),
              xmax=c(levBp[4],levBp[4+5], mean(levBp[c(1+5,4+5)])), 
              tip_length = c(-0.02, -0.02),vjust=2,textsize=10)
   
   
   # AOV Omnibus
    ResRo<-list()
    RsRb<-bwtrim(2,2,ArP)
    ResRo$w<- c(RsRb$Qa.p.value, RsRb$Qb.p.value, RsRb$Qab.p.value)
    ResRo$BT<-try(c(bwtrimbt(2,2,ArP)))
    APA.N1<-c(round(unlist(RsRb),4),round(unlist(ResRo$BT),4))
    rr<-ExtrSig(ResRo$BT)
    #print(rr)
    
    ResRo$BT_MM<-c(bwtrimbt(2,2,ArP,nboot = 10000))
    rr2=ExtrSig(ResRo$BT_MM)
    #print(rr2)
    
    TamA=round(ESmainMCP(2,2,ArP)$Factor.A[3],3)
		TamB=round(mean(ESmainMCP(2,2,ArP)$Factor.B[,3]),3)
		TamInt=round(mean(esImcp(2,2,ArP)$Effect.Sizes),3)
    
    
    ExRsRbp<-with(RsRb, round(c(Qa.p.value, Qb.p.value,Qab.p.value),4))
    ExRsRbQ<-with(RsRb, round(c(Qa, Qb, Qab),4))
    ExFn<-data.table(ExRsRbQ,ExRsRbp,rr$p.V1,rr$p.Sig,rr2$p.V1,rr2$p.Sig)
    names(ExFn)<-c("Q","p","pBoot","Sig","pBootMas","Sig2")
    ResGen2<-list()
    ResGen2[[1]]<-data.table(Names=c("Age","Phase","Age*Phase"),ExFn)                
    ResGen2[[1]][,EffSize:=c(TamA,TamB,TamInt)]
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen2,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
   
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
     Grp3<- Grph.3.2Intra(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "A","Sum of spindle counts"),ylmP =c(0,50),hLin = F,lvIp = 3,wMain = T)
  
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
    dev.off()
    
    #Results
    plot(Grp)
    plot(Grp2)
    plot(Grp3)
    ResGen2
    
    Kbl3(ResGen2[[1]], "Omnibus AOV. Design 2x2")
```   
   
   
## Fig 8H Spnidle Transition Recover {Design 2x2x(2xS)}   
```{r 8H, }
    NmBas="Fig8H SpinTransRecover"
    NmFAlL<-paste0(PathDesign,NmBas)
    if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
    NmFAlL<-paste0(NmFAlL,"/")
    ResGen<-NA
    
    rrt<-ExDataIS.2(nmF = paste0(PathDesign,"SpindleTransitionRecover.csv"),Vars = c(4,5,7,9:10),vIntP =c(4:5),lvlCh = list("T1"="sum_before","T2"="sum_after"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # For Simple Effects:
  DatEfS<-list()
  for(is in 1:2) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"SpindleTransitionRecover.csv"),Vars = c(4:5,(8+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  ExtendDTv2<-copy(ExtendDT)
  levels(ExtendDTv2$Moment) <- list("-60 sec to 0"="T1", "0 to +60 sec"="T2")

  Grp<- Grph.3(DatP = ExtendDTv2,"OPR",LblsP =c("Object Exploration", "","Sum of Spindle Counts"),ylmP =c(0,50),hLin = F,lvIp = 2,wMain = F)

  levBp<-seq(0.7, 5, by=0.2)
  Grp2<- Grp + 
    geom_signif(annotation=c("*"),
              y_position=c(48),
              xmin=c(levBp[1]),
              xmax=c(levBp[2]), 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation=c("*"),
              y_position=c(45),
              xmin=c(levBp[2]),
              xmax=c(levBp[4]), 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation=c("*"),
              y_position=c(48),
              xmin=c(levBp[1+5]),
              xmax=c(levBp[2+5]), 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation=c("*"),
              y_position=c(45),
              xmin=c(levBp[2+5]),
              xmax=c(levBp[4+5]), 
              tip_length = c(0.02, 0.02),vjust=0.5,textsize=10) +
    geom_signif(annotation=c("","","*"),
              y_position=c(2,2,1),
              xmin=c(levBp[1],levBp[1+5], mean(levBp[c(1,4)])),
              xmax=c(levBp[4],levBp[4+5], mean(levBp[c(1+5,4+5)])), 
              tip_length = c(-0.02, -0.02),vjust=2,textsize=10)
    
   
  #AOV
  #A=2;B=2;C=2;DatPas=rrt;DatEfSp=DatEfS;nBMM1=nBMM2=1000;Prc = 2
  names(rrt$DT)[4:5]<-c("T1","T2")
  ResGen<-AOVMx2.2(A=2,B=2,C=2,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Object Exploration", "A","Similarity Score"))
   
    ExtendDTCol<-copy(ExtendDTv2)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDTv2,ExtendDTCol))
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "A","Sum of spindle counts"),ylmP =c(0,50),hLin = F,lvIp = 3,wMain = T)
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    # Results
    <<ResCtrl6>>
```   
   

## Fig 8I Pearson r Correlations {Design 2x2}   
```{r 8I, fig.keep='all'}

  NmBas="Fig8I Correlations"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  
  DatDTRes<-list()
  
  NameF<-paste0(PathDesign,"SpindleTransitionRecoverBehavior.csv")
  DatDTFullp <- data.table(read.table(NameF, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  DatDTFullp$subtype<-factor(DatDTFullp$subtype)
  co<-list()
  co$cor<-cor(DatDTFullp[,8:10],use="pairwise.complete.obs")
  result <- by(DatDTFullp[,8:10], DatDTFullp$subtype, function(x) {cor(x$sum_before, x$Behavior)})
  result.dataframe <- as.data.frame(as.matrix(result))
  result.dataframe$C <- rownames(result)
  result.dataframe$Grp<-as.factor(c("PostLearning","Recovery","Recovery","PostLearning","Recovery","Recovery"))
  
  DTTibb<-as_tibble(DatDTFullp)
  DTTibb$age<-as.factor(DTTibb$age); relevel(DTTibb$age,"Y")
  DTTibb$Inter<-interaction(DTTibb$age,DTTibb$type,sep=",")
  
  DTTibb$Inter<-factor(DTTibb$Inter,levels=c("Y,C","Y,D","O,C","O,D"))
  DTTibbR<-DTTibb %>%
    dplyr::select(period,Inter,sum_before, Behavior) %>%
    dplyr::group_by(period,Inter) %>%
    dplyr::summarise(R=cor.test(sum_before,Behavior)[["estimate"]],
                      p=cor.test(sum_before,Behavior)[["p.value"]],.groups = 'drop')

  

 DTTibbR$period<-as.factor(DTTibbR$period)
 levels(DTTibbR$period)=list('Post-Learning'='P',"Recovery"='R')
 DTTibbR$p<-round(DTTibbR$p,2)
 DTTibbR$p<-c('0.03*', '0.06', '0.09', '0.0009*', '0.16', '0.0004*')

  pdf(paste0(NmFAlL,NmBas,"Graphs.pdf"),family = "ArialMT")
      dotchart(DTTibbR$R, labels = DTTibbR$Inter ,
         cex = 1.5, xlab = "",xlim=c(0,1.1),groups = DTTibbR$period,color="black",pch=19)
    text(x = DTTibbR$R [c(3,4,5,6,1,2)],
     y = c(1:4,7:8),
     labels= paste0("p=",DTTibbR$p[c(3,4,5,6,1,2)]),
     cex = 1,
     pos = 4)
  dev.off()

    bp<-ggplot(DTTibbR, aes(x = Inter, y = R )) 
    bpp<-bp + geom_segment( aes(x=Inter,xend=Inter, y=0, yend=R), color="grey") +
    geom_point(size=5, color=c("blue","blue","red","red","red","red")) +
    coord_flip() +
  theme_ipsum() +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.major.x = element_line(colour = "darkgrey"),
       panel.grid.minor.x = element_line(colour = "grey"),
      axis.text = element_text( size=48 )
    ) +
    ylim(0,1) +
    ylab("") +
    xlab("") + ggtitle("") +
   annotate("text", x = c(1,3,1,2,3,4)+.15,
     y = DTTibbR$R+c(0,0,-.05,-.05,-.05,-.05),
     label= paste0("p=",DTTibbR$p))

  
  
  # Results
  # Type 1 Graph Pearson r Correlation
  dotchart(DTTibbR$R, labels = DTTibbR$Inter ,
         cex = 1.5, xlab = "",xlim=c(0,1.1),groups = DTTibbR$period,color="black",pch=19)
  text(x = DTTibbR$R [c(3,4,5,6,1,2)],
     y = c(1:4,7:8),
     labels= paste0("p=",DTTibbR$p[c(3,4,5,6,1,2)]),
     cex = 1,
     pos = 4)  

  # Type 2 Graph Pearson r Correlation
  plot(bpp)
```   
   

# **Supplemental Figure 1. Electrode placement and place cell parameters recorded.**   

***   

> **Supplemental Figure 1.** Schematic of electrode placement and place cell parameters recorded during OPR performance. A) Schematic of electrode placements (red dots) and microphotograph showing sample lesion marking electrode placement in CA1. B-D) Mean (B), peak (C), and out of field (D) firing rate for all groups across trials. There were no differences in mean or peak firing rate between the groups throughout training (p>0.05). However, there were increases in firing rate that persisted during training (T1 to T3) when the objects were introduced across all groups [MFR: Fw(4)=1.14, p<0.007; PFR: Fw(4)=1.11, p<0.02 . Analysis of simple effects indicated that all groups displayed higher mean and peak firing rate during the first object trial and test trials (MFR: Hab xT1: Zw=1.73, p<0.04; T3 x Test: Zw=3.16, p<0.04; PFR: Hab xT1: Zw=2.08, p<0.02; T3 x Test: Zw=0.96, p<0.05]. No differences were observed in out-of- field firing rate. E-G) There were no differences during training or testing in other place cell parameters, including number of fields (E), field size (F), and spatial information content (G, p>0.05). Hab: habituation, T1-T3: training trials. Asterisks (*) represent significance using alpha=0.05. Statistical details in Supplemental Statistical Table corresponding to Supplemental Figure 1.   

***   
   
## Fig S1B Mean firing rate {Design 2x2x(5xS)}
```{r S1B, }
  NmBas="FigS1B MeanFiringRate"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(1,5,6,7:11),vIntP =c(4:8),lvlCh = list("HAB"="mfr_s1", "T1"="mfr_s2","T2"="mfr_s3","T3"="mfr_s4","Test"="mfr_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(5:6,(6+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  #Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Mean FR (Hz)"),ylmP =c(0,1.5),hLin = F,lvIp=5)

  levBp<-seq(0.7, 6, by=0.2)
  Grp2<- Grp + 
    geom_signif(annotation=c("","","*"),
              y_position=c(1.4,1.4,1.5),
              xmin=c(levBp[1],levBp[1+5], mean(levBp[c(1,4)])),
              xmax=c(levBp[4],levBp[4+5], mean(levBp[c(1+5,4+5)])), 
              tip_length = c(0.02, 0.02),textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(1.4,1.4,1.5),
              xmin=c(levBp[1+15],levBp[1+20], mean(levBp[c(1+15,4+15)])),
              xmax=c(levBp[4+15],levBp[4+20], mean(levBp[c(1+20,4+20)])), 
              tip_length = c(0.02, 0.02),textsize=6)
  
    #AOV
    names(rrt$DT)[4:8]<-c("T1","T2","T3","T4","T5")
    ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Object Exploration", "B","Mean FR (Hz)"))
 
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "B","Mean FR (Hz)"),ylmP =c(0,1.5),hLin = F,lvIp = 6,wMain = T)
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    # Results
    <<ResCtrl4>>
```

## Fig S1C Peak firing rate {Design 2x2x(5xS)}
```{r S1C, }
  NmBas="FigS1C PeakFiringRate"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(1,5,6,12:16),vIntP =c(4:8),lvlCh = list("HAB"="pfr_s1", "T1"="pfr_s2","T2"="pfr_s3","T3"="pfr_s4","Test"="pfr_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(5:6,(6+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  #Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Peak FR (Hz)"),ylmP =c(0,10),hLin = F,lvIp=5)
 
  levBp<-seq(0.7, 6, by=0.2)
  Grp2<- Grp + 
    geom_signif(annotation=c("","","*"),
              y_position=c(7.5,7.5,8),
              xmin=c(levBp[1],levBp[1+5], mean(levBp[c(1,4)])),
              xmax=c(levBp[4],levBp[4+5], mean(levBp[c(1+5,4+5)])), 
              tip_length = c(0.02, 0.02),textsize=6)+
    geom_signif(annotation=c("","","*"),
              y_position=c(7.5,7.5,8),
              xmin=c(levBp[1+15],levBp[1+20], mean(levBp[c(1+15,4+15)])),
              xmax=c(levBp[4+15],levBp[4+20], mean(levBp[c(1+20,4+20)])), 
              tip_length = c(0.02, 0.02),textsize=6)
  
    #AOV
    names(rrt$DT)[4:8]<-c("T1","T2","T3","T4","T5")
    ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 1000,nBMM2 = 1000,Prc = 2)
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Object Exploration", "C","Peak FR (Hz)"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "C","Peak FR (Hz)"),ylmP =c(0,1.5),hLin = F,lvIp = 6,wMain = T)
   
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    # Results
    <<ResCtrl4>>
```

## Fig S1D Out of field firing rate {Design 2x2x(5xS)}
```{r S1D, }
  NmBas="FigS1D OutOfField"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(1,5,6,17:21),vIntP =c(4:8),lvlCh = list("HAB"="outF_s1", "T1"="outF_s2","T2"="outF_s3","T3"="outF_s4","Test"="outF_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(5:6,(6+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  # Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Out of Field FR (Hz)"),ylmP =c(0,1.5),hLin = F,lvIp=5)
  Grp2=Grp
    
    #AOV
    names(rrt$DT)[4:8]<-c("T1","T2","T3","T4","T5")
    ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 1000,nBMM2 = 1000,Prc = 2)
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Object Exploration", "D","Out of Field FR (Hz)"))
      
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "D","Out of Field FR (Hz)"),ylmP =c(0,1.5),hLin = F,lvIp = 6,wMain = T)
  
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    # Results
    <<ResCtrl4>>
```

## Fig S1E Number of fields {Design 2x2x(5xS)}
```{r S1E,}
  NmBas="FigS1E NumberOfFields"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
  
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(1,5,6,22:26),vIntP =c(4:8),lvlCh = list("HAB"="NOfF_s1", "T1"="NOfF_s2","T2"="NOfF_s3","T3"="NOfF_s4","Test"="NOfF_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(5:6,(6+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  # Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Number of Fields"),ylmP =c(0,3),hLin = F,lvIp=5)
  Grp2=Grp
    
    #AOV
    #A=2;B=2;C=5;DatPas=rrt;DatEfSp=DatEfS;nBMM1=nBMM2=1000;Prc=2
    names(rrt$DT)[4:8]<-c("T1","T2","T3","T4","T5")
    ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 1000,nBMM2 = 1000,Prc = 2)
 
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Object Exploration", "E","Number of Fields"))
 
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "E","Number of Fields"),ylmP =c(0,3),hLin = F,lvIp = 6,wMain = T)
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    # Results
    <<ResCtrl4>>
```

## Fig S1F Field size {Design 2x2x(5xS)}
```{r S1F, }
  NmBas="FigS1F FieldSize"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA

  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(1,5,6,36:40),vIntP =c(4:8),lvlCh = list("HAB"="SmFields_s1", "T1"="SmFields_s2","T2"="SmFields_s3","T3"="SmFields_s4","Test"="SmFields_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Simple Effects:
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(5:6,(6+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  # Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "",bquote('Field Size (cm'~(cm^2))),ylmP =c(0,600),hLin = F,lvIp=5)
  Grp2=Grp
    
    #AOV
    #A=2;B=2;C=5;DatPas=rrt;DatEfSp=DatEfS;nBMM1=nBMM2=1000;Prc=2
    names(rrt$DT)[4:8]<-c("T1","T2","T3","T4","T5")
    ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 1000,nBMM2 = 1000,Prc = 2)
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Object Exploration", "F",bquote('Field Size (cm'~(cm^2))))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "F",bquote('Field Size (cm'~(cm^2))),ylmP =c(0,600),hLin = F,lvIp = 6,wMain = T)
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    # Results
    <<ResCtrl4>>
```

## Fig S1G Spatial information content {Design 2x2x(5xS)}
```{r S1G, }
  NmBas="FigS1G SpatialInfCont"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA

  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(1,5,6,27:31),vIntP =c(4:8),lvlCh =  list("HAB"="InfoC_s1", "T1"="InfoC_s2","T2"="InfoC_s3","T3"="InfoC_s4","Test"="InfoC_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Simple Effects
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"Parameters.csv"),Vars = c(5:6,(6+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  # Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Object Exploration", "","Spatial Information (bits/s)"),ylmP =c(0,3),hLin = F,lvIp=5)
  Grp2=Grp
    
    #AOV
    #A=2;B=2;C=5;DatPas=rrt;DatEfSp=DatEfS;nBMM1=nBMM2=1000;Prc=2
    names(rrt$DT)[4:8]<-c("T1","T2","T3","T4","T5")
    ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 1000,nBMM2 = 1000,Prc = 2)
 
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Object Exploration", "G","Spatial Information (bits/s)"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Object Exploration", "G","Spatial Information (bits/s)"),
                 ylmP =c(0,3),hLin = F,lvIp = 6,wMain = T)
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    # Results
    <<ResCtrl4>>
```    
   
## Fig S1H Cluster Quality L-ratio  {Design 2x2x(5xS)}   
```{r FS1H,}
  NmBas="FigS1H LRatio"
  NmFAlL<-paste0(PathDesign,NmBas)
    if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
    NmFAlL<-paste0(NmFAlL,"/")

  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"ClusterQuality.csv"),Vars = c(1,5,6,12:16),vIntP =c(4:8),lvlCh = list("HAB"="LR_s1", "T1"="LR_s2","T2"="LR_s3","T3"="LR_s4","Test"="LR_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  # Simple Effects
  DatEfS<-list()
  for(is in 1:5) {
    DatEfS[[is]]<-ExData.2(nmF = paste0(PathDesign,"ClusterQuality.csv"),Vars = c(5:6,(11+is)))
    names(DatEfS[[is]]$DT)[3]<-"DepV"
  }
  
  #Graphs
  Grp<- Grph.3(DatP = ExtendDT,"OPR",LblsP =c("Cluster Quality", "","L-Ratio"),ylmP =c(0,10),hLin = F,lvIp=5)
  Grp2=Grp
    
    #AOV
    names(rrt$DT)[4:8]<-c("T1","T2","T3","T4","T5")
    ResGen<-AOVMx2.5(A=2,B=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 1000,nBMM2 = 1000,Prc = 2)
    AlmacenGen2(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=2)
  
  # Other Graphs
    GrpO<-Grph.3.Otros(ExtendDT,LblsP =c("Cluster Quality", "I","L-Ratio"))
    
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<-Grph.3(DatP = ExtendDTCol,"OPR",LblsP =c("Cluster Quality", "I","L-Ratio"),
                 ylmP =c(0,10),hLin = F,lvIp = 6,wMain = T)
   
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()
    
    <<ResCtrl4>>
```   
   
## Fig S1I Unmoved L-Ratio {Design 2x(5xS)}   
```{r S1I, }
  NmBas="FigS1I UnMovedLRatio"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResGen<-NA
    
  rrt<-ExDataIS.3c(nmF = paste0(PathDesign,"ClusterQualityNonMovedControl.csv"),Vars = ,c(4,5,1,11:15),vIntP =c(4:8),lvlCh = list("HAB"="LR_s1", "T1"="LR_s2","T2"="LR_s3","T3"="LR_s4","Test"="LR_s5"))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  ExtendDT<-rrt$ExtendDT
  
  #Graphs
  Grp<- Grph.3b(DatP = ExtendDT,"OPR",LblsP =c("Cluster Quality", "","L-Ratio"),ylmP =c(0,10),hLin = F,lvIp = 5,GrpSel = c(1,3))

  Grp2=Grp
  
  #AOV
  names(rrt$DT)[3:7]<-c("T1","T2","T3","T4","T5")
  ResGen<-AOVMx2b(A=2,C=5,DatPas = rrt,DatEfSp = DatEfS,nBMM1 = 10000,nBMM2 = 1000,Prc = 2)
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
   # Other Graphs
    ExtendDTCol<-copy(ExtendDT)
    ExtendDTCol$Moment<-"All"
    ExtendDTCol<-data.table(rbind(ExtendDT,ExtendDTCol))
    
    Grp3<- Grph.3b(DatP = ExtendDTCol,"OPR",LblsP =c("Cluster Quality", "","L-Ratio"),ylmP =c(0,10),hLin = F,lvIp = 6,GrpSel = c(1,3),wMain = T)
    
    ExtendCpy<-copy(ExtendDT)
    names(ExtendCpy)[1]<-"Age"
    GrpO<-Grph.3.Otrosb(ExtendDTp = ExtendCpy,LblsP =c("Cluster Quality", "","L-Ratio"))
    
    pdf(paste0(NmFAlL,NmBas,"OtrosGraphs.pdf"))
      Grp3
      GrpO
    dev.off()

    <<ResCtrl2>>
```   
   
   
# **Supplemental Figure 2. Detection of remapping threshold.**   

***   

> **Supplemental Figure 2.** Detection of remapping threshold. A-B) Scatter plots showing correlations between Hab/T1 and T1/T2 in young (A) and old (B) animals. Blue ellipse contains correlation values that display high stability on both Hab/T1 and T1/T2, green ellipse contains correlation values that display low stability in Hab/T1 but high stability in T1/T2, red ellipse contains correlation values that display low stability in both Hab/T1 and T1/T2 comparisons. C) Histogram showing cell counts for all correlations. Low stability cells are shown in red, whereas high stability cells are shown in blue. Note that the distributions are not normal, which justified the selection of robust statistics for all the analyses. The threshold of 0.35 best separated stable and unstable correlations. D-E) Results of a machine learning algorithm, MATLAB as kmeans, used to approximate the threshold to determine stability. The algorithm was instructed to group the data into 3 categories using correlation values from young (D) and old (E) mice. Means for each category are indicated by black squares. In both graphs the best approximation coincided with a threshold value of 0.35.  These data demonstrate that using scatter plots, histogram distributions, and machine learning algorithms, the threshold of 0.35 is the best value to categorize cell types.   

***   
   

# **Supplemental Figure 3. Bayes classifier validation.**   

***   

> **Supplemental Figure 3.** Bayes classifier validation. A) Photograph of the SD chamber. B) Representative 5 hr sleep recording showing electroencephalogram (EEG, top panel) and electromyograph (EMG, bottom panel) color-coded using the output of a Bayes classifier. The color-coded EEG and EMG trace illustrates the accuracy of the classifier detecting Wake, NREM and REM periods. C-D) Average normalized confusion matrices for young (C) and old (D) mice. To determine the accuracy, sensitivity and specificity of the classifier, a confusion matrix was created by comparing visual and algorithm scored data in 4 young and 4 old mice. The results of this comparison were summed into the matrix for each animal. Each entry was then divided by the total number of epochs and multiplied by 100 to turn the values into percentages. Average confusion matrices were computed for young (C) and old (D) mice. E) Accuracy of the Bayes classifier for young and old mice. F) Receiver operating characteristic (ROC) curve showing average values of sensitivity (true positive rates) against false positive rates (1-specificity) for Wake, NREM, and REM in young and old mice.  The high accuracy of the classifier is illustrated by the fact that all values are plotted in the upper left area, indicating high sensitivity and low fallout errors.   

***   

E) Accuracy of the Bayes classifier for young and old mice
F) Receiver operating characteristic (ROC) curve   

```{r S3EF, fig.keep='all'}
  NmBas="FigS3E_F BayesClassifier"
  NmFich<-paste0(PathDesign,"SensAnalysisAll.csv");
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  ResROC<-list()
  
  DatDTFull <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  DatDTFull$Label_P<-factor(DatDTFull$Label_P)
  DatDTFull$Label_P<-relevel(DatDTFull$Label_P,"Wake")
  DatDTFull$Label_T<-factor(DatDTFull$Label_T)
  DatDTFull$Label_T<-relevel(DatDTFull$Label_T,"Wake")
  DatDTFull$Group<-factor(DatDTFull$Group)
  DatDTFull$Group<-relevel(DatDTFull$Group,"Young")
  
  SelGrp<-DatDTFull[Group=="Old"&Subject!="TT"]
  SelGrp$Subject<-factor(SelGrp$Subject)
  out1<-lapply(1:4, function(i) {
    SelSbj<-SelGrp[Subject==levels(SelGrp$Subject)[i]]
    xtb<-xtabs(DepVar~Label_P+Label_T,data=SelSbj)
    round(confusionMatrix(xtb, mode="everything")$overall[c(1,2,7)],4)
  })
  out2<-lapply(1:4, function(i) {
    SelSbj<-SelGrp[Subject==levels(SelGrp$Subject)[i]]
    xtb<-xtabs(DepVar~Label_P+Label_T,data=SelSbj)
    round(confusionMatrix(xtb, mode="everything")$byClass,4)
  })
  Rest2<-data.frame("Group"="Old","Subject"=levels(SelGrp$Subject),do.call(rbind,out1))
  ResIntr<-data.frame(matrix(do.call(rbind,out2),nrow=12,byrow=F))
  names(ResIntr)<-labels(out2[[1]])[[2]]
  Rest2.2<-data.frame("Group"="Old","Band"=rep(levels(SelGrp$Label_T),4),"Subject"=rep(levels(SelGrp$Subject),each=3),ResIntr)
  
  SelGrp<-DatDTFull[Group=="Young"&Subject!="TT"]
  SelGrp$Subject<-factor(SelGrp$Subject)
  out1<-lapply(1:4, function(i) {
    SelSbj<-SelGrp[Subject==levels(SelGrp$Subject)[i]]
    xtb<-xtabs(DepVar~Label_P+Label_T,data=SelSbj)
    round(confusionMatrix(xtb, mode="everything")$overall[c(1,2,7)],4)
  })
  out2<-lapply(1:4, function(i) {
    SelSbj<-SelGrp[Subject==levels(SelGrp$Subject)[i]]
    xtb<-xtabs(DepVar~Label_P+Label_T,data=SelSbj)
    round(confusionMatrix(xtb, mode="everything")$byClass,4)
  })
  Rest2b<-data.frame("Group"="Young","Subject"=levels(SelGrp$Subject),do.call(rbind,out1))
  ResIntr<-data.frame(matrix(do.call(rbind,out2),nrow=12,byrow=F))
  names(ResIntr)<-labels(out2[[1]])[[2]]
  Rest2.2b<-data.frame("Group"="Young","Band"=rep(levels(SelGrp$Label_T),4),"Subject"=rep(levels(SelGrp$Subject),each=3),ResIntr)
  
  Rest2f<-  rbind(Rest2b,Rest2)
  Rest2f.2<-  rbind(Rest2.2b,Rest2.2)

  Rest2f$Group<-factor(Rest2f$Group); Rest2f$Group<-relevel(Rest2f$Grou,"Young")
  Rest2f.2$Group<-factor(Rest2f.2$Group); Rest2f.2$Group<-relevel(Rest2f.2$Group,"Young")
  Rest2f.2$Band<- factor(Rest2f.2$Band);  Rest2f.2$Band<- relevel(Rest2f.2$Band,"Wake")
  
  write.csv2(Rest2f,paste0(NmFAlL,NmBas,"ResultSensib1_Acc.csv"))
  write.csv2(Rest2f.2,paste0(NmFAlL,NmBas,"ResultSensib2_ROC.csv"))
  
# Accuracy Graph
  Grp2<-ggplot(Rest2f, aes(x = factor(Group), y = Accuracy)) +
  geom_boxplot(position=position_dodge(0.8),lwd=1)+
  geom_dotplot(binaxis='y', stackdir='center', 
              binpositions="all",dotsize = 1.5) +
     stat_summary(fun.y=mean, geom="point", shape=18,
                 size=10, color="red") + theme_classic2()  +ylim(0.85,1) + labs(x="") +
    theme(legend.position="None", text = element_text(size=28),
    axis.title.x = element_text(color = "black",family="ArialMT",size=28,face="bold"),
    axis.title.y = element_text(color = "black",family="ArialMT",size=28,face="bold"),
    axis.text.x = element_text(color = "black",family="ArialMT",size=20,face="bold"),
    axis.text.y = element_text(color = "black",family="ArialMT",size=20,face="bold")) +
    labs(x="")
  
  pdf(paste0(NmFAlL,NmBas,"_Accuracy.pdf"),family = "ArialMT")
    plot(Grp2)
  dev.off() 
  
# ROC with all data points
  g2<-ggplot(Rest2f.2, aes(x = 1-Specificity, y = Sensitivity,colour=Band,shape=Group))
Grp3<-g2+ geom_point(size=4)  + xlim(0,1) +  ylim(0,1) + geom_abline(intercept = 0,lty=3) +
  theme_linedraw() + theme(legend.position="bottom", text = element_text(size=28),legend.title=element_text(size=12), 
    legend.text=element_text(size=12))

  pdf(paste0(NmFAlL,NmBas,"_SensSpec.pdf"),family = "ArialMT")
    plot(Grp3)
  dev.off() 

# ROC with means
SelGrp<-DatDTFull[Subject=="TT"]
  SelGrp$Subject<-factor(SelGrp$Subject)
   SelGrp$Group<-factor(SelGrp$Group)
out1<-lapply(1:2, function(i) {
    SelSbj<-SelGrp[Group==levels(SelGrp$Group)[i]]
    xtb<-xtabs(DepVar~Label_P+Label_T,data=SelSbj)
    round(confusionMatrix(xtb, mode="everything")$byClass,4)
  })
Restc<-matrix(do.call(rbind,out1),nrow=6,byrow=F)
Rest2c<-data.frame(cbind(rep(levels(SelGrp$Label_T),2),rep(levels(SelGrp$Group),each=3)),Restc)
names(Rest2c)<-c("Band","Group",labels(out1[[1]])[[2]])
Rest2c$Band<-factor(Rest2c$Band)
Rest2c$Band<-relevel(Rest2c$Band,"Wake")
Rest2c$Group<-factor(Rest2c$Group)
Rest2c$Group<-relevel(Rest2c$Group,"Young")

write.csv2(Rest2c,paste0(NmFAlL,NmBas,"ResultSensib3_ROCMeans.csv"))

DTRes<-data.table(Rest2f.2)
   df2<-DTRes[,.(DepVar=Mean_MM(Sensitivity),sem=SEM_MM(Sensitivity)),by=c("Group", "Band")]
   df3<-DTRes[,.(DepVar=Mean_MM(1-Specificity),sem=SEM_MM(1-Specificity)),by=c("Group", "Band")]


ColorEj<-rep(c("brown4","darkgreen","blue4"),2)
g2<-ggplot(Rest2c, aes(x = 1-Specificity, y = Sensitivity,colour=Band,shape=Group))
Grp4<-g2+ geom_point(size=3.5)  + xlim(0,1) +  ylim(0,1) + geom_abline(intercept = 0,lty=3) +
  theme_linedraw() + 
  theme(legend.position="bottom", text = element_text(size=20),legend.title=element_text(size=12), 
    legend.text=element_text(size=12),axis.line = element_line(colour = "black", 
                      size = 1, linetype = "solid"),
           panel.grid = element_line(color = "gray46"),
    plot.margin=unit(c(1.2,1.2,1.2,1.2),"cm"),
    axis.title.x = element_text(color = "black",family="ArialMT",size=28,face="bold"),
    axis.title.y = element_text(color = "black",family="ArialMT",size=28,face="bold"),
    axis.text.x = element_text(color = "black",family="ArialMT",size=20,face="bold"),
    axis.text.y = element_text(color = "black",family="ArialMT",size=20,face="bold")) +
  geom_errorbarh(aes(xmin=1-Rest2c$Specificity-df3$sem, xmax=1-Rest2c$Specificity+df3$sem),
                 size=0.2,color=ColorEj) +
  geom_errorbar(aes(ymin=Rest2c$Sensitivity-df2$sem, ymax=Rest2c$Sensitivity+df2$sem),
                 size=0.2,color=ColorEj) + 
  geom_hline(yintercept=1, size = 1, linetype = "solid") +
  geom_vline(xintercept=1, size = 1, linetype = "solid") +
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA))

 
  pdf(paste0(NmFAlL,NmBas,"_AllSens.pdf"),family = "ArialMT")
    plot(Grp4)
  dev.off()
  
  # Results
  ResROC$Acc<-Rest2f
  ResROC$ROCAll<-Rest2f.2
  ResROC$ROCMeans<-Rest2c
  
  ResROC$Acc
  ResROC$ROCAll
  ResROC$ROCMeans  
  Kbl3(ResPas = ResROC[[1]], lbl = "Accuracy Analysis")
  Kbl3(ResPas = ResROC[[2]], lbl = "ROC Analysis All Data")
  Kbl3(ResPas = ResROC[[3]], lbl = "ROC Analysis Means")
  
  # Accuracy Graph
    plot(Grp2)
  # ROC with all data points
    plot(Grp3)
  # ROC with means
    plot(Grp4)
```   
   

# **Supplemental Figure 4. Power spectra during NREM and REM.**    

***   

> **Supplemental Figure 4.** Power spectra during NREM and REM during post-learning and recovery and relative sigma (RSP) and beta (RBP) power. A-F) NREM and REM average (red) and individual (gray) power spectra during post-learning (A-B) and recovery (C-F) for all age groups and sleep conditions. G-J) RSP and RBP did not show differences during post-learning (G-H) or recovery (I-J). Statistical details in Supplemental Statistical Table corresponding to Supplemental Figure 4.   
   
***   
   
## Fig S4G,H Band Power PostL {Design 2}   
```{r S4GH, fig.keep='all'}
  NmBas="FigS4G_H Band Power PostL"
  NmFich="BandPowerPostL.csv";
  NmFich<-paste0(PathDesign,NmFich);
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
  DatDTFull <- data.table(read.table(NmFich, header=TRUE, sep=";", na.strings="NA", dec=",",strip.white=TRUE))
  DatDT<-DatDTFull
  DatDT$Group<-factor(DatDT$Group);DatDT$Group<-relevel(DatDT$Group,"Young_C")
  ResFn<-ResAOV1<-list()
  i=1
  for (i in 1:5) {
    DepVar<-names(DatDTFull)[8+i]
    YuenRes<-WRS2::yuen(get(DepVar)~Group,DatDT)
    ResFnPrv<-data.table(with(YuenRes,
                              cbind(DepV=DepVar,diff=round(diff,2),df=round(df,2),test=round(test,2),
                                    EffSize=round(effsize,2),p=round(p.value,4))))
    ResFn<-rbind(ResFn,ResFnPrv)
    lvs<-c(4,7,8+i)
    DatDTG<-DatDTFull[,..lvs];
    DatDTG$Age<-factor(DatDTG$Age)
    DatDTG$Age<-relevel(DatDTG$Age,"Young")
    setkey(DatDTG,Age)

    ArPGlobal<-c(lapply(1:2, function (x) DatDTG[.(levels(DatDTG$Age)[x]),3,with=F][[1]]),recursive = F)
    ResAOV1[[i]]<-AOVSingle(ArPGlobal,2)
  }
  rbResRb22<-data.table(Vars=names(DatDTFull)[9:13],do.call(rbind, lapply(ResAOV1, as.data.table)))
  
  GrpF<-list()
  DepVar1<-names(DatDTFull)[8+1]
  GrpF$A<- Grph.1(DatDT,DepVar1,LblsP =c("Preference for Displaced Object", "","Relative Delta Power"),c(0,50),F,GrpSel=c(1,3))
  DepVar2<-names(DatDTFull)[8+2]
  GrpF$B<- Grph.1(DatDT,DepVar2,LblsP =c("Preference for Displaced Object", "","Relative Sigma Power"),c(0,50),F,GrpSel=c(1,3))
  DepVar3<-names(DatDTFull)[8+3]
  GrpF$C<- Grph.1(DatDT,DepVar3,LblsP =c("Preference for Displaced Object", "","Relative Theta Power"),c(0,100),F,GrpSel=c(1,3))
  DepVar4<-names(DatDTFull)[8+4]
  GrpF$D<- Grph.1(DatDT,DepVar4,LblsP =c("Preference for Displaced Object", "","Relative Beta Power"),c(0,50),F,GrpSel=c(1,3))
  DepVar5<-names(DatDTFull)[8+5]
  GrpF$E<- Grph.1(DatDT,DepVar5,LblsP =c("Preference for Displaced Object", "",DepVar5),c(300,320),F,GrpSel=c(1,3))
  
  ResRes<-list()
  #ResRes[[1]]<-ResFn
  ResRes[[1]]<-rbResRb22
  AlmacenGen3(GrpP = GrpF,DataPas = ResRes,PathDesignP = PathDesign,NmBasP = NmBas, Typ=1)
  
  NmBas2="FigS4G RelSigmaPower PostL"
  pdf(paste0(NmFAlL,NmBas2,".pdf"))
     GrpF$B
  dev.off()
  NmBas3="FigS4H RelBetaaPower PostL"
  pdf(paste0(NmFAlL,NmBas3,".pdf"))
     GrpF$D
  dev.off()
    
  pdf(paste0(NmFAlL,NmBas,"TodosGraphs.pdf"))
     GrpF
  dev.off()
  
  # All
  rrt<-ExDataIS.3c(nmF = paste0(PathDesign,"BandPowerPostL.csv"),Vars = c(4,5,7,9:12),vIntP =c(4:7),lvlCh = list("Delta"="delta_NREM", "Sigma"="sigma_NREM","Theta"="theta_REM","Beta"="beta_REM"))
  
  GrpF2<-list()
  GrpF2<-Grph.3b(rrt$ExtendDT,"Moment",LblsP =c("Preference for Unmoved Objects", "","Relative Power"),c(0,100),GrpSel = c(1,3),F)
  
  pdf(paste0(NmFAlL,NmBas,"TodosGraphs.pdf"))
     GrpF2
    dev.off()
    
    #Results
    print("FigS4G RelSigmaPower PostL")
    plot(GrpF$B)
    print("FigS4H RelBetaaPower PostL")
    plot(GrpF$D)
    ResRes
    
    Kbl3(ResRes, "Omnibus AOV. Design 2")
```   
   
## Fig S4I,J Band Power Recover {Design 2*2}   
```{r S4IJ, }
  
  NmBas="FigS4I RelSigmaPowerNREM Recover"
  rrt<-ExData.2(nmF = paste0(PathDesign,"BandPowerRecover.csv"),Vars = c(4:5,10))
  DatDT<-rrt$DT
  ArP<-rrt$Arp
  
  #Graphs
  Grp<- Grph.2(DatDT,"sigma_NREM",LblsP =c("Preference for Unmoved Objects", "","Relative Sigma Power"),c(0,30),F)
  Grp2<- Grp 
  # AOV & Simple Effects
  ResGen<-NA
  names(rrt$DT)[3]<-"DepV"
  ResGen<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
  AlmacenGen(GrpP = Grp,Grp2P = Grp2,DataPas = ResGen,PathDesignP = PathDesign,NmBasP = NmBas,Typ=1)
  
  #Results FigS4I RelSigmaPowerNREM Recover
    <<ResCtrl1>>
  
NmBas="FigS4J RelBetaPowerREM Recover"
  rrt<-ExData.2(nmF = paste0(PathDesign,"BandPowerRecover.csv"),Vars = c(4:5,11))
  DatDT<-rrt$DT
  ArP<-rrt$Arp  
  
  #Graphs
  Grp<- Grph.2(DatDT,"theta_REM",LblsP =c("Preference for Unmoved Objects", "","Relative Theta Power"),c(0,100),F)
  Grp2=Grp
  
  # AOV & Simple Effects
  ResGen<-NA
  names(rrt$DT)[3]<-"DepV"
  ResGen<-AOVBwF(2,2,DatPas = rrt,nBMM = 10000)
  AlmacenGen(Grp,Grp2,ResGen,PathDesign,NmBas,Typ=1)
  
  #Results FigS4J RelBetaPowerREM Recove
    <<ResCtrl1>>
  
# All
  rrt<-ExDataIS.2(nmF = paste0(PathDesign,"BandPowerRecover.csv"),Vars = c(4,5,7,9:12),vIntP =c(4:7),
                  lvlCh = list("Delta"="delta_NREM", "Sigma"="sigma_NREM","Theta"="theta_REM","Beta"="beta_REM"))
  GrpF<-Grph.3(rrt$ExtendDT,"Moment",LblsP =c("Preference for Unmoved Objects", "","Relative Power"),c(0,100),F)
  NmBas="FigBP_Band Power Recover All Bands"
  NmFAlL<-paste0(PathDesign,NmBas)
  if (!dir.exists(NmFAlL)) {dir.create(NmFAlL)}
  NmFAlL<-paste0(NmFAlL,"/")
    
  pdf(paste0(NmFAlL,NmBas,"TodosGraphs.pdf"))
     GrpF
  dev.off()
```
   
***   
   